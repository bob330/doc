<!doctype html><html class=theme-light lang=zh-tw><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/><title>章 3. Secure Programming | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="章 3. Secure Programming"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="zh-tw"><meta property="og:url" content="http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/zh-tw\/books\/developers-handbook\/secure\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/zh-tw>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books>Books</a></li><li><a href=http://172.16.201.134:1313/zh-tw/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/zh-tw/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=zh-tw>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><input type=checkbox class="hidden toggle" id=menu-control><main class=main-wrapper-book><a id=top></a><aside class=book-menu><div class=book-menu-content><input id=search-book type=text placeholder=Search aria-label=Search maxlength=128><nav id=MenuContents><ul><li><input type=checkbox id=chapter-b1b18a35567534d1699b4dd27b58b2ff class=toggle>
<label for=chapter-b1b18a35567534d1699b4dd27b58b2ff><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/parti/>Part I. Grundlagen</a></li><li><input type=checkbox id=chapter-3af9d0cd3607fbe44d37e3a13957c40f class=toggle>
<label class="icon cursor" for=chapter-3af9d0cd3607fbe44d37e3a13957c40f><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/introduction/>章 1. 簡介</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/introduction/#introduction-devel>1.1. 在 FreeBSD 開發程式</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/introduction/#introduction-bsdvision>1.2. The BSD Vision</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/introduction/#introduction-archguide>1.3. 程式架構指南</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/introduction/#introduction-layout>1.4. <span class=filename>/usr/src</span> 的架構</a></li></ul></li><li><input type=checkbox id=chapter-15219234c513f9a79d9cb2d3bcf73d13 class=toggle>
<label class="icon cursor" for=chapter-15219234c513f9a79d9cb2d3bcf73d13><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/>章 2. 程式開發工具</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-synopsis>2.1. 概敘</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-intro>2.2. 簡介</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-programming>2.3. Programming 概念</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-compiling>2.4. 用 <code>cc</code> 來編譯程式</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-make>2.5. Make</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#debugging>2.6. Debugging</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#emacs>2.7. Using Emacs as a Development Environment</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools/#tools-reading>2.8. Further Reading</a></li></ul></li><li><input type=checkbox id=chapter-7319f5d899d5be33daaf1f2d5f180558 class=toggle checked>
<label class="icon cursor" for=chapter-7319f5d899d5be33daaf1f2d5f180558><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/>章 3. Secure Programming</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-synopsis>3.1. Synopsis</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-philosophy>3.2. Secure Design Methodology</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-bufferov>3.3. Buffer Overflows</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-setuid>3.4. SetUID issues</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-chroot>3.5. Limiting your program’s environment</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-trust>3.6. Trust</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/secure/#secure-race-conditions>3.7. Race Conditions</a></li></ul></li><li><input type=checkbox id=chapter-0240ccaf7010beed911378cfab7bd8fc class=toggle>
<label class="icon cursor" for=chapter-0240ccaf7010beed911378cfab7bd8fc><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/l10n/>章 4. Localization and Internationalization - L10N and I18N</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/l10n/#l10n-programming>4.1. Programming I18N Compliant Applications</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/l10n/#posix-nls>4.2. Localized Messages with POSIX.1 Native Language Support (NLS)</a></li></ul></li><li><input type=checkbox id=chapter-c3107aaf64e60e1ee09bc33fc9fd641a class=toggle>
<label class="icon cursor" for=chapter-c3107aaf64e60e1ee09bc33fc9fd641a><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/>章 5. Source Tree Guidelines and Policies</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/#policies-style>5.1. Style Guidelines</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/#policies-maintainer>5.2. <code>MAINTAINER</code> on Makefiles</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/#policies-contributed>5.3. Contributed Software</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/#policies-encumbered>5.4. Encumbered Files</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/policies/#policies-shlib>5.5. Shared Libraries</a></li></ul></li><li><input type=checkbox id=chapter-c7b4fd5a7f8f049234fe3bc225acef44 class=toggle>
<label class="icon cursor" for=chapter-c7b4fd5a7f8f049234fe3bc225acef44><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/>章 6. Regression and Performance Testing</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/#testing-micro-benchmark>6.1. Micro Benchmark Checklist</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/#testing-tinderbox>6.2. The FreeBSD Source Tinderbox</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/#_the_index_cgi_script>6.3. The <span class=filename>index.cgi</span> Script</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/#_official_build_servers>6.4. Official Build Servers</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/testing/#_official_summary_site>6.5. Official Summary Site</a></li></ul></li><li><input type=checkbox id=chapter-1f9b02a65f2bc5d4015a050d706fa837 class=toggle>
<label for=chapter-1f9b02a65f2bc5d4015a050d706fa837><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/partii/>Part II. Interprozess-Kommunikation</a></li><li><input type=checkbox id=chapter-5e03777f678dd5731a581d7956d19c13 class=toggle>
<label class="icon cursor" for=chapter-5e03777f678dd5731a581d7956d19c13><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/>章 7. Sockets</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-synopsis>7.1. Synopsis</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-diversity>7.2. Networking and Diversity</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-protocols>7.3. Protocols</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-model>7.4. The Sockets Model</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-essential-functions>7.5. Essential Socket Functions</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-helper-functions>7.6. Helper Functions</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/sockets/#sockets-concurrent-servers>7.7. Concurrent Servers</a></li></ul></li><li><input type=checkbox id=chapter-5cbeeaa29a95a5f152e5ccc3901d0fd3 class=toggle>
<label class="icon cursor" for=chapter-5cbeeaa29a95a5f152e5ccc3901d0fd3><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/ipv6/>章 8. IPv6 Internals</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/ipv6/#ipv6-implementation>8.1. IPv6/IPsec Implementation</a></li></ul></li><li><input type=checkbox id=chapter-c9a07b517dc2e43d169c8e013e23cfc1 class=toggle>
<label for=chapter-c9a07b517dc2e43d169c8e013e23cfc1><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/partiii/>Part III. Kernel</a></li><li><input type=checkbox id=chapter-db22f8e5e5e9496dbc711815e2e05f36 class=toggle>
<label class="icon cursor" for=chapter-db22f8e5e5e9496dbc711815e2e05f36><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kernelbuild/>章 9. Building and Installing a FreeBSD Kernel</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kernelbuild/#kernelbuild-traditional>9.1. Building the Faster but Brittle Way</a></li></ul></li><li><input type=checkbox id=chapter-3036877c53948cfb76174f2776bbdf64 class=toggle>
<label class="icon cursor" for=chapter-3036877c53948cfb76174f2776bbdf64><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/>章 10. Kernel Debugging</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-obtain>10.1. Obtaining a Kernel Crash Dump</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-gdb>10.2. Debugging a Kernel Crash Dump with <code>kgdb</code></a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-online-ddb>10.3. On-Line Kernel Debugging Using DDB</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-online-gdb>10.4. On-Line Kernel Debugging Using Remote GDB</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-console>10.5. Debugging a Console Driver</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-deadlocks>10.6. Debugging Deadlocks</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-dcons>10.7. Kernel debugging with Dcons</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/kerneldebug/#kerneldebug-options>10.8. Glossary of Kernel Options for Debugging</a></li></ul></li><li><input type=checkbox id=chapter-86707094ce48d6e89e5f45569c084cea class=toggle>
<label for=chapter-86707094ce48d6e89e5f45569c084cea><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/partiv/>Part IV. Architekturen</a></li><li><input type=checkbox id=chapter-43b1e1e6d2a94eb8b161876bc22ce644 class=toggle>
<label class="icon cursor" for=chapter-43b1e1e6d2a94eb8b161876bc22ce644><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/>章 11. x86 Assembly Language Programming</a><ul><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-intro>11.1. Synopsis</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-the-tools>11.2. The Tools</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-system-calls>11.3. System Calls</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-return-values>11.4. Return Values</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-portable-code>11.5. Creating Portable Code</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-first-program>11.6. Our First Program</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-unix-filters>11.7. Writing UNIX® Filters</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-buffered-io>11.8. Buffered Input and Output</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-command-line>11.9. Command Line Arguments</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-environment>11.10. UNIX® Environment</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-files>11.11. Working with Files</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-one-pointed-mind>11.12. One-Pointed Mind</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-fpu>11.13. Using the FPU</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-caveats>11.14. Caveats</a></li><li><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/x86/#x86-acknowledgements>11.15. Acknowledgements</a></li></ul></li><li><input type=checkbox id=chapter-c49dfe630861d471fb2f58f5b554ed84 class=toggle>
<label for=chapter-c49dfe630861d471fb2f58f5b554ed84><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/partv/>Part V. Appendices</a></li><li><input type=checkbox id=chapter-ac9541a3f38001d13964c1b0b324bb83 class=toggle>
<label for=chapter-ac9541a3f38001d13964c1b0b324bb83><a role=button></a></label><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/bibliography/>附錄</a></li><li></li></ul></nav></div></aside><div class=book><div class=book-menu-mobile><label for=menu-control><span class=menu-control-button><i class="fa fa-list" aria-hidden=true title="Book menu"></i>
Book menu</span></label></div><h1 class=title>章 3. Secure Programming</h1><div class="admonitionblock note"><p><i class="fa fa-exclamation-circle" aria-hidden=true></i>
This translation may be out of date. To help with the translations please access the <a href=https://translate-dev.freebsd.org/ target=_blank>FreeBSD translations instance</a>.</p></div><div class=toc-mobile><h3>目錄</h3><nav id=TableOfContents><ul><li><a href=#secure-synopsis>3.1. Synopsis</a></li><li><a href=#secure-philosophy>3.2. Secure Design Methodology</a></li><li><a href=#secure-bufferov>3.3. Buffer Overflows</a></li><li><a href=#secure-setuid>3.4. SetUID issues</a></li><li><a href=#secure-chroot>3.5. Limiting your program’s environment</a></li><li><a href=#secure-trust>3.6. Trust</a></li><li><a href=#secure-race-conditions>3.7. Race Conditions</a></li></ul></nav></div><div class=book-content><div id=preamble><div class=sectionbody></div></div><div class=sect1><h2 id=secure-synopsis>3.1. Synopsis<a class=anchor href=#secure-synopsis></a></h2><div class=sectionbody><div class=paragraph><p>This chapter describes some of the security issues that have plagued UNIX® programmers for decades and some of the new tools available to help programmers avoid writing exploitable code.</p></div></div></div><div class=sect1><h2 id=secure-philosophy>3.2. Secure Design Methodology<a class=anchor href=#secure-philosophy></a></h2><div class=sectionbody><div class=paragraph><p>Writing secure applications takes a very scrutinous and pessimistic outlook on life. Applications should be run with the principle of "least privilege" so that no process is ever running with more than the bare minimum access that it needs to accomplish its function. Previously tested code should be reused whenever possible to avoid common mistakes that others may have already fixed.</p></div><div class=paragraph><p>One of the pitfalls of the UNIX® environment is how easy it is to make assumptions about the sanity of the environment. Applications should never trust user input (in all its forms), system resources, inter-process communication, or the timing of events. UNIX® processes do not execute synchronously so logical operations are rarely atomic.</p></div></div></div><div class=sect1><h2 id=secure-bufferov>3.3. Buffer Overflows<a class=anchor href=#secure-bufferov></a></h2><div class=sectionbody><div class=paragraph><p>Buffer Overflows have been around since the very beginnings of the von Neumann <a href=../bibliography/#COD>1</a> architecture. They first gained widespread notoriety in 1988 with the Morris Internet worm. Unfortunately, the same basic attack remains effective today. By far the most common type of buffer overflow attack is based on corrupting the stack.</p></div><div class=paragraph><p>Most modern computer systems use a stack to pass arguments to procedures and to store local variables. A stack is a last in first out (LIFO) buffer in the high memory area of a process image. When a program invokes a function a new "stack frame" is created. This stack frame consists of the arguments passed to the function as well as a dynamic amount of local variable space. The "stack pointer" is a register that holds the current location of the top of the stack. Since this value is constantly changing as new values are pushed onto the top of the stack, many implementations also provide a "frame pointer" that is located near the beginning of a stack frame so that local variables can more easily be addressed relative to this value. <a href=../bibliography/#COD>1</a> The return address for function calls is also stored on the stack, and this is the cause of stack-overflow exploits since overflowing a local variable in a function can overwrite the return address of that function, potentially allowing a malicious user to execute any code he or she wants.</p></div><div class=paragraph><p>Although stack-based attacks are by far the most common, it would also be possible to overrun the stack with a heap-based (malloc/free) attack.</p></div><div class=paragraph><p>The C programming language does not perform automatic bounds checking on arrays or pointers as many other languages do. In addition, the standard C library is filled with a handful of very dangerous functions.</p></div><table class="tableblock frame-none grid-all stretch informaltable"><col style=width:50%><col style=width:50%><tbody><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>strcpy</code>(char *dest, const char *src)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the dest buffer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>strcat</code>(char *dest, const char *src)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the dest buffer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>getwd</code>(char *buf)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the buf buffer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>gets</code>(char *s)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the s buffer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>[vf]scanf</code>(const char *format, …​)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow its arguments.</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>realpath</code>(char *path, char resolved_path[])</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the path buffer</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock><code>[v]sprintf</code>(char *str, const char *format, …​)</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>May overflow the str buffer.</p></td></tr></tbody></table><div class=sect2><h3 id=_example_buffer_overflow>3.3.1. Example Buffer Overflow<a class=anchor href=#_example_buffer_overflow></a></h3><div class=paragraph><p>The following example code contains a buffer overflow designed to overwrite the return address and skip the instruction immediately following the function call. (Inspired by <a href=../bibliography/#Phrack>4</a>)</p></div><div class="literalblock programlisting"><div class=content><pre>#include &lt;stdio.h&gt;

void manipulate(char *buffer) {
  char newbuffer[80];
  strcpy(newbuffer,buffer);
}

int main() {
  char ch,buffer[4096];
  int i=0;

  while ((buffer[i++] = getchar()) != &#39;\n&#39;) {};

  i=1;
  manipulate(buffer);
  i=2;
  printf(&#34;The value of i is : %d\n&#34;,i);
  return 0;
}</pre></div></div><div class=paragraph><p>Let us examine what the memory image of this process would look like if we were to input 160 spaces into our little program before hitting return.</p></div><div class=paragraph><p>Obviously more malicious input can be devised to execute actual compiled instructions (such as exec(/bin/sh)).</p></div></div><div class=sect2><h3 id=_avoiding_buffer_overflows>3.3.2. Avoiding Buffer Overflows<a class=anchor href=#_avoiding_buffer_overflows></a></h3><div class=paragraph><p>The most straightforward solution to the problem of stack-overflows is to always use length restricted memory and string copy functions. <code>strncpy</code> and <code>strncat</code> are part of the standard C library. These functions accept a length value as a parameter which should be no larger than the size of the destination buffer. These functions will then copy up to 'length' bytes from the source to the destination. However there are a number of problems with these functions. Neither function guarantees NUL termination if the size of the input buffer is as large as the destination. The length parameter is also used inconsistently between strncpy and strncat so it is easy for programmers to get confused as to their proper usage. There is also a significant performance loss compared to <code>strcpy</code> when copying a short string into a large buffer since <code>strncpy</code> NUL fills up the size specified.</p></div><div class=paragraph><p>Another memory copy implementation exists to get around these problems. The <code>strlcpy</code> and <code>strlcat</code> functions guarantee that they will always null terminate the destination string when given a non-zero length argument.</p></div><div class=sect3><h4 id=_compiler_based_run_time_bounds_checking>3.3.2.1. Compiler based run-time bounds checking<a class=anchor href=#_compiler_based_run_time_bounds_checking></a></h4><div class=paragraph><p>Unfortunately there is still a very large assortment of code in public use which blindly copies memory around without using any of the bounded copy routines we just discussed. Fortunately, there is a way to help prevent such attacks - run-time bounds checking, which is implemented by several C/C++ compilers.</p></div><div class=paragraph><p>ProPolice is one such compiler feature, and is integrated into <a href="https://man.freebsd.org/cgi/man.cgi?query=gcc&amp;sektion=1&amp;format=html">gcc(1)</a> versions 4.1 and later. It replaces and extends the earlier StackGuard <a href="https://man.freebsd.org/cgi/man.cgi?query=gcc&amp;sektion=1&amp;format=html">gcc(1)</a> extension.</p></div><div class=paragraph><p>ProPolice helps to protect against stack-based buffer overflows and other attacks by laying pseudo-random numbers in key areas of the stack before calling any function. When a function returns, these "canaries" are checked and if they are found to have been changed the executable is immediately aborted. Thus any attempt to modify the return address or other variable stored on the stack in an attempt to get malicious code to run is unlikely to succeed, as the attacker would have to also manage to leave the pseudo-random canaries untouched.</p></div><div class=paragraph><p>Recompiling your application with ProPolice is an effective means of stopping most buffer-overflow attacks, but it can still be compromised.</p></div></div><div class=sect3><h4 id=_library_based_run_time_bounds_checking>3.3.2.2. Library based run-time bounds checking<a class=anchor href=#_library_based_run_time_bounds_checking></a></h4><div class=paragraph><p>Compiler-based mechanisms are completely useless for binary-only software for which you cannot recompile. For these situations there are a number of libraries which re-implement the unsafe functions of the C-library (<code>strcpy</code>, <code>fscanf</code>, <code>getwd</code>, etc..) and ensure that these functions can never write past the stack pointer.</p></div><div class=ulist><ul><li><p>libsafe</p></li><li><p>libverify</p></li><li><p>libparanoia</p></li></ul></div><div class=paragraph><p>Unfortunately these library-based defenses have a number of shortcomings. These libraries only protect against a very small set of security related issues and they neglect to fix the actual problem. These defenses may fail if the application was compiled with -fomit-frame-pointer. Also, the LD_PRELOAD and LD_LIBRARY_PATH environment variables can be overwritten/unset by the user.</p></div></div></div></div></div><div class=sect1><h2 id=secure-setuid>3.4. SetUID issues<a class=anchor href=#secure-setuid></a></h2><div class=sectionbody><div class=paragraph><p>There are at least 6 different IDs associated with any given process. Because of this you have to be very careful with the access that your process has at any given time. In particular, all seteuid applications should give up their privileges as soon as it is no longer required.</p></div><div class=paragraph><p>The real user ID can only be changed by a superuser process. The login program sets this when a user initially logs in and it is seldom changed.</p></div><div class=paragraph><p>The effective user ID is set by the <code>exec()</code> functions if a program has its seteuid bit set. An application can call <code>seteuid()</code> at any time to set the effective user ID to either the real user ID or the saved set-user-ID. When the effective user ID is set by <code>exec()</code> functions, the previous value is saved in the saved set-user-ID.</p></div></div></div><div class=sect1><h2 id=secure-chroot>3.5. Limiting your program’s environment<a class=anchor href=#secure-chroot></a></h2><div class=sectionbody><div class=paragraph><p>The traditional method of restricting a process is with the <code>chroot()</code> system call. This system call changes the root directory from which all other paths are referenced for a process and any child processes. For this call to succeed the process must have execute (search) permission on the directory being referenced. The new environment does not actually take effect until you <code>chdir()</code> into your new environment. It should also be noted that a process can easily break out of a chroot environment if it has root privilege. This could be accomplished by creating device nodes to read kernel memory, attaching a debugger to a process outside of the <a href="https://man.freebsd.org/cgi/man.cgi?query=chroot&amp;sektion=8&amp;format=html">chroot(8)</a> environment, or in many other creative ways.</p></div><div class=paragraph><p>The behavior of the <code>chroot()</code> system call can be controlled somewhat with the kern.chroot_allow_open_directories <code>sysctl</code> variable. When this value is set to 0, <code>chroot()</code> will fail with EPERM if there are any directories open. If set to the default value of 1, then <code>chroot()</code> will fail with EPERM if there are any directories open and the process is already subject to a <code>chroot()</code> call. For any other value, the check for open directories will be bypassed completely.</p></div><div class=sect2><h3 id=_freebsds_jail_functionality>3.5.1. FreeBSD’s jail functionality<a class=anchor href=#_freebsds_jail_functionality></a></h3><div class=paragraph><p>The concept of a Jail extends upon the <code>chroot()</code> by limiting the powers of the superuser to create a true `virtual server'. Once a prison is set up all network communication must take place through the specified IP address, and the power of "root privilege" in this jail is severely constrained.</p></div><div class=paragraph><p>While in a prison, any tests of superuser power within the kernel using the <code>suser()</code> call will fail. However, some calls to <code>suser()</code> have been changed to a new interface <code>suser_xxx()</code>. This function is responsible for recognizing or denying access to superuser power for imprisoned processes.</p></div><div class=paragraph><p>A superuser process within a jailed environment has the power to:</p></div><div class=ulist><ul><li><p>Manipulate credential with <code>setuid</code>, <code>seteuid</code>, <code>setgid</code>, <code>setegid</code>, <code>setgroups</code>, <code>setreuid</code>, <code>setregid</code>, <code>setlogin</code></p></li><li><p>Set resource limits with <code>setrlimit</code></p></li><li><p>Modify some sysctl nodes (kern.hostname)</p></li><li><p><code>chroot()</code></p></li><li><p>Set flags on a vnode: <code>chflags</code>, <code>fchflags</code></p></li><li><p>Set attributes of a vnode such as file permission, owner, group, size, access time, and modification time.</p></li><li><p>Bind to privileged ports in the Internet domain (ports &lt; 1024)</p></li></ul></div><div class=paragraph><p><code>Jail</code> is a very useful tool for running applications in a secure environment but it does have some shortcomings. Currently, the IPC mechanisms have not been converted to the <code>suser_xxx</code> so applications such as MySQL cannot be run within a jail. Superuser access may have a very limited meaning within a jail, but there is no way to specify exactly what "very limited" means.</p></div></div><div class=sect2><h3 id=_posix_1e_process_capabilities>3.5.2. POSIX®.1e Process Capabilities<a class=anchor href=#_posix_1e_process_capabilities></a></h3><div class=paragraph><p>POSIX® has released a working draft that adds event auditing, access control lists, fine grained privileges, information labeling, and mandatory access control.</p></div><div class=paragraph><p>This is a work in progress and is the focus of the <a href=http://www.trustedbsd.org/>TrustedBSD</a> project. Some of the initial work has been committed to FreeBSD-CURRENT (cap_set_proc(3)).</p></div></div></div></div><div class=sect1><h2 id=secure-trust>3.6. Trust<a class=anchor href=#secure-trust></a></h2><div class=sectionbody><div class=paragraph><p>An application should never assume that anything about the users environment is sane. This includes (but is certainly not limited to): user input, signals, environment variables, resources, IPC, mmaps, the filesystem working directory, file descriptors, the # of open files, etc.</p></div><div class=paragraph><p>You should never assume that you can catch all forms of invalid input that a user might supply. Instead, your application should use positive filtering to only allow a specific subset of inputs that you deem safe. Improper data validation has been the cause of many exploits, especially with CGI scripts on the world wide web. For filenames you need to be extra careful about paths ("../", "/"), symbolic links, and shell escape characters.</p></div><div class=paragraph><p>Perl has a really cool feature called "Taint" mode which can be used to prevent scripts from using data derived outside the program in an unsafe way. This mode will check command line arguments, environment variables, locale information, the results of certain syscalls (<code>readdir()</code>, <code>readlink()</code>, <code>getpwxxx()</code>), and all file input.</p></div></div></div><div class=sect1><h2 id=secure-race-conditions>3.7. Race Conditions<a class=anchor href=#secure-race-conditions></a></h2><div class=sectionbody><div class=paragraph><p>A race condition is anomalous behavior caused by the unexpected dependence on the relative timing of events. In other words, a programmer incorrectly assumed that a particular event would always happen before another.</p></div><div class=paragraph><p>Some of the common causes of race conditions are signals, access checks, and file opens. Signals are asynchronous events by nature so special care must be taken in dealing with them. Checking access with <code>access(2)</code> then <code>open(2)</code> is clearly non-atomic. Users can move files in between the two calls. Instead, privileged applications should <code>seteuid()</code> and then call <code>open()</code> directly. Along the same lines, an application should always set a proper umask before <code>open()</code> to obviate the need for spurious <code>chmod()</code> calls.</p></div></div></div></div><hr><div class=last-modified><p><strong>最後修改於</strong>: March 9, 2024 由 <a href="https://cgit.freebsd.org/doc/commit/?id=6199af92e7" target=_blank>Danilo G. Baio</a></p></div><div class=buttons><div class=prev><i class="fa fa-angle-left" aria-hidden=true title=Prev></i><div class=container><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/tools class=direction>Prev</a></div></div><div class=home><i class="fa fa-home" aria-hidden=true title=Home></i><div class=container><a href=../ class=direction>Home</a></div></div><div class=next><div class=container><a href=http://172.16.201.134:1313/zh-tw/books/developers-handbook/l10n class=direction>Next</a></div><i class="fa fa-angle-right" aria-hidden=true title=Next></i></div></div><label class="hidden book-menu-overlay" for=menu-control></label></div><aside class=toc><div class=toc-content><h3>目錄</h3><nav id=TableOfContents><ul><li><a href=#secure-synopsis>3.1. Synopsis</a></li><li><a href=#secure-philosophy>3.2. Secure Design Methodology</a></li><li><a href=#secure-bufferov>3.3. Buffer Overflows</a></li><li><a href=#secure-setuid>3.4. SetUID issues</a></li><li><a href=#secure-chroot>3.5. Limiting your program’s environment</a></li><li><a href=#secure-trust>3.6. Trust</a></li><li><a href=#secure-race-conditions>3.7. Race Conditions</a></li></ul></nav><hr><div class=resources><h3>資源</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="下載 PDF"></i><a href=https://download.freebsd.org/doc/zh-tw/books/developers-handbook/developers-handbook_zh-tw.pdf>下載 PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title=編輯此頁></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/zh-tw/_index target=_blank>編輯此頁</a></li></ul></div></div></aside><a class=to-top href=#top><i class="fa fa-arrow-circle-up" aria-hidden=true></i></a></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/zh-tw/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt=選擇語言>
<span>繁體中文</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>淺色</option><option value=theme-dark>深色</option><option value=theme-high-contrast>高對比</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/zh-tw class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/zh-tw/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>