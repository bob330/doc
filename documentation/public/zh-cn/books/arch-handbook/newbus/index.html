<!doctype html><html class=theme-light lang=zh-cn><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/><title>第 14 章 Newbus | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="第 14 章 Newbus"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="zh-cn"><meta property="og:url" content="http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/zh-cn\/books\/arch-handbook\/newbus\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/zh-cn>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books>Books</a></li><li><a href=http://172.16.201.134:1313/zh-cn/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/zh-cn/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=zh-cn>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><input type=checkbox class="hidden toggle" id=menu-control><main class=main-wrapper-book><a id=top></a><aside class=book-menu><div class=book-menu-content><input id=search-book type=text placeholder=Search aria-label=Search maxlength=128><nav id=MenuContents><ul><li><input type=checkbox id=chapter-6dcd22d99f78db2a9aacae23be13866e class=toggle>
<label for=chapter-6dcd22d99f78db2a9aacae23be13866e><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/parti/>Part I. 内核</a></li><li><input type=checkbox id=chapter-9cc61bc35df69063dc03a5911e1ad9c9 class=toggle>
<label class="icon cursor" for=chapter-9cc61bc35df69063dc03a5911e1ad9c9><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/>第 1 章 引导过程与内核初始化</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-synopsis>1.1. 概述</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-overview>1.2. 总览</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-bios>1.3. BIOS POST</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-boot0>1.4. <code>boot0</code>阶段</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-boot2>1.5. <code>boot2</code>阶段</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-loader>1.6. loader阶段</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/boot/#boot-kernel>1.7. 内核初始化</a></li></ul></li><li><input type=checkbox id=chapter-3a651b0a4b9f6238336624d3c0fa5187 class=toggle>
<label class="icon cursor" for=chapter-3a651b0a4b9f6238336624d3c0fa5187><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/locking/>第 2 章 内核中的锁</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/locking/#locking-mutexes>2.1. Mutex</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/locking/#locking-sx>2.2. 共享互斥锁</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/locking/#locking-atomic>2.3. 原子保护变量</a></li></ul></li><li><input type=checkbox id=chapter-bf0b823c107a80f3035dfd6fae09d023 class=toggle>
<label class="icon cursor" for=chapter-bf0b823c107a80f3035dfd6fae09d023><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/kobj/>第 3 章 内核对象</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/kobj/#kernel-objects-term>3.1. 术语</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/kobj/#kernel-objects-operation>3.2. Kobj的工作流程</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/kobj/#kernel-objects-using>3.3. 使用Kobj</a></li></ul></li><li><input type=checkbox id=chapter-41dab1afed6cf3ffa54628db4227e196 class=toggle>
<label class="icon cursor" for=chapter-41dab1afed6cf3ffa54628db4227e196><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/jail/>第 4 章 Jail子系统</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/jail/#jail-arch>4.1. Jail的系统结构</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/jail/#jail-restrictions>4.2. 系统对被囚禁程序的限制</a></li></ul></li><li><input type=checkbox id=chapter-e7d9ebcb448b0045179ebe22f8e2e9d8 class=toggle>
<label class="icon cursor" for=chapter-e7d9ebcb448b0045179ebe22f8e2e9d8><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sysinit/>第 5 章 SYSINIT框架</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sysinit/#sysinit-term>5.1. 术语</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sysinit/#sysinit-operation>5.2. SYSINIT操作</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sysinit/#sysinit-using>5.3. 使用SYSINIT</a></li></ul></li><li><input type=checkbox id=chapter-8b57b16ba53538421a8fb2152b25976f class=toggle>
<label class="icon cursor" for=chapter-8b57b16ba53538421a8fb2152b25976f><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/>第 6 章 TrustedBSD MAC 框架</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-copyright>6.1. MAC 文档版权声明</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-synopsis>6.2. 术语解析</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-introduction>6.3. 概述</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-background>6.4. 安全策略背景知识</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-framework-kernel-arch>6.5. MAC 框架的内核体系结构</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-policy-architecture>6.6. MAC策略模块体系结构</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-entry-point-reference>6.7. MAC策略入口函数参考</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-userland-arch>6.8. 应用层体系结构</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/mac/#mac-conclusion>6.9. 小结</a></li></ul></li><li><input type=checkbox id=chapter-28609916419208e3a19d240cf7593906 class=toggle>
<label class="icon cursor" for=chapter-28609916419208e3a19d240cf7593906><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/>第 7 章 虚拟内存系统</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-physmem>7.1. 物理内存的管理-<code>vm_page_t</code></a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-cache>7.2. 统一的缓存信息结构体-<code>vm_object_t</code></a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-fileio>7.3. 文件系统输入/输出-<code>buf</code>结构体</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-pagetables>7.4. 映射页表-<code>vm_map_t, vm_entry_t</code></a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-kvm>7.5. KVM存储映射</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/vm/#vm-tuning>7.6. 调整FreeBSD的虚拟内存系统</a></li></ul></li><li><input type=checkbox id=chapter-716edd44e8ad22ea57cdf273d2578872 class=toggle>
<label class="icon cursor" for=chapter-716edd44e8ad22ea57cdf273d2578872><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/>第 8 章 SMPng 设计文档</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-intro>8.1. 绪论</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-lock-fundamentals>8.2. 基本工具与上锁的基础知识</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-design>8.3. 架构与设计概览</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-lock-strategies>8.4. 特定数据的锁策略</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-implementation-notes>8.5. 实现说明</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-misc>8.6. 其它话题</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/smp/#smp-glossary>术语表</a></li></ul></li><li><input type=checkbox id=chapter-448f803e40f97b1ff8336db9ba637745 class=toggle>
<label for=chapter-448f803e40f97b1ff8336db9ba637745><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/partii/>Part II. 设备驱动程序</a></li><li><input type=checkbox id=chapter-6971d35b0bbe2a0bdb005a02546cd580 class=toggle>
<label class="icon cursor" for=chapter-6971d35b0bbe2a0bdb005a02546cd580><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/>第 9 章 编写 FreeBSD 设备驱动程序</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-intro>9.1. 简介</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-kld>9.2. 动态内核链接工具-KLD</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-access>9.3. 访问设备驱动程序</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-char>9.4. 字符设备</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-block>9.5. 块设备(消亡中)</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/driverbasics/#driverbasics-net>9.6. 网络设备驱动程序</a></li></ul></li><li><input type=checkbox id=chapter-9cc7968be065b256e57086439d93e9a4 class=toggle>
<label class="icon cursor" for=chapter-9cc7968be065b256e57086439d93e9a4><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/>第 10 章 ISA设备驱动程序</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-synopsis>10.1. 概述</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-basics>10.2. 基本信息</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-device-t>10.3. Device_t指针</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-config>10.4. 配置文件与自动配置期间识别和探测的顺序</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-resources>10.5. 资源</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-busmem>10.6. 总线内存映射</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-dma>10.7. DMA</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-probe>10.8. xxx_isa_probe</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-attach>10.9. xxx_isa_attach</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-detach>10.10. xxx_isa_detach</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-shutdown>10.11. xxx_isa_shutdown</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/isa/#isa-driver-intr>10.12. xxx_intr</a></li></ul></li><li><input type=checkbox id=chapter-0b427d421e89aa3107f62d5b70f6a0f2 class=toggle>
<label class="icon cursor" for=chapter-0b427d421e89aa3107f62d5b70f6a0f2><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/pci/>第 11 章 PCI设备</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/pci/#pci-probe>11.1. 探测与连接</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/pci/#pci-bus>11.2. 总线资源</a></li></ul></li><li><input type=checkbox id=chapter-0b7eb8d45a0ea6bc9c2882e903b93959 class=toggle>
<label class="icon cursor" for=chapter-0b7eb8d45a0ea6bc9c2882e903b93959><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/>第 12 章 通用访问方法SCSI控制器</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-synopsis>12.1. 提纲</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-general>12.2. 通用基础结构</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-polling>12.3. 轮询</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-async>12.4. 异步事件</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-interrupts>12.5. 中断</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-errors>12.6. 错误总览</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/scsi/#scsi-timeout>12.7. 超时处理</a></li></ul></li><li><input type=checkbox id=chapter-bdaa4909dfbdcec8d7be976fd87cb00e class=toggle>
<label class="icon cursor" for=chapter-bdaa4909dfbdcec8d7be976fd87cb00e><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/>第 13 章 USB设备</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/#usb-intro>13.1. 简介</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/#usb-hc>13.2. 主控器</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/#usb-dev>13.3. USB设备信息</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/#usb-devprobe>13.4. 设备的探测和连接</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb/#usb-protocol>13.5. USB驱动程序的协议信息</a></li></ul></li><li><input type=checkbox id=chapter-5fc5c179f5014d968a5c8feec7e10e59 class=toggle checked>
<label class="icon cursor" for=chapter-5fc5c179f5014d968a5c8feec7e10e59><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/>第 14 章 Newbus</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/#newbus-devdrivers>14.1. 设备驱动程序</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/#newbus-overview>14.2. Newbus概览</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/newbus/#newbus-api>14.3. Newbus API</a></li></ul></li><li><input type=checkbox id=chapter-7d3796cced00105c77e7f87e84edd73b class=toggle>
<label class="icon cursor" for=chapter-7d3796cced00105c77e7f87e84edd73b><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound/>第 15 章 声音子系统</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound/#oss-intro>15.1. 简介</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound/#oss-files>15.2. 文件</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound/#pcm-probe-and-attach>15.3. 探测，连接等</a></li><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound/#oss-interfaces>15.4. 接口</a></li></ul></li><li><input type=checkbox id=chapter-41c74c3e72fcf5116f6d999c36ef185b class=toggle>
<label class="icon cursor" for=chapter-41c74c3e72fcf5116f6d999c36ef185b><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/pccard/>第 16 章 PC Card</a><ul><li><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/pccard/#pccard-adddev>16.1. 添加设备</a></li></ul></li><li><input type=checkbox id=chapter-2a7cf37011599a8e3d62d1e3008c3c5d class=toggle>
<label for=chapter-2a7cf37011599a8e3d62d1e3008c3c5d><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/partiii/>Part III. 附录</a></li><li><input type=checkbox id=chapter-d4c82056f0235da9fde0d29203d44f9a class=toggle>
<label for=chapter-d4c82056f0235da9fde0d29203d44f9a><a role=button></a></label><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/bibliography/>参考书目</a></li><li></li></ul></nav></div></aside><div class=book><div class=book-menu-mobile><label for=menu-control><span class=menu-control-button><i class="fa fa-list" aria-hidden=true title="Book menu"></i>
Book menu</span></label></div><h1 class=title>第 14 章 Newbus</h1><div class="admonitionblock note"><p><i class="fa fa-exclamation-circle" aria-hidden=true></i>
This translation may be out of date. To help with the translations please access the <a href=https://translate-dev.freebsd.org/ target=_blank>FreeBSD translations instance</a>.</p></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#newbus-devdrivers>14.1. 设备驱动程序</a></li><li><a href=#newbus-overview>14.2. Newbus概览</a></li><li><a href=#newbus-api>14.3. Newbus API</a></li></ul></nav></div><div class=book-content><div id=preamble><div class=sectionbody><div class=paragraph><p><em>特别感谢Matthew N. Dodd, Warner Losh, Bill Paul, Doug Rabson, Mike Smith, Peter Wemm and Scott Long</em>.</p></div><div class=paragraph><p>本章详细解释了Newbus设备框架。</p></div></div></div><div class=sect1><h2 id=newbus-devdrivers>14.1. 设备驱动程序<a class=anchor href=#newbus-devdrivers></a></h2><div class=sectionbody><div class=sect2><h3 id=_设备驱动程序的目的>14.1.1. 设备驱动程序的目的<a class=anchor href=#_设备驱动程序的目的></a></h3><div class=paragraph><p>设备驱动程序是软件组件，它在内核关于外围设备（例如，磁盘、网络 适配卡）的通用视图和外围设备的实际实现之间提供了接口。 <em>设备驱动程序接口(DDI)</em>是内核与设备驱动程序组件 之间定义的接口。</p></div></div><div class=sect2><h3 id=_设备驱动程序的类型>14.1.2. 设备驱动程序的类型<a class=anchor href=#_设备驱动程序的类型></a></h3><div class=paragraph><p>在UNIX®那个时代，FreeBSD也从中延续而来，定义了四种类型的 设备：</p></div><div class=ulist><ul><li><p>块设备驱动程序</p></li><li><p>字符设备驱动程序</p></li><li><p>网络设备驱动程序</p></li><li><p>伪设备驱动程序</p></li></ul></div><div class=paragraph><p><em>块设备</em>以使用固定大小的[数据]块的方式运行。 这种类型的驱动程序依赖所谓的 <em>缓冲区缓存(buffer cache)</em>，其目的 是在内存中的专用区域缓存访问过的数据块。这种缓冲区缓存常常基于后台写 (write-behind)，这意味着数据在内存中被修改后，当系统进行其周期性 磁盘刷新时才会被同步到磁盘，从而优化写操作。</p></div></div><div class=sect2><h3 id=_字符设备>14.1.3. 字符设备<a class=anchor href=#_字符设备></a></h3><div class=paragraph><p>然而，在FreeBSD 4.0版本以及后续版本中， 块设备和字符设备的区别变得不存在了。</p></div></div></div></div><div class=sect1><h2 id=newbus-overview>14.2. Newbus概览<a class=anchor href=#newbus-overview></a></h2><div class=sectionbody><div class=paragraph><p><em>Newbus</em>实现了一种基于抽象层的新型总线结构， 可以在FreeBSD 3.0中看到这种总线结构的介绍，当时Alpha的移植被导入到 代码树中。直到4.0它才成为设备驱动程序使用的默认系统。其目的是为主机 系统提供给<em>操作系统</em>的各种总线和设备的互连提供更加 面向对象的方法。</p></div><div class=paragraph><p>其主要特性包括：</p></div><div class=ulist><ul><li><p>动态连接</p></li><li><p>驱动程序容易模块化</p></li><li><p>伪总线</p></li></ul></div><div class=paragraph><p>最显著的改变之一是从平面和特殊系统演变为设备树布局。</p></div><div class=paragraph><p>顶层驻留的是<em>"根"</em>设备，它作为 父设备，所有其他设备挂接在它上面。对于每个结构，通常"根" 只有单个孩子，其上连接着诸如<em>host-to-PCI桥</em> 等东西。对于x86，这种"根"设备为 <em>"nexus"</em>设备，对于Alpha，Alpha的各种 不同型号有不同的顶层设备，对应不同的硬件芯片组，包括 <em>lca</em>，<em>apecs</em>， <em>cia</em>和<em>tsunami</em>。</p></div><div class=paragraph><p>Newbus上下文中的设备表示系统中的单个硬件实体。例如，每个PCI设备被 表示为一个Newbus设备。系统中的任何设备可以有孩子；有孩子的设备通常被 称为<em>"bus"</em>。系统中常用总线的例子就是 ISA和PCI，他们各自管理连接到ISA和PCI总线上的设备列表。</p></div><div class=paragraph><p>通常，不同类型的总线之间的连接被表示为 <em>"桥"</em>设备，它的孩子就是它所连接的 总线。一个例子就是<em>PCI-to-PCI桥</em>，它在父PCI总线上被 表示为<em><span class=filename>pcibN</span></em>，而用它的孩子 -<em><span class=filename>pciN</span></em>表示连接在它上面的 总线。这种布局简化了PCI总线树的实现，允许公共代码同时用于顶层和桥接的 总线。</p></div><div class=paragraph><p>Newbus结构中的每个设备请求它的父设备来为其映射资源。父设备接着请求 它的父设备，直到到达nexus。因此，基本上nexus是Newbus系统中唯一知道所有 资源的部分。</p></div><div class="admonitionblock tip"><table><tbody><tr><td class=icon><i class="fa icon-tip" title=Tip></i></td><td class=content><div class=paragraph><p>ISA设备可能想在<code>0x230</code>映射其IO端口，因此它向其 父设备请求，这种情况下是ISA总线。ISA总线将它交给PCI-to-ISA桥，PCI-to-ISA 桥接着请求PCI总线，PCI总线到达host-to-PCI桥，最后到达nexus。这种向上 过渡的优美之处在于可以有空间来变换请求。对<code>0x230</code>IO端口 的请求在MIPS机器上可以被PCI桥变成 <code>0xb0000230</code>处的内存映射。</p></div></td></tr></tbody></table></div><div class=paragraph><p>资源分配可以在设备树的任何地方加以控制。例如，在很多Alpha平台上， ISA中断与PCI中断是单独管理的，对ISA中断的资源分配是由Alpha的ISA总线设备 管理的。在IA-32上，ISA和PCI中断都由顶层的nexus设备管理。对于两种移植， 内存和端口地址空间由单个实体管理 - 在IA-32上是nexus，在Alpha（例如，CIA 或tsunami）上是相关的芯片组驱动程序。</p></div><div class=paragraph><p>为了规范化对内存和端口映射资源的访问，Newbus整合了NetBSD的 <code>bus_space</code> API。他们提供了单一的API来代替inb/outb 和直接内存读写。这样做的优势在于单个驱动程序就可以使用内存映射寄存器 或端口映射寄存器（有些硬件支持两者）。</p></div><div class=paragraph><p>这种支持被合并到了资源分配机制中。分配资源时，驱动程序可以从资源 中检取关联的<code>bus_space_tag_t</code>和 <code>bus_space_handle_t</code>。</p></div><div class=paragraph><p>Newbus也允许在专用于此目的的文件中定义接口方法。这些是 <span class=filename>.m</span>文件，可以在<span class=filename>src/sys</span> 目录树中找到。</p></div><div class=paragraph><p>Newbus系统的核心是可扩展的"基于对象编程(object-based programming)"的模型。系统中的每个设备具有它所支持的一个方法表。 系统和其他设备使用这些方法来控制设备并请求服务。设备所支持的不同方法 被定义为多个"接口"。"接口"只是 设备实现的一组相关的方法。</p></div><div class=paragraph><p>在Newbus系统中，设备方法是通过系统中的各种设备驱动程序提供的。当 <em>自动配置(auto-configuration)</em>期间设备被连接(attach) 到驱动程序，它使用驱动程序声明的方法表。以后设备可以从其驱动程序 <em>分离(detach)</em>，并 <em>重新连接(re-attach)</em>到具有新方法表的新驱动程序。这就 允许驱动程序的动态替换，而动态替换对于驱动程序的开发非常有用。</p></div><div class=paragraph><p>接口通过与文件系统中用于定义vnode操作的语言相似的接口定义语言来 描述。接口被保存在方法文件中（通常命名为<span class=filename>foo_if.m</span>）。</p></div><div class=exampleblock><div class=title>例 1. Newbus的方法</div><div class=content><div class="literalblock programlisting"><div class=content><pre>      # Foo 子系统/驱动程序（注释...）

	  INTERFACE foo

       	METHOD int doit {
       		device_t dev;
       	};

       	# 如果没有通过DEVMETHOD()提供一个方法，则DEFAULT为将会被使用的方法

       	METHOD void doit_to_child {
       		device_t dev;
       		driver_t child;
       	} DEFAULT doit_generic_to_child;</pre></div></div></div></div><div class=paragraph><p>当接口被编译后，它产生一个头文件 "<span class=filename>foo_if.h</span>"，其中包含函数声明：</p></div><div class="literalblock programlisting"><div class=content><pre>      int FOO_DOIT(device_t dev);
      int FOO_DOIT_TO_CHILD(device_t dev, device_t child);</pre></div></div><div class=paragraph><p>伴随自动产生的头文件，也会创建一个源文件 "<span class=filename>foo_if.c</span>"；其中包含一些函数的实现， 这些函数用于在对象方法表中查找相关函数的位置并调用那个函数。</p></div><div class=paragraph><p>系统定义了两个主要接口。第一个基本接口被称为 <em>"设备(device)"</em>，并包括与所有设备相关 的方法。<em>"设备(device)"</em>接口中的方法 包括<em>"探测(probe)"</em>， <em>"连接(attach)"</em>和 <em>"分离(detach)"</em>，他们用来控制硬件的侦测， 以及<em>"关闭(shutdown)"</em>， <em>"挂起(suspend)"</em>和 <em>"恢复(resume)"</em>，他们用于关键事件通知。</p></div><div class=paragraph><p>另一个，更加复杂接口是<em>"bus"</em>。 此接口包含的方法适用于带有孩子的设备，包括访问总线特定的每设备信息 ，事件通知 （<code>child_detached</code>，<code>driver_added</code>）和响应管理 （<code>alloc_resource</code>， <code>activate_resource</code>， <code>deactivate_resource</code>， <code>release_resource</code>）。</p></div><div class=paragraph><p>"bus"接口中的很多方法为总线设备的某些孩子执行服务。 这些方法通常使用前两个参量指定提供服务的总线和请求服务的子设备。为了 简化设备驱动程序代码，这些方法中的很多都有访问者(accessor)函数，访问者 函数用来查找父设备并调用父设备上的方法。例如，方法 <code>BUS_TEARDOWN_INTR(device_t dev, device_t child, …​)</code> 可以使用函数 <code>bus_teardown_intr(device_t child, …​)</code>来调用。</p></div><div class=paragraph><p>系统中的某些总线类型提供了额外接口以提供对总线特定功能的访问。 例如，PCI总线驱动程序定义了"pci"接口，此接口有两个方法 <code>read_config</code>和 <code>write_config</code>，用于访问PCI设备 的配置寄存器。</p></div></div></div><div class=sect1><h2 id=newbus-api>14.3. Newbus API<a class=anchor href=#newbus-api></a></h2><div class=sectionbody><div class=paragraph><p>由于Newbus API非常庞大，本节努力将它文档化。本文档的下一版本会 带来更多信息。</p></div><div class=sect2><h3 id=_源代码目录树中的重要位置>14.3.1. 源代码目录树中的重要位置<a class=anchor href=#_源代码目录树中的重要位置></a></h3><div class=paragraph><p><span class=filename>src/sys/[arch]/[arch]</span> - 特定机器结构的 内核代码位于这个目录。例如<code>i386</code>结构或 <code>SPARC64</code>结构。</p></div><div class=paragraph><p><span class=filename>src/sys/dev/[bus]</span> - 支持特定 <code>[bus]</code>的设备位于这个目录。</p></div><div class=paragraph><p><span class=filename>src/sys/dev/pci</span> - PCI总线支持代码位于 这个目录。</p></div><div class=paragraph><p><span class=filename>src/sys/[isa|pci]</span> - PCI/ISA设备驱动程序 位于这个目录。FreeBSD<code>4.0</code>版本中，PCI/ISA支持代码 过去存在于这个目录中。</p></div></div><div class=sect2><h3 id=_重要结构和类型定义>14.3.2. 重要结构和类型定义<a class=anchor href=#_重要结构和类型定义></a></h3><div class=paragraph><p><code>devclass_t</code> - 这是指向 <code>struct devclass</code>的指针的类型定义。</p></div><div class=paragraph><p><code>device_method_t</code> - 与 <code>kobj_method_t</code>相同（参看 <span class=filename>src/sys/kobj.h</span>）。</p></div><div class=paragraph><p><code>device_t</code> - 这是指向 <code>struct device</code>的指针的类型定义。 <code>device_t</code> 表示系统中的设备。它是内核对象。 实现细节参看<span class=filename>src/sys/sys/bus_private.h</span>。</p></div><div class=paragraph><p><code>driver_t</code> - 这是一个类型定义，它引用 <code>struct driver</code>。 <code>driver</code>结构是一类 <code>device(设备)</code>内核对象；它也保存着驱动程序的私有数据。</p></div><div class=paragraph><p><strong>driver_t实现</strong></p></div><div class="literalblock programlisting"><div class=content><pre>	  struct driver {
	     	KOBJ_CLASS_FIELDS;
	      	void	*priv;			/* 驱动程序私有数据 */
	  };</pre></div></div><div class=paragraph><p><code>device_state_t</code>是一个枚举类型，即 <code>device_state</code>。它包含Newbus设备在自动配置前后 可能的状态。</p></div><div class=paragraph><p><strong>设备状态device_state_t</strong></p></div><div class="literalblock programlisting"><div class=content><pre>	  /*
	   * src/sys/sys/bus.h
	   */
	  typedef enum device_state {
	  	DS_NOTPRESENT,	/* 未探测或探测失败 */
	    	DS_ALIVE,		/* 探测成功 */
	    	DS_ATTACHED,	/* 调用了连接方法 */
	    	DS_BUSY			/* 设备已打开 */
	  } device_state_t;</pre></div></div></div></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: March 9, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=6199af92e7" target=_blank>Danilo G. Baio</a></p></div><div class=buttons><div class=prev><i class="fa fa-angle-left" aria-hidden=true title=Prev></i><div class=container><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/usb class=direction>Prev</a></div></div><div class=home><i class="fa fa-home" aria-hidden=true title=Home></i><div class=container><a href=../ class=direction>Home</a></div></div><div class=next><div class=container><a href=http://172.16.201.134:1313/zh-cn/books/arch-handbook/sound class=direction>Next</a></div><i class="fa fa-angle-right" aria-hidden=true title=Next></i></div></div><label class="hidden book-menu-overlay" for=menu-control></label></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#newbus-devdrivers>14.1. 设备驱动程序</a></li><li><a href=#newbus-overview>14.2. Newbus概览</a></li><li><a href=#newbus-api>14.3. Newbus API</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/zh-cn/books/arch-handbook/arch-handbook_zh-cn.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/zh-cn/_index target=_blank>Edit this page</a></li></ul></div></div></aside><a class=to-top href=#top><i class="fa fa-arrow-circle-up" aria-hidden=true></i></a></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/zh-cn/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Choose language">
<span>简体中文</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/zh-cn class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/zh-cn/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>