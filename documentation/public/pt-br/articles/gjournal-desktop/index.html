<!doctype html><html class=theme-light lang=pt-br><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Implementando o UFS Journaling em um Desktop PC"><meta name=keywords content="UFS,Journaling,Desktop,FreeBSD"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/pt-br/articles/gjournal-desktop/><title>Implementando o UFS Journaling em um Desktop PC | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Implementando o UFS Journaling em um Desktop PC"><meta property="og:description" content="Implementando o UFS Journaling em um Desktop PC"><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="pt-br"><meta property="og:url" content="http://172.16.201.134:1313/pt-br/articles/gjournal-desktop/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/pt-br\/articles\/gjournal-desktop\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/pt-br>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/pt-br/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/pt-br/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/pt-br/books>Books</a></li><li><a href=http://172.16.201.134:1313/pt-br/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/pt-br/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=pt-br>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Implementando o UFS Journaling em um Desktop PC</h1><div class="admonitionblock note"><p><i class="fa fa-exclamation-circle" aria-hidden=true></i>
Esta tradução pode estar desatualizada. Para ajudar com as traduções, acesse a <a href=https://translate-dev.freebsd.org/ target=_blank>ferramenta de traduções do FreeBSD</a>.</p></div><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Índice</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Introdução</a></li><li><a href=#understanding-journaling>2. Compreendendo o journaling no FreeBSD</a></li><li><a href=#reserve-space>3. Etapas durante a instalação do FreeBSD</a></li><li><a href=#configure-journal>4. Configurando o journaling</a></li><li><a href=#troubleshooting-gjournal>5. Solução de problemas com journaling</a></li><li><a href=#further-reading>6. Leitura Adicional</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Resumo</p></div><div class=paragraph><p>Um sistema de arquivos com journaling utiliza um log para registrar todas as transações que ocorrem no sistema de arquivos e preserva sua integridade em caso de falha do sistema ou queda de energia. Embora ainda seja possível perder alterações não salvas em arquivos, o journaling quase elimina completamente a possibilidade de corrupção do sistema de arquivos causada por uma desligamento incorreto. Ele também reduz ao mínimo o tempo necessário para a verificação do sistema de arquivos após uma falha. Embora o sistema de arquivos UFS utilizado pelo FreeBSD não implemente o journaling por si só, a nova classe de journaling do framework GEOM no FreeBSD 7.<em>X</em> pode ser usada para fornecer o journaling independente do sistema de arquivos. Este artigo explica como implementar o journaling do UFS em um cenário típico de um PC desktop.</p></div><hr></div></div><div class=sect1><h2 id=introduction>1. Introdução<a class=anchor href=#introduction></a></h2><div class=sectionbody><div class=paragraph><p>Enquanto servidores profissionais geralmente estão bem protegidos contra desligamentos imprevistos, os desktops típicos estão sujeitos a quedas de energia, reinicializações acidentais e outros incidentes relacionados ao usuário que podem levar a desligamentos incorretos. As Soft Updates geralmente protegem o sistema de arquivos de forma eficiente nesses casos, embora na maioria das vezes seja necessária uma verificação em segundo plano demorada. Em raras ocasiões, a corrupção do sistema de arquivos atinge um ponto em que é necessária a intervenção do usuário e dados podem ser perdidos.</p></div><div class=paragraph><p>O novo recurso de journaling fornecido pela GEOM pode ajudar bastante nesses cenários, praticamente eliminando o tempo necessário para a verificação do sistema de arquivos e garantindo que o sistema de arquivos seja rapidamente restaurado para um estado consistente.</p></div><div class=paragraph><p>Este artigo descreve um procedimento para implementar o journaling do UFS em um cenário típico de um PC desktop (um disco rígido usado tanto para o sistema operacional quanto para os dados). Ele deve ser seguido durante uma nova instalação do FreeBSD. Os passos são simples o suficiente e não exigem interações excessivamente complexas com a linha de comando.</p></div><div class=paragraph><p>Depois de ler este artigo, você saberá:</p></div><div class=ulist><ul><li><p>Como reservar espaço para o journaling durante uma nova instalação do FreeBSD.</p></li><li><p>Como carregar e ativar o módulo <code>geom_journal</code> (ou compilar o suporte para ele em seu kernel personalizado).</p></li><li><p>Como converter seus sistemas de arquivos existentes para utilizar journaling e quais opções usar no arquivo <span class=filename>/etc/fstab</span> para montá-los.</p></li><li><p>Como implementar o journaling em novas partições (vazias).</p></li><li><p>Como solucionar problemas comuns associados ao journaling.</p></li></ul></div><div class=paragraph><p>Antes de ler este artigo, você deve ser capaz de:</p></div><div class=ulist><ul><li><p>Entender os conceitos básicos do UNIX® e do FreeBSD.</p></li><li><p>Estar familiarizado com o procedimento de instalação do FreeBSD e com a ferramenta sysinstall.</p></li></ul></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>A procedimento descrito aqui destina-se a preparar uma nova instalação na qual ainda não existe nenhum dado do usuário armazenado no disco. Embora seja possível modificar e estender este procedimento para sistemas já em produção, você deve fazer um <em>backup</em> de todos os dados importantes antes de fazê-lo. Mexer com discos e partições em um nível baixo pode levar a erros fatais e a perda de dados.</p></div></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=understanding-journaling>2. Compreendendo o journaling no FreeBSD<a class=anchor href=#understanding-journaling></a></h2><div class=sectionbody><div class=paragraph><p>O journaling fornecido pelo GEOM no FreeBSD 7.<em>X</em> não é específico do sistema de arquivos (ao contrário do sistema de arquivos ext3 no Linux®), mas funciona no nível de bloco. Embora isso signifique que ele possa ser aplicado a diferentes sistemas de arquivos, no FreeBSD 7.0-RELEASE, ele só pode ser usado no UFS2.</p></div><div class=paragraph><p>Essa funcionalidade é fornecida carregando o módulo <span class=filename>geom_journal.ko</span> no kernel (ou compilando-o em um kernel personalizado) e usando o comando <code>gjournal</code> para configurar os sistemas de arquivos. Em geral, você gostaria de registrar grandes sistemas de arquivos, como o <span class=filename>/usr</span>. No entanto, você precisará reservar algum espaço livre em disco (consulte a próxima seção).</p></div><div class=paragraph><p>Quando um sistema de arquivos é jornalizado, é necessário um espaço em disco para armazenar o próprio journal. O espaço em disco que contém os dados reais é chamado de <em>provedor de dados</em> (data provider), enquanto o que contém o journal é chamado de <em>provedor de journal</em> (journal provider). Os provedores de dados e de journal precisam estar em partições diferentes ao jornalizar uma partição existente (não vazia). Ao jornalizar uma nova partição, você tem a opção de usar um único provedor para ambos os dados e o journal. Em qualquer caso, o comando <code>gjournal</code> combina ambos os provedores para criar o sistema de arquivos final com journaling. Por exemplo:</p></div><div class=ulist><ul><li><p>Você deseja fazer o journaling do sistema de arquivos <span class=filename>/usr</span>, armazenado em <span class=filename>/dev/ad0s1f</span> (que já contém dados).</p></li><li><p>Você reservou um espaço livre em disco em uma partição em [/dev/ad0s1g].</p></li><li><p>Usando <code>gjournal</code>, um novo dispositivo <span class=filename>/dev/ad0s1f.journal</span> é criado, onde <span class=filename>/dev/ad0s1f</span> é o provedor de dados e <span class=filename>/dev/ad0s1g</span> é o provedor de journal. Esse novo dispositivo é então usado para todas as operações de arquivo subsequentes.</p></li></ul></div><div class=paragraph><p>A quantidade de espaço em disco que você precisa reservar para o provedor de journal depende da carga de uso do sistema de arquivos e não do tamanho do provedor de dados. Por exemplo, em um desktop de escritório típico, um provedor de journal de 1 GB para o sistema de arquivos <span class=filename>/usr</span> será suficiente, enquanto uma máquina que lida com intensas operações E/S de disco (por exemplo, edição de vídeo) pode precisar de mais espaço. Ocorrerá um kernel panic se o espaço do journal for esgotado antes que ele tenha a chance de ser confirmado (committed).</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Os tamanhos de journal sugeridos aqui são altamente improváveis de causar problemas em uso típico de desktop, como navegação na web, processamento de texto e reprodução de arquivos de mídia. Se a sua carga de trabalho inclui atividade intensa de disco, utilize a seguinte regra para obter máxima confiabilidade: o tamanho da sua memória RAM deve caber em 30% do espaço do provedor de journal. Por exemplo, se o seu sistema possui 1 GB de RAM, crie um provedor de journal de aproximadamente 3,3 GB (multiplique o tamanho da sua RAM por 3,3 para obter o tamanho do journal).</p></div></td></tr></tbody></table></div><div class=paragraph><p>Para obter mais informações sobre o journaling, por favor, leia a página do manual <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>.</p></div></div></div><div class=sect1><h2 id=reserve-space>3. Etapas durante a instalação do FreeBSD<a class=anchor href=#reserve-space></a></h2><div class=sectionbody><div class=sect2><h3 id=_reservando_espaço_para_o_journaling>3.1. Reservando espaço para o journaling<a class=anchor href=#_reservando_espaço_para_o_journaling></a></h3><div class=paragraph><p>Uma máquina desktop típica geralmente possui um único disco rígido que armazena tanto o sistema operacional quanto os dados do usuário. Argumentavelmente, o esquema de particionamento padrão selecionado pelo sysinstall é mais ou menos adequado: uma máquina desktop não precisa de uma partição <span class=filename>/var</span> grande, enquanto a partição <span class=filename>/usr</span> é alocada para a maior parte do espaço em disco, uma vez que os dados do usuário e muitos pacotes são instalados em seus subdiretórios.</p></div><div class=paragraph><p>A partição padrão (aquela obtida ao pressionar <kbd>A</kbd> no editor de partição do FreeBSD, chamado Disklabel) não deixa nenhum espaço não alocado. Cada partição que será jornalizada requer outra partição para o journal. Como a partição <span class=filename>/usr</span> é a maior, faz sentido reduzir levemente essa partição para obter o espaço necessário para o journaling.</p></div><div class=paragraph><p>No nosso exemplo, um disco de 80 GB está sendo utilizado. A captura de tela a seguir mostra as partições padrões criadas pelo Disklabel durante a instalação:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel1.png alt=disklabel1></div></div><div class=paragraph><p>Se isso é mais ou menos o que você precisa, é muito fácil ajustar para o journaling. Basta usar as teclas de seta para mover o destaque para a partição <span class=filename>/usr</span> e pressionar <kbd>D</kbd> para excluí-la.</p></div><div class=paragraph><p>Agora, mova o destaque para o nome do disco no topo da tela e pressione <kbd>C</kbd> para criar uma nova partição para <span class=filename>/usr</span>. Essa nova partição deve ser menor em 1 GB (se você pretende jornalizar apenas <span class=filename>/usr</span>) ou 2 GB (se você pretende jornalizar tanto <span class=filename>/usr</span> quanto <span class=filename>/var</span>). No pop-up que aparece, opte por criar um sistema de arquivos e digite <span class=filename>/usr</span> como ponto de montagem.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Você deve jornalizar a partição <span class=filename>/var</span>? Normalmente, o journaling faz sentido em partições bastante grandes. Você pode optar por não jornalizar <span class=filename>/var</span>, embora fazê-lo em um desktop típico não cause problemas. Se o sistema de arquivos tiver um uso leve (o que é bastante provável para um desktop), você pode desejar alocar menos espaço em disco para o seu journal.</p></div><div class=paragraph><p>No nosso exemplo, nós aplicamos o journaling nas partições <span class=filename>/usr</span> e <span class=filename>/var</span>. Você pode, é claro, ajustar o procedimento de acordo com suas próprias necessidades.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Para facilitar o processo o máximo possível, vamos usar o sysinstall para criar as partições necessárias para o journaling. No entanto, durante a instalação, o sysinstall insiste em solicitar um ponto de montagem para cada partição que você cria. Neste momento, você não possui nenhum ponto de montagem para as partições que irão armazenar os journals e, na realidade, você nem mesmo precisa deles. Essas não são partições que serão montadas em algum lugar.</p></div><div class=paragraph><p>Para evitar esses problemas com o sysinstall, vamos criar as partições de journal como espaço de swap. O swap nunca é montado, e o sysinstall não tem problemas em criar quantas partições de swap forem necessárias. Após o primeiro reinício, será necessário editar o arquivo <span class=filename>/etc/fstab</span> e remover as entradas de espaço de swap adicionais.</p></div><div class=paragraph><p>Para criar a partição de swap, novamente use as teclas de seta para mover o destaque para o topo da tela do Disklabel, de modo que o próprio nome do disco seja destacado. Em seguida, pressione <kbd>N</kbd>, insira o tamanho desejado (<em>1024M</em>) e selecione "swap space" no menu pop-up que aparece. Repita esse processo para cada journal que você deseja criar. No nosso exemplo, criaremos duas partições para fornecer os journals de <span class=filename>/usr</span> e <span class=filename>/var</span>. O resultado final é mostrado na captura de tela a seguir:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel2.png alt=disklabel2></div></div><div class=paragraph><p>Quando você tiver concluído a criação das partições, sugerimos que anote os nomes das partições e os pontos de montagem para que você possa se referir facilmente a essas informações durante a fase de configuração. Isso ajudará a evitar erros que possam danificar sua instalação. A tabela a seguir mostra nossas anotações para a configuração de exemplo:</p></div><table class="tableblock frame-all grid-all stretch"><caption class=title>Tabela 1. Partições e Journals</caption><col style=width:33.3333%><col style=width:33.3333%><col style=width:33.3334%><thead><tr><th class="tableblock halign-left valign-top">Partição</th><th class="tableblock halign-left valign-top">Ponto de Montagem</th><th class="tableblock halign-left valign-top">Journal</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1d</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/var</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1h</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1f</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/usr</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1g</p></td></tr></tbody></table><div class=paragraph><p>Continue a instalação como você normalmente faria. No entanto, sugerimos que você adie a instalação de softwares de terceiros (pacotes) até ter configurado completamente o journaling.</p></div></div><div class=sect2><h3 id=first-boot>3.2. Inicializando pela primeira vez<a class=anchor href=#first-boot></a></h3><div class=paragraph><p>Seu sistema inicializará normalmente, mas você precisará editar o arquivo <span class=filename>/etc/fstab</span> e remover as partições de swap extras que você criou para os journals. Normalmente, a partição de swap que você realmente usará é aquela com o sufixo "b" (por exemplo, ad0s1b em nosso exemplo). Remova todas as outras entradas de espaço de swap e reinicie para que o FreeBSD deixe de usá-las.</p></div><div class=paragraph><p>Quando o sistema voltar a funcionar, estaremos prontos para configurar o journaling.</p></div></div></div></div><div class=sect1><h2 id=configure-journal>4. Configurando o journaling<a class=anchor href=#configure-journal></a></h2><div class=sectionbody><div class=sect2><h3 id=running-gjournal>4.1. Executando o comando <code>gjournal</code><a class=anchor href=#running-gjournal></a></h3><div class=paragraph><p>Depois de preparar todas as partições necessárias, é bastante fácil configurar o journaling. Será necessário mudar para o modo de usuário único (single user mode). Para isso, faça o login como <code>root</code> e digite o seguinte comando:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Pressione <kbd>Enter</kbd> para obter o shell padrão. Agora, você precisará desmontar as partições que serão jornalizadas, no nosso exemplo <span class=filename>/usr</span> e <span class=filename>/var</span>:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Carregue o módulo necessário para o journaling:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span></code></pre></div></div><div class=paragraph><p>Agora, use suas anotações para determinar qual partição será usada para cada journal. No nosso exemplo, <span class=filename>/usr</span> é <span class=filename>ad0s1f</span> e seu journal será <span class=filename>ad0s1g</span>, enquanto <span class=filename>/var</span> é <span class=filename>ad0s1d</span> e será jornalizada em <span class=filename>ad0s1h</span>. Os seguintes comandos são necessários:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad0s1f ad0s1g</span>
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.

<span class=c># gjournal label ad0s1d ad0s1h</span>
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.</code></pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Se o último setor de qualquer uma das partições estiver em uso, o <code>gjournal</code> retornará um erro. Nesse caso, você precisará executar o comando usando a opção <code>-f</code> para forçar a sobrescrita. Por exemplo:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -f ad0s1d ad0s1h</span></code></pre></div></div><div class=paragraph><p>Como esta é uma nova instalação, é altamente improvável que qualquer coisa seja realmente sobrescrita.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Neste ponto, dois novos dispositivos são criados, chamados <span class=filename>ad0s1d.journal</span> e <span class=filename>ad0s1f.journal</span>. Eles representam as partições <span class=filename>/var</span> e <span class=filename>/usr</span> que devemos montar. No entanto, antes de montá-los, precisamos definir a flag de journaling neles e desativar a flag de Soft Updates:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J enable -n disable ad0s1d.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared

<span class=c># tunefs -J enable -n disable ad0s1f.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared</code></pre></div></div><div class=paragraph><p>Agora, monte manualmente os novos dispositivos em seus respectivos locais (observe que agora podemos usar a opção de montagem <code>async</code>):</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o async /dev/ad0s1d.journal /var</span>
<span class=c># mount -o async /dev/ad0s1f.journal /usr</span></code></pre></div></div><div class=paragraph><p>Edite o arquivo <span class=filename>/etc/fstab</span> e atualize as entradas para <span class=filename>/usr</span> e <span class=filename>/var</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f.journal     /usr            ufs     rw,async      2       2
/dev/ad0s1d.journal     /var            ufs     rw,async      2       2</pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>Certifique-se de que as entradas acima estão corretas ou você terá problemas para inicializar normalmente após o reboot!</p></div></td></tr></tbody></table></div><div class=paragraph><p>Por fim, edite o arquivo <span class=filename>/boot/loader.conf</span> e adicione a seguinte linha para carregar o módulo <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> em cada inicialização do sistema:</p></div><div class="literalblock programlisting"><div class=content><pre>geom_journal_load=&#34;YES&#34;</pre></div></div><div class=paragraph><p>Parabéns! Seu sistema está agora configurado para o journaling. Você pode digitar <code>exit</code> para retornar ao modo multiusuário ou reiniciar para testar sua configuração (recomendado). Durante a inicialização, você verá mensagens como as seguintes:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>ad0: 76293MB XEC XE800JD-00HBC0 08.02D08 at ata0-master SATA150
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.</code></pre></div></div><div class=paragraph><p>Após um encerramento não limpo, as mensagens variam ligeiramente, ou seja:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>GEOM_JOURNAL: Journal ad0s1d consistent.</code></pre></div></div><div class=paragraph><p>Isso geralmente significa que o <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> utilizou as informações no journal provider para restaurar o sistema de arquivos a um estado consistente.</p></div></div><div class=sect2><h3 id=gjournal-new>4.2. Fazendo journaling de partições recém-criadas<a class=anchor href=#gjournal-new></a></h3><div class=paragraph><p>Enquanto o procedimento acima é necessário para jornalizar partições que já contêm dados, jornalizar uma partição vazia é um pouco mais fácil, pois tanto o provedor de dados quanto o provedor de journal podem ser armazenados na mesma partição. Por exemplo, suponha que um novo disco tenha sido instalado e uma nova partição <span class=filename>/dev/ad1s1d</span> tenha sido criada. Criar o journal seria tão simples quanto:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad1s1d</span></code></pre></div></div><div class=paragraph><p>O tamanho do journal será de 1 GB por padrão. Você pode ajustá-lo usando a opção <code>-s</code>. O valor pode ser dado em bytes, ou pode ser seguido por <code>K</code>, <code>M</code> ou <code>G</code> para representar Kilobytes, Megabytes ou Gigabytes, respectivamente. Note que o <code>gjournal</code> não permitirá que você crie tamanhos de journal excessivamente pequenos e inadequados.</p></div><div class=paragraph><p>Por exemplo, para criar um journal de 2 GB, você poderia usar o seguinte comando:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -s 2G ad1s1d</span></code></pre></div></div><div class=paragraph><p>Em seguida, você pode criar um sistema de arquivos na sua nova partição e habilitar o journaling usando a opção <code>-J</code>:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># newfs -J /dev/ad1s1d.journal</span></code></pre></div></div></div><div class=sect2><h3 id=configure-kernel>4.3. Adicionando suporte ao journaling no seu kernel personalizado<a class=anchor href=#configure-kernel></a></h3><div class=paragraph><p>Se você não deseja carregar <code>geom_journal</code> como um módulo, você pode incorporar suas funções diretamente no seu kernel. Edite o arquivo de configuração do seu kernel personalizado e verifique se ele inclui as seguintes linhas:</p></div><div class="literalblock programlisting"><div class=content><pre>options UFS_GJOURNAL # Note: This is already in GENERIC

options GEOM_JOURNAL # You will have to add this one</pre></div></div><div class=paragraph><p>Recompile e reinstale o seu kernel seguindo as instruções relevantes no Handbook do FreeBSD</p></div><div class=paragraph><p>Não se esqueça de remover a entrada relevante de "load" do arquivo <span class=filename>/boot/loader.conf</span> se você a tiver usado anteriormente.</p></div></div></div></div><div class=sect1><h2 id=troubleshooting-gjournal>5. Solução de problemas com journaling<a class=anchor href=#troubleshooting-gjournal></a></h2><div class=sectionbody><div class=paragraph><p>A seção a seguir aborda as perguntas mais frequentes relacionadas a problemas relacionados ao journaling.</p></div><div class=sect2><h3 id=_estou_recebendo_um_kernel_panic_durante_períodos_de_alta_atividade_de_disco_como_isso_está_relacionado_ao_journaling>5.1. Estou recebendo um kernel panic durante períodos de alta atividade de disco. Como isso está relacionado ao journaling?<a class=anchor href=#_estou_recebendo_um_kernel_panic_durante_períodos_de_alta_atividade_de_disco_como_isso_está_relacionado_ao_journaling></a></h3><div class=paragraph><p>O journal provavelmente fica cheio antes de ter a chance de ser confirmado (gravado) no disco. Lembre-se de que o tamanho do journal depende da carga de uso e não do tamanho do provedor de dados. Se a atividade do disco for intensa, será necessário uma partição maior para o journal. Consulte a nota na seção <a href=#understanding-journaling>Compreendendo o Journaling</a> para mais informações.</p></div></div><div class=sect2><h3 id=_eu_cometi_algum_erro_durante_a_configuração_e_não_consigo_inicializar_normalmente_agora_isso_pode_ser_resolvido_de_alguma_forma>5.2. Eu cometi algum erro durante a configuração e não consigo inicializar normalmente agora. Isso pode ser resolvido de alguma forma?<a class=anchor href=#_eu_cometi_algum_erro_durante_a_configuração_e_não_consigo_inicializar_normalmente_agora_isso_pode_ser_resolvido_de_alguma_forma></a></h3><div class=paragraph><p>Parece que você esqueceu (ou digitou incorretamente) a entrada no arquivo <span class=filename>/boot/loader.conf</span> ou existem erros no arquivo <span class=filename>/etc/fstab</span>. Esses erros geralmente são fáceis de corrigir. Pressione <kbd>Enter</kbd> para acessar o shell do sistema no modo de usuário unico. Em seguida, localize a raiz do problema:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># cat /boot/loader.conf</span></code></pre></div></div><div class=paragraph><p>Se a entrada <code>geom_journal_load</code> estiver ausente ou digitada incorretamente, os dispositivos com journaling não serão criados. Carregue o módulo manualmente, monte todas as partições e continue com a inicialização em modo multiusuário:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span>

GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.

<span class=c># mount -a</span>
<span class=c># exit</span>
<span class=o>(</span>boot continues<span class=o>)</span></code></pre></div></div><div class=paragraph><p>Por outro lado, se essa entrada estiver correta, verifique o arquivo <span class=filename>/etc/fstab</span>. Provavelmente você encontrará uma entrada ausente ou digitada incorretamente. Nesse caso, monte todas as partições restantes manualmente e continue com a inicialização em modo multiusuário.</p></div></div><div class=sect2><h3 id=_posso_remover_o_registro_no_journal_e_retornar_ao_meu_sistema_de_arquivos_padrão_com_o_soft_updates>5.3. Posso remover o registro no journal e retornar ao meu sistema de arquivos padrão com o Soft Updates?<a class=anchor href=#_posso_remover_o_registro_no_journal_e_retornar_ao_meu_sistema_de_arquivos_padrão_com_o_soft_updates></a></h3><div class=paragraph><p>Claro. Use o seguinte procedimento, que reverte as alterações. As partições que você criou para os provedores de journal podem ser usadas para outros fins, se desejar.</p></div><div class=paragraph><p>Faça login como <code>root</code> e altere para o modo de usuário único:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Desmonte as partições journaled:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Sincronize os journals:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal sync</span></code></pre></div></div><div class=paragraph><p>Pare os provedores de journaling:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal stop ad0s1d.journal</span>
<span class=c># gjournal stop ad0s1f.journal</span></code></pre></div></div><div class=paragraph><p>Limpe os metadados de journaling de todos os dispositivos usados:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal clear ad0s1d</span>
<span class=c># gjournal clear ad0s1f</span>
<span class=c># gjournal clear ad0s1g</span>
<span class=c># gjournal clear ad0s1h</span></code></pre></div></div><div class=paragraph><p>Limpe o sinalizador de journaling do sistema de arquivos e restaure a flag do Soft Updates:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J disable -n enable ad0s1d</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span>

<span class=c># tunefs -J disable -n enable ad0s1f</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span></code></pre></div></div><div class=paragraph><p>Remonte os dispositivos antigos à mão:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o rw /dev/ad0s1d /var</span>
<span class=c># mount -o rw /dev/ad0s1f /usr</span></code></pre></div></div><div class=paragraph><p>Edite o arquivo <span class=filename>/etc/fstab</span> e restaure-o para seu estado original:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f     /usr            ufs     rw      2       2
/dev/ad0s1d     /var            ufs     rw      2       2</pre></div></div><div class=paragraph><p>Finalmente, edite o arquivo <span class=filename>/boot/loader.conf</span>, remova a entrada que carrega o módulo <code>geom_journal</code> e reinicie o sistema.</p></div></div></div></div><div class=sect1><h2 id=further-reading>6. Leitura Adicional<a class=anchor href=#further-reading></a></h2><div class=sectionbody><div class=paragraph><p>O journaling é um recurso relativamente novo no FreeBSD e, portanto, ainda não está muito bem documentado. No entanto, você pode encontrar as seguintes referências adicionais úteis:</p></div><div class=ulist><ul><li><p>A <a href=https://docs.freebsd.org/pt-br/books/handbook/book/#geom-gjournal>nova seção sobre journaling</a> agora faz parte do FreeBSD Handbook.</p></li><li><p><a href=https://lists.freebsd.org/pipermail/freebsd-current/2006-June/064043.html>Esta mensagem</a> na <a href=https://lists.FreeBSD.org/subscription/freebsd-current>lista de discussão do FreeBSD-CURRENT</a> enviada por um desenvolvedor do <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>'s, <code>Paweł Jakub Dawidek &lt;<a href=mailto:pjd@FreeBSD.org>pjd@FreeBSD.org</a>></code>.</p></li><li><p><a href=https://lists.freebsd.org/pipermail/freebsd-questions/2008-April/173501.html>Esta mensagem</a> na <a href=https://lists.FreeBSD.org/subscription/freebsd-questions>lista de discussão para perguntas gerais sobre o FreeBSD</a> enviada por <code>Ivan Voras &lt;<a href=mailto:ivoras@FreeBSD.org>ivoras@FreeBSD.org</a>></code>.</p></li><li><p>As páginas de manual <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> e <a href="https://man.freebsd.org/cgi/man.cgi?query=geom&amp;sektion=8&amp;format=html">geom(8)</a>.</p></li></ul></div></div></div><hr><div class=last-modified><p><strong>Última alteração em</strong>: 15 de maio de 2023 por <a href="https://cgit.freebsd.org/doc/commit/?id=655cf298ff" target=_blank>Edson Brandi</a></p></div></div><aside class=toc><div class=toc-content><h3>Índice</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Introdução</a></li><li><a href=#understanding-journaling>2. Compreendendo o journaling no FreeBSD</a></li><li><a href=#reserve-space>3. Etapas durante a instalação do FreeBSD</a></li><li><a href=#configure-journal>4. Configurando o journaling</a></li><li><a href=#troubleshooting-gjournal>5. Solução de problemas com journaling</a></li><li><a href=#further-reading>6. Leitura Adicional</a></li></ul></nav><hr><div class=resources><h3>Recursos</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/pt-br/articles/gjournal-desktop/gjournal-desktop_pt-br.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edite essa página"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/pt-br/_index target=_blank>Edite essa página</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/pt-br/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Escolha o idioma">
<span>Brazilian Portuguese</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>Alto contraste</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/pt-br class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/pt-br/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>