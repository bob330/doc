<!doctype html><html class=theme-light lang=ru><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/ru/articles/gjournal-desktop/><title>Настройка журналирования UFS для настольного компьютера. | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Настройка журналирования UFS для настольного компьютера."><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="ru"><meta property="og:url" content="http://172.16.201.134:1313/ru/articles/gjournal-desktop/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/ru\/articles\/gjournal-desktop\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>О нас
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>О нас</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>Фонд FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Кодекс Этики</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Получить FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Получить FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Информация о релизах</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Подготовка релизов</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Бюллетени Безопасности</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Документация
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/ru>Портал документации</a></li><li><a href=http://172.16.201.134:1313/ru/books/handbook>Руководство</a></li><li><a href=http://172.16.201.134:1313/ru/books/porters-handbook>Руководство по созданию портов</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Учебник Проекта Документирования</a></li><li><a href=https://man.FreeBSD.org target=_blank>Страницы Справочника</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Презентации и публикации</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/ru/books>Книги</a></li><li><a href=http://172.16.201.134:1313/ru/articles>Статьи</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Сообщество
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Сообщество</a></li><li><a href=http://172.16.201.134:1313/ru/articles/contributing>Стать участником</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Форум</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Списки рассылки</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>Каналы IRC</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Трекер ошибок</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Поддержка</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=ru>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Пожертвования</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Настройка журналирования UFS для настольного компьютера.</h1><div class="admonitionblock note"><p><i class="fa fa-exclamation-circle" aria-hidden=true></i>
Этот перевод может быть устаревшим. Для того, чтобы помочь с переводом, пожалуйста, обратитесь к <a href=https://translate-dev.freebsd.org/ target=_blank>Сервер переводов FreeBSD</a>.</p></div><div class=legalnotice><a id=trademarks></a><details><summary>товарные знаки</summary><p>FreeBSD является зарегистрированным товарным знаком Фонда FreeBSD.</p><p>Многие из обозначений, используемые производителями и продавцами для обозначения своих продуктов, заявляются в качестве товарных знаков. Когда такие обозначения появляются в этом документе, и Проекту FreeBSD известно о товарном знаке, к обозначению добавляется знак “™” или “®”.</p></details></div><div class=toc-mobile><h3>Содержание</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Вступление</a></li><li><a href=#understanding-journaling>2. Реализация журналирования в FreeBSD</a></li><li><a href=#reserve-space>3. Действия, необходимые во время установки FreeBSD</a></li><li><a href=#configure-journal>4. Настройка журналирования</a></li><li><a href=#troubleshooting-gjournal>5. Устранение неполадок с журналированием</a></li><li><a href=#further-reading>6. Для дальнейшего ознакомления</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Аннотация</p></div><div class=paragraph><p>Журналируемая файловая система использует лог для записи всех транзакций, происходящих в файловой системе, который также сохраняет ее целостность в случае краха системы или пропадания питания. Несмотря на то, что всё еще возможна потеря несохранённых изменений файлов, журналирование почти полностью исключает возможность повреждения структуры файловой системы, вызванное непредвиденным остановом работы. Журналирование также сокращает до минимума время, необходимое для проверки файловой системы после отказа. Несмотря на то, что в используемой FreeBSD файловой системе UFS нет поддержки журналирования, новый класс системы GEOM в FreeBSD 7.<em>X</em> может быть использован для для ведения независимого от файловой системы журналирования. Эта статья объясняет, как реализовать журналирование UFS для типичного настольного компьютера.</p></div><hr></div></div><div class=sect1><h2 id=introduction>1. Вступление<a class=anchor href=#introduction></a></h2><div class=sectionbody><div class=paragraph><p>Серверное оборудование обычно хорошо защищено от потери питания. Настольный компьютер часто подвержен неожиданным пропаданиям питания, случайным нажатиям кнопки Reset и другим происшествиям (часто связанным с неосторожностью пользователей), которые могут привести к непредвиденным выключениям. Механизм Soft Updates, как правило, достаточно эффективно защищает файловую систему в таких случаях, однако в последствии требуется длительная фоновая проверка. В очень редких случаях повреждения файловой системы достигают того уровня, при котором становится необходимым вмешательство пользователя и данные могут быть утерянными.</p></div><div class=paragraph><p>Новая возможность журналирования, предоставленная системой GEOM, может существенно выручить в подобных случаях, исключая время, необходимое для проверки файловых систем и удостовериваясь, что файловая система быстро восстановлена в целостное состояние.</p></div><div class=paragraph><p>Эта статья описывает порядок действий, необходимых для конфигурирования журналирования UFS на типичном настольном компьютере, в котором один жесткий диск используется для размещения как операционной системы, так и данных. В статье подразумевается установка FreeBSD "с нуля". Шаги достаточно просты и не требуют чрезмерно сложных манипуляций с командной строкой</p></div><div class=paragraph><p>После прочтения данной статьи вы будете знать:</p></div><div class=ulist><ul><li><p>Как зарезервировать место для журнала во время новой установки FreeBSD.</p></li><li><p>Как загрузить модуль <code>geom_journal</code> (или включить поддержку журналирования в специализированном ядре системы).</p></li><li><p>Как преобразовать существующую файловую систему, в систему, использующую журналирование, и какие опции монтирования использовать в <span class=filename>/etc/fstab</span>.</p></li><li><p>Как реализовать журналирование на новых (пустых) разделах.</p></li><li><p>Как диагностировать неполадки, связанные с журналированием.</p></li></ul></div><div class=paragraph><p>Перед прочтением этой статьи вам необходимо:</p></div><div class=ulist><ul><li><p>Понимать базовые концепции таких операционных систем, как UNIX® и FreeBSD.</p></li><li><p>Быть знакомым с процедурой установки FreeBSD, а также с программой Sysinstall.</p></li></ul></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>Процедура, описанная здесь, подразумевает подготовку к новой установке, в которой на дисках еще нет пользовательских данных. Так как эту процедуру можно модифицировать и расширить на системы, которые уже используются, вам настоятельно рекомендуется сделать <em>резервную копию</em> всех ценных данных. Путаница в низкоуровневых операциях с дисками и разделами может привести к фатальным ошибкам и потере данных.</p></div></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=understanding-journaling>2. Реализация журналирования в FreeBSD<a class=anchor href=#understanding-journaling></a></h2><div class=sectionbody><div class=paragraph><p>Журналирование, предоставляемое системой GEOM в FreeBSD 7.<em>X</em>, не является особенностью файловой системы (в отличие от, например, файловой системы ext3 в Linux®), оно функционирует на блочном уровне. А это значит, что оно может быть применено к разным типам файловых систем, однако для FreeBSD 7.0-RELEASE журналирование может быть применено только для UFS2.</p></div><div class=paragraph><p>Возможность журналирования обеспечивается загрузкой модуля <span class=filename>geom_journal.ko</span> в ядро (или сборкой собственного ядра с активированием соответствующих опций) и использованием команды <code>gjournal</code> для конфигурирования файловой системы. В общем, вы предпочтете журналировать файловые системы большого размера, к примеру - <span class=filename>/usr</span>. Однако, вам придется зарезервировать некоторое количество свободного места (см. следующий раздел).</p></div><div class=paragraph><p>Когда файловая система журналируется, некоторая часть дискового пространства требуется для хранения самого журнала. Дисковое пространство, содержащее данные, называется <em>поставщиком данных (data provider)</em>, а часть пространства, содержащая журнал, называется <em>поставщиком журнала (journal provider)</em>. Поставщики данных и журнала должны быть на разных разделах, если журналирование достраивается к содержащему данные разделу. А если журналирование включается для нового раздела, у вас есть возможность использовать один поставщик для данных и журнала. В любом из двух вышеупомянутых случаев команда <code>gjournal</code> задействует поставщики и создаст конечную журналируемую файловую систему. Например:</p></div><div class=ulist><ul><li><p>Вы намереваетесь журналировать файловую систему <span class=filename>/usr</span>, размещенную на <span class=filename>/dev/ad0s1f</span>, файловая система уже содержит данные.</p></li><li><p>Вы зарезервировали часть дискового пространства на разделе <span class=filename>/dev/ad0s1g</span>.</p></li><li><p>Используя команду <code>gjournal</code>, создаем новый файл устройства <span class=filename>/dev/ad0s1f.journal</span>, для которого <span class=filename>/dev/ad0s1f</span> является поставщиком данных, а <span class=filename>/dev/ad0s1g</span> - поставщик журнала. Это новое устройство необходимо использовать во всех последующих операциях.</p></li></ul></div><div class=paragraph><p>Размер дискового пространства, отводимого под поставщик журнала, зависит от нагруженности файловой системы, а не от размера самого поставщика данных. Например, для типичного настольного компьютера достаточно отвести 1 Гб под поставщик журнала для файловой системы <span class=filename>/usr</span>, в то время как компьютеру, имеющему интенсивный дисковый ввод/вывод (например, редактирование видео) может потребоваться больше. Если свободное место на поставщике журнала заканчивается раньше, чем происходит сброс журнала на диск, - вы получите панику ядра.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Очень маловероятно то, что размеры журнала, предложенные здесь, станут причиной проблем с обычным настольным компьютером (на котором вы просматриваете веб-страницы, обрабатываете текст или проигрываете мультимедийные файлы). Если работа вашего компьютера подразумевает интенсивную дисковую активность, то для обеспечения стабильности следует придерживаться следующего правила: размер ОЗУ должен уместиться в 30% размера, отведенного под журнал. Например, если в вашем компьютере установлен 1 Гб ОЗУ, создайте под поставщик журнала раздел размером около 3.3 Гб. (Умножьте размер ОЗУ в 3.3 раза, чтоб получить размер журнала).</p></div></td></tr></tbody></table></div><div class=paragraph><p>Для получения дополнительной информации о журналировании, пожалуйста, прочитайте страницу справочника, посвященную <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>.</p></div></div></div><div class=sect1><h2 id=reserve-space>3. Действия, необходимые во время установки FreeBSD<a class=anchor href=#reserve-space></a></h2><div class=sectionbody><div class=sect2><h3 id=_выделение_места_под_журналирование>3.1. Выделение места под журналирование<a class=anchor href=#_выделение_места_под_журналирование></a></h3><div class=paragraph><p>Типичный настольный компьютер обычно имеет один жесткий диск, на котором хранится как операционная система, так и пользовательские данные. Вероятно, что схема разбития винчестера (по умолчанию), выбранная в меню Sysinstall, является более или менее подходящей: настольному компьютеру не требуется большой раздел <span class=filename>/var</span>, в то время, как для раздела <span class=filename>/usr</span> выделяется значительный объем дискового пространства, ввиду того, что пользовательские данные и множество пэкэджей хранятся именно в поддиректориях <span class=filename>/usr</span>.</p></div><div class=paragraph><p>Разбиение по умолчанию (получаемое при нажатии <kbd>A</kbd> в редакторе разделов FreeBSD, называемом Disklabel) не оставляет свободного места. Каждый подлежащий журналированию раздел требует отдельного раздела для журнала. Ввиду того, что раздел <span class=filename>/usr</span> - наибольший, есть смысл немного уменьшить его размер, чтобы получить пространство, необходимое для журнала.</p></div><div class=paragraph><p>В нашем примере используется жесткий диск размером 80 Гб. Следующий скриншот показывает результаты разбиения по умолчанию, выполненного при помощи Disklabel в процессе установки операционной системы:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel1.png alt=disklabel1></div></div><div class=paragraph><p>Если это разбиение более или менее вас устраивает, то его легко модифицировать для журналирования. Используйте клавиши со стрелками для того, чтобы выделить раздел, отведенный под <span class=filename>/usr</span>, потом нажмите <kbd>D</kbd> чтобы удалить его.</p></div><div class=paragraph><p>Теперь переведите подсвечивание к имени диска, находящемуся вверху экрана, и нажмите <kbd>C</kbd> - создайте новый раздел <span class=filename>/usr</span>. Новый раздел должен быть меньше на 1 Гб (если вы собираетесь журналировать только <span class=filename>/usr</span>) или на 2 Гб (если журналированию подлежат как <span class=filename>/usr</span>, так и <span class=filename>/var</span>). Во всплывающем окне выберите "создать файловую систему" и укажите <span class=filename>/usr</span> точкой монтирования.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Следует ли журналировать <span class=filename>/var</span> раздел? Обычно есть смысл журналировать большие разделы. Вы можете решить не журналировать <span class=filename>/var</span>, однако журналирование на обычном настольном компьютере не причинит вреда. Если файловая система не нагружена (что типично для настольной системы), то можно выделить меньше дискового пространства под журнал.</p></div><div class=paragraph><p>В этом примере подразумевается журналирование двух файловых систем: <span class=filename>/usr</span> и <span class=filename>/var</span>. Естественно, вы можете подкорректировать процедуру под свои задачи.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Чтобы не усложнять описываемую методику, для создания разделов, необходимых для размещения журналов, мы будем использовать утилиту Sysinstall. Однако, во время установки утилита Sysinstall требует указания точек монтирования для каждого созданного вами раздела. Но разделы, содержащие журналы, вам никогда и никуда монтировать не придется.</p></div><div class=paragraph><p>Чтобы избежать вопросов о точках монтирования, мы создадим разделы под журналы и установим их тип в swap. Раздел, предназначенный для свопа, никогда и никуда не монтируется, плюс к тому, утилита Sysinstall позволяет создавать столько разделов под своп, сколько необходимо. После первой перезагрузки необходимо подредактировать файл <span class=filename>/etc/fstab</span>, удалив в нём лишние записи о своп-разделах.</p></div><div class=paragraph><p>Для создания своп-раздела, используя клавиши со стрелками, перемещайте подсвечивание к верхней части экрана в утилите Disklabel так, чтобы стало подсвеченным имя диска. Потом, нажмите <kbd>N</kbd>, введите необходимый размер раздела (<em>1024M</em>), а после - выберите во всплывшем окне "swap space". Повторите эти шаги для всех оставшихся журналов. В этом примере мы создаем два раздела, на которых будут размещаться журналы для <span class=filename>/usr</span> и <span class=filename>/var</span>. Конечный результат показан на следующем скриншоте:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel2.png alt=disklabel2></div></div><div class=paragraph><p>По завершении создания разделов мы рекомендуем вам записать на бумагу названия разделов и их точек монтирования: с этой информацией вы будете сверяться во время конфигурирования. Это также поможет уменьшить количество ошибок, приводящих к повреждению установки. Следующая табличка отображает наши заметки, сделанные для данного примера:</p></div><table class="tableblock frame-all grid-all stretch"><caption class=title>Таблица 1. Разделы и журналы</caption><col style=width:33.3333%><col style=width:33.3333%><col style=width:33.3334%><thead><tr><th class="tableblock halign-left valign-top">Раздел</th><th class="tableblock halign-left valign-top">Точка монтирования</th><th class="tableblock halign-left valign-top">Журнал</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1d</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/var</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1h</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1f</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/usr</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1g</p></td></tr></tbody></table><div class=paragraph><p>Дальше продолжайте обычную установку. Однако, мы рекомендуем вам отложить инсталляцию приложений сторонних разработчиков (пакетов) до полной настройки журналирования.</p></div></div><div class=sect2><h3 id=first-boot>3.2. Первая загрузка<a class=anchor href=#first-boot></a></h3><div class=paragraph><p>Ваша система загрузится нормально, однако вам необходимо будет подредактировать <span class=filename>/etc/fstab</span> и удалить те лишние своп-разделы, которые вы создавали под журналы. Как правило, в названии файла устройства, созданного автоматически утилитой Sysinstall, присутствует суффикс "b" (в нашем примере это ad0s1b). Удалите другие записи о своп-разделах и перезагрузите компьютер, после чего FreeBSD перестанет их использовать.</p></div><div class=paragraph><p>После второй перезагрузки, компьютер будет готов к конфигурированию журналирования.</p></div></div></div></div><div class=sect1><h2 id=configure-journal>4. Настройка журналирования<a class=anchor href=#configure-journal></a></h2><div class=sectionbody><div class=sect2><h3 id=running-gjournal>4.1. Работа с командой <code>gjournal</code><a class=anchor href=#running-gjournal></a></h3><div class=paragraph><p>Подготовив необходимые разделы, перейдем к конфигурированию журналирования. Нам будет необходимо загрузиться в однопользовательском режиме, для этого залогинимся пользователем <code>root</code> и напечатаем:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Нажмите <kbd>Enter</kbd> для получения приглашения командного интерпретатора. Нам необходимо будет размонтировать разделы, которые подлежат журналированию, в нашем примере это <span class=filename>/usr</span> и <span class=filename>/var</span>.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Загрузите модуль ядра, необходимый для журналирования:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span></code></pre></div></div><div class=paragraph><p>На данном этапе сверьтесь со своими записями и определите, какие разделы будут использоваться под какой журнал. В нашем примере <span class=filename>/usr</span> располагается на <span class=filename>ad0s1f</span>, а его журнал будет располагаться на <span class=filename>ad0s1g</span>, и, по аналогии, для <span class=filename>/var</span>: файловая система располагается на <span class=filename>ad0s1d</span>, а ее журнал - на <span class=filename>ad0s1h</span>. Наберите следующие команды:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad0s1f ad0s1g</span>
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.

<span class=c># gjournal label ad0s1d ad0s1h</span>
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.</code></pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Если последний сектор любого из двух разделов (поставщиков данных) используется, команда <code>gjournal</code> возвратит ошибку. Вам необходимо будет использовать флаг <code>-F</code> для принудительной перезаписи, например:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -f ad0s1d ad0s1h</span></code></pre></div></div><div class=paragraph><p>Так как это - новая установка, очень маловероятен факт, что что-нибудь будет действительно переписано.</p></div></td></tr></tbody></table></div><div class=paragraph><p>На данном этапе созданы два устройства: <span class=filename>ad0s1d.journal</span> и <span class=filename>ad0s1f.journal</span>. Они представляют <span class=filename>/var</span> и <span class=filename>/usr</span> соответственно. Перед монтированием, нам необходимо установить флаг журналирования и снять флаг механизма Soft Updates:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J enable -n disable ad0s1d.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared

<span class=c># tunefs -J enable -n disable ad0s1f.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared</code></pre></div></div><div class=paragraph><p>Теперь, смонтируйте новые устройства в соответствующие места файловой системы (обратите внимание на то, что мы можем использовать опцию монтирования <code>async</code>):</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o async /dev/ad0s1d.journal /var</span>
<span class=c># mount -o async /dev/ad0s1f.journal /usr</span></code></pre></div></div><div class=paragraph><p>Откройте <span class=filename>/etc/fstab</span> и исправьте записи для следующих файловых систем: <span class=filename>/usr</span> и <span class=filename>/var</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f.journal     /usr            ufs     rw,async      2       2
/dev/ad0s1d.journal     /var            ufs     rw,async      2       2</pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>Убедитесь, что упомянутые выше записи правильные, иначе старт системы будет проблематичным после перезагрузки!</p></div></td></tr></tbody></table></div><div class=paragraph><p>И напоследок, подредактируйте <span class=filename>/boot/loader.conf</span>: добавьте следующую строку и модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> будет загружаться автоматически при старте системы:</p></div><div class="literalblock programlisting"><div class=content><pre>geom_journal_load=&#34;YES&#34;</pre></div></div><div class=paragraph><p>Поздравляем! Журналирование успешно сконфигурировано. Вам необходимо лишь набрать <code>exit</code> для возвращения в многопользовательский режим или перезагрузить систему, чтобы полностью проверить вашу конфигурацию (рекомендуется). Во время загрузки вы увидите сообщения, подобные следующим:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>ad0: 76293MB XEC XE800JD-00HBC0 08.02D08 at ata0-master SATA150
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.</code></pre></div></div><div class=paragraph><p>После непредвиденного останова работы системы сообщения будут немного отличаться, например:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>GEOM_JOURNAL: Journal ad0s1d consistent.</code></pre></div></div><div class=paragraph><p>Это обычно значит, что <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> воспользовался информацией в журнале для возвращения файловой системы к целостному состоянию.</p></div></div><div class=sect2><h3 id=gjournal-new>4.2. Журналирование новых разделов<a class=anchor href=#gjournal-new></a></h3><div class=paragraph><p>Процедура, описанная выше, необходима для подключения журналирования разделов, содержащих данные. Журналирование пустых разделов немного проще, ввиду того, что поставщик данных и поставщик журнала могут быть размещены на одном и том же разделе. Например, предположим, что был установлен новый жесткий диск и был создан новый раздел <span class=filename>/dev/ad1s1d</span>. Создание журнала не сложнее набора:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad1s1d</span></code></pre></div></div><div class=paragraph><p>Размер журнала - 1 Гб по умолчанию. Однако, вы можете изменить это значение используя ключ <code>-s</code>. Значение можно задавать в байтах, в килобайтах, мегабайтах или гигабайтах (используя суффикс <code>K</code>, <code>M</code> или <code>G</code>). Имейте ввиду, что команда <code>gjournal</code> не позволит вам создать журнал недопустимо малого размера.</p></div><div class=paragraph><p>К примеру, чтобы создать журнал размером в 2Гб, можно использовать следующую команду:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -s 2G ad1s1d</span></code></pre></div></div><div class=paragraph><p>Далее, вы можете создать файловую систему на новом разделе, а также разрешить журналирование ключом <code>-J</code>:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># newfs -J /dev/ad1s1d.journal</span></code></pre></div></div></div><div class=sect2><h3 id=configure-kernel>4.3. Встраивание журналирования в специализированное ядро<a class=anchor href=#configure-kernel></a></h3><div class=paragraph><p>Если вы не желаете загружать <code>geom_journal</code> как модуль, то можно встроить его функции прямо в ваше специализированное ядро. Редактируя конфигурационный файл ядра, убедитесь, что в нем находятся следующие две строки:</p></div><div class="literalblock programlisting"><div class=content><pre>options UFS_GJOURNAL # Прим.: Это включено в GENERIC

options GEOM_JOURNAL # А эту строку необходимо добавить</pre></div></div><div class=paragraph><p>Соберите и установите новое ядро следуя указаниям <a href=https://docs.freebsd.org/ru/books/handbook/kernelconfig#kernelconfig>Руководства FreeBSD.</a></p></div><div class=paragraph><p>И не забудьте удалить соответствующую строку загрузки модуля ("load") из <span class=filename>/boot/loader.conf</span> (если на предыдущем этапе она была туда внесена).</p></div></div></div></div><div class=sect1><h2 id=troubleshooting-gjournal>5. Устранение неполадок с журналированием<a class=anchor href=#troubleshooting-gjournal></a></h2><div class=sectionbody><div class=paragraph><p>Этот раздел содержит часто задаваемые вопросы касательно неполадок, связанных с журналированием.</p></div><div class=sect2><h3 id=_я_получаю_паники_ядра_во_время_высокой_дисковой_активности_как_это_связано_с_журналированием>5.1. Я получаю паники ядра во время высокой дисковой активности. Как это связано с журналированием?<a class=anchor href=#_я_получаю_паники_ядра_во_время_высокой_дисковой_активности_как_это_связано_с_журналированием></a></h3><div class=paragraph><p>Вероятно, что журнал заполняется раньше, чем происходит сброс его на диск. Помните, размер журнала зависит от загруженности диска, а не от размера поставщика данных. Если загрузка диска высокая, вам потребуется раздел большего размера для журнала. См. замечания в разделе <a href=#understanding-journaling>Реализация журналирования в FreeBSD</a></p></div></div><div class=sect2><h3 id=_я_допустил_некоторые_ошибки_во_время_конфигурирования_теперь_система_не_загружается_можно_это_как_нибудь_исправить>5.2. Я допустил некоторые ошибки во время конфигурирования, теперь система не загружается. Можно это как-нибудь исправить?<a class=anchor href=#_я_допустил_некоторые_ошибки_во_время_конфигурирования_теперь_система_не_загружается_можно_это_как_нибудь_исправить></a></h3><div class=paragraph><p>Вы либо забыли внести запись (опечатались) в <span class=filename>/boot/loader.conf</span>, либо есть ошибки в файле <span class=filename>/etc/fstab</span>. Это легко исправить. Нажмите <kbd>Enter</kbd>, чтобы получить приглашение командного интерпретатора в однопользовательском режиме. Потом, проверьте возможные варианты:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># cat /boot/loader.conf</span></code></pre></div></div><div class=paragraph><p>Если отсутствует запись <code>geom_journal_load</code>, или она содержит ошибки, журналируемые устройства не создадутся. Загрузите модуль вручную, примонтируйте все разделы и переходите в многопользовательский режим (продолжайте загрузку).</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span>

GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.

<span class=c># mount -a</span>
<span class=c># exit</span>
<span class=o>(</span>boot continues<span class=o>)</span></code></pre></div></div><div class=paragraph><p>Если же запись о <code>geom_journal_load</code> верна, то проверьте <span class=filename>/etc/fstab</span>. Вероятней всего, что вы обнаружите опечатку или отсутствие необходимой записи. В этом случае смонтируйте вручную оставшиеся разделы и продолжите загрузку в многопользовательский режим.</p></div></div><div class=sect2><h3 id=_возможно_ли_отказаться_от_журналирования_и_вернуться_к_моей_привычной_файловой_системе_с_механизмом_soft_updates>5.3. Возможно ли отказаться от журналирования и вернуться к моей привычной файловой системе с механизмом Soft Updates?<a class=anchor href=#_возможно_ли_отказаться_от_журналирования_и_вернуться_к_моей_привычной_файловой_системе_с_механизмом_soft_updates></a></h3><div class=paragraph><p>Несомненно. Используйте приведенную ниже последовательность действий, которая обращает изменения. Разделы, созданные для поставщиков журналов, могут позже быть использованы для других целей.</p></div><div class=paragraph><p>Залогиньтесь <code>root</code> и переведите систему в однопользовательский режим:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Размонтируйте журналируемые разделы:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Синхронизируйте журналы:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal sync</span></code></pre></div></div><div class=paragraph><p>Остановите поставщиков журналов:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal stop ad0s1d.journal</span>
<span class=c># gjournal stop ad0s1f.journal</span></code></pre></div></div><div class=paragraph><p>Удалите метаданные журналирования со всех задействованных устройств:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal clear ad0s1d</span>
<span class=c># gjournal clear ad0s1f</span>
<span class=c># gjournal clear ad0s1g</span>
<span class=c># gjournal clear ad0s1h</span></code></pre></div></div><div class=paragraph><p>Снимите флаг журналирования и установите флаг механизма Soft Updates:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J disable -n enable ad0s1d</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span>

<span class=c># tunefs -J disable -n enable ad0s1f</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span></code></pre></div></div><div class=paragraph><p>Смонтируйте вручную старые (первоначальные) устройства:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o rw /dev/ad0s1d /var</span>
<span class=c># mount -o rw /dev/ad0s1f /usr</span></code></pre></div></div><div class=paragraph><p>Откройте файл <span class=filename>/etc/fstab</span> и приведите его к изначальному виду:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f     /usr            ufs     rw      2       2
/dev/ad0s1d     /var            ufs     rw      2       2</pre></div></div><div class=paragraph><p>И напоследок, удалите строку, загружающую модуль <code>geom_journal</code>, из файла <span class=filename>/boot/loader.conf</span> и перезагрузите операционную систему.</p></div></div></div></div><div class=sect1><h2 id=further-reading>6. Для дальнейшего ознакомления<a class=anchor href=#further-reading></a></h2><div class=sectionbody><div class=paragraph><p>Журналирование - относительно новая функциональная возможность FreeBSD, и как такова, она еще недостаточно документирована. Однако, вы можете сочти полезными следующие источники:</p></div><div class=ulist><ul><li><p>Новый <a href=https://docs.freebsd.org/ru/books/handbook/geom#geom-gjournal>раздел Руководства FreeBSD</a>, посвященный журналированию.</p></li><li><p><a href=http://lists.freebsd.org/pipermail/freebsd-current/2006-June/064043.html>Этот пост</a> в списке рассылки <a href=https://lists.FreeBSD.org/subscription/freebsd-current>Список рассылки, посвящённый обсуждению FreeBSD-CURRENT</a>, написанный <code>Paweł Jakub Dawidek &lt;<a href=mailto:pjd@FreeBSD.org>pjd@FreeBSD.org</a>></code> - автором <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>.</p></li><li><p><a href=http://lists.freebsd.org/pipermail/freebsd-questions/2008-April/173501.html>Этот пост</a> от <code>Ivan Voras &lt;<a href=mailto:ivoras@FreeBSD.org>ivoras@FreeBSD.org</a>></code> в списке рассылки <a href=https://lists.FreeBSD.org/subscription/freebsd-questions>Список рассылки, посвящённый вопросам и ответам пользователей FreeBSD</a>.</p></li><li><p>Страницы справочника <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> и <a href="https://man.freebsd.org/cgi/man.cgi?query=geom&amp;sektion=8&amp;format=html">geom(8)</a>.</p></li></ul></div></div></div><hr><div class=last-modified><p><strong>Изменено</strong>: 3 ноября 2021 г. by <a href="https://cgit.freebsd.org/doc/commit/?id=64acd169b8" target=_blank>Sergio Carlavilla Delgado</a></p></div></div><aside class=toc><div class=toc-content><h3>Содержание</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Вступление</a></li><li><a href=#understanding-journaling>2. Реализация журналирования в FreeBSD</a></li><li><a href=#reserve-space>3. Действия, необходимые во время установки FreeBSD</a></li><li><a href=#configure-journal>4. Настройка журналирования</a></li><li><a href=#troubleshooting-gjournal>5. Устранение неполадок с журналированием</a></li><li><a href=#further-reading>6. Для дальнейшего ознакомления</a></li></ul></nav><hr><div class=resources><h3>Материалы</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Скачать PDF"></i><a href=https://download.freebsd.org/doc/ru/articles/gjournal-desktop/gjournal-desktop_ru.pdf>Скачать PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Редактировать эту страницу"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/ru/_index target=_blank>Редактировать эту страницу</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/ru/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Выберите язык">
<span>Русский</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>Система</option><option value=theme-light>Светлый</option><option value=theme-dark>Тёмный</option><option value=theme-high-contrast>Высокая контрастность</option></select></div></div></section><section class=about-column><h3 class=column-title>О нас</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>Фонд FreeBSD</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Получить FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Кодекс Этики</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Бюллетени Безопасности</a></li></ul></section><section class=documentation-column><h3 class=column-title>Документация</h3><ul class=column-elements-container><li><a href=/ru class=column-element>Портал документации</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Страницы Справочника</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Презентации и публикации</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Предыдущие версии</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>Документы 4.4BSD</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Сообщество</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/ru/articles/contributing class=column-element>Принять участие</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Форум Сообщества</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Списки рассылки</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>Каналы IRC</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Трекер ошибок</a></li></ul></section><section class=legal-column><h3 class=column-title>Юридическая информация</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Пожертвования</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Лицензирование</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Политика Конфиденциальности</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Юридические оговорки</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 Проект FreeBSD. Все права защищены</p><span>Сделано с помощью <span class=heart>♥</span> Сообществом FreeBSD</span></section></div></footer></body></html>