<!doctype html><html class=theme-light lang=ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=https://docs.freebsd.org/ru/articles/pam/><title>Подключаемые Модули Аутентификации (PAM) | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=https://docs.freebsd.org/favicon.ico><link rel=stylesheet href=https://docs.freebsd.org/styles/main.min.css><link rel=stylesheet href=https://docs.freebsd.org/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Подключаемые Модули Аутентификации (PAM)"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:image" content="https://docs.freebsd.org/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="ru"><meta property="og:url" content="https://docs.freebsd.org/ru/articles/pam/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"https:\/\/docs.freebsd.org\/ru\/articles\/pam\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=https://docs.freebsd.org/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>О нас
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>О нас</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>Фонд FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Кодекс Этики</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Получить FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Получить FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Информация о релизах</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Подготовка релизов</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Бюллетени Безопасности</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Документация
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/ru>Портал документации</a></li><li><a href=https://docs.freebsd.org/ru/books/handbook>Руководство</a></li><li><a href=https://docs.freebsd.org/ru/books/porters-handbook>Руководство по созданию портов</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Учебник Проекта Документирования</a></li><li><a href=https://man.FreeBSD.org target=_blank>Страницы Справочника</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Презентации и публикации</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=https://docs.freebsd.org/ru/books>Книги</a></li><li><a href=https://docs.freebsd.org/ru/articles>Статьи</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Сообщество
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Сообщество</a></li><li><a href=https://docs.freebsd.org/ru/articles/contributing>Стать участником</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Форум</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Списки рассылки</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>Каналы IRC</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Трекер ошибок</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Поддержка</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=ru>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Пожертвования</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Подключаемые Модули Аутентификации (PAM)</h1><div class="admonitionblock note"><p><i class="fa fa-exclamation-circle" aria-hidden=true></i>
Этот перевод может быть устаревшим. Для того, чтобы помочь с переводом, пожалуйста, обратитесь к <a href=https://translate-dev.freebsd.org/ target=_blank>Сервер переводов FreeBSD</a>.</p></div><div class=legalnotice><a id=trademarks></a><details><summary>товарные знаки</summary><p>FreeBSD является зарегистрированным товарным знаком Фонда FreeBSD.</p><p>Эта статья была написана для Проекта FreeBSD компаниями ThinkSec AS и Network Associates Laboratories, входящей в Security Research Division of Network Associates, Inc., в рамках договора DARPA/SPAWAR N66001-01-C-8035 (“CBOSS”), как часть исследовательской программы DARPA CHATS.</p><p>Linux является торговым знаком Linus Torvalds.</p><p>Motif, OSF/1 и UNIX это зарегистрированные торговые марки, а IT DialTone и The Open Group это торговые марки Open Group в Соединенных Штатах и других странах.</p><p>Sun, Sun Microsystems, Java, Java Virtual Machine, JDK, JRE, JSP, JVM, Netra, Solaris, StarOffice, SunOS это торговые марки или зарегистрированные торговые марки Sun Microsystems, Inc. в Соединенных Штатах и других странах.</p><p>Многие из обозначений, используемые производителями и продавцами для обозначения своих продуктов, заявляются в качестве товарных знаков. Когда такие обозначения появляются в этом документе, и Проекту FreeBSD известно о товарном знаке, к обозначению добавляется знак “™” или “®”.</p></details></div><div class=toc-mobile><h3>Содержание</h3><nav id=TableOfContents><ul><li><a href=#pam-intro>1. Введение</a></li><li><a href=#pam-terms>2. Термины и соглашения</a></li><li><a href=#pam-definitions>3. Определения</a></li><li><a href=#pam-usage-examples>4. Примеры использования</a></li><li><a href=#_объединенные_клиент_и_сервер>5. Объединенные клиент и сервер</a></li><li><a href=#_клиент_и_сервер_разделены>6. Клиент и сервер разделены</a></li><li><a href=#_пример_политики>7. Пример политики</a></li><li><a href=#pam-essentials>8. Основы PAM</a></li><li><a href=#pam-facilities-primitives>9. Подсистемы и примитивы</a></li><li><a href=#pam-modules>10. Модули</a></li><li><a href=#pam-module-naming>11. Именование модулей</a></li><li><a href=#pam-module-versioning>12. Версии модулей</a></li><li><a href=#pam-chains-policies>13. Цепочки и политики</a></li><li><a href=#pam-transactions>14. Транзакции</a></li><li><a href=#pam-config>15. Настройка PAM</a></li><li><a href=#pam-config-file>16. Файлы политик PAM</a></li><li><a href=#pam-config-pam.conf>17. Файл <span class=filename>/etc/pam.conf</span></a></li><li><a href=#pam-config-pam.d>18. Каталог <span class=filename>/etc/pam.d</span></a></li><li><a href=#pam-config-file-order>19. Порядок поиска политик</a></li><li><a href=#pam-config-breakdown>20. Структура строки настройки</a></li><li><a href=#pam-policies>21. Политики</a></li><li><a href=#pam-freebsd-modules>22. Модули PAM во FreeBSD</a></li><li><a href=#pam-appl-prog>23. Программирование приложений с PAM</a></li><li><a href=#pam-module-prog>24. Программирование модуля PAM</a></li><li><a href=#pam-sample-appl>Приложение A: Пример PAM-приложения</a></li><li><a href=#pam-sample-module>Приложение B: Пример PAM-модуля</a></li><li><a href=#pam-sample-conv>Приложение C: Пример функции взаимодействия PAM</a></li><li><a href=#pam-further>Lectures complémentaires</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Abstract</p></div><div class=paragraph><p>В этой статье описываются принципы и механизмы, лежащие в основе библиотеки Подключаемых Модулей Аутентификации (PAM - Pluggable Authentication Modules), и рассказывается, как настроить PAM, как интегрировать PAM в приложения и как создавать модули PAM.</p></div><hr></div></div><div class=sect1><h2 id=pam-intro>1. Введение<a class=anchor href=#pam-intro></a></h2><div class=sectionbody><div class=paragraph><p>Библиотека Pluggable Authentication Modules (PAM) является обобщённым API для служб, связанных с аутентификацией, которые позволяют системному администратору добавлять новые методы аутентификации простой установкой новых модулей PAM, и изменять политику аутентификации посредством редактирования конфигурационных файлов.</p></div><div class=paragraph><p>PAM описали и разработали Vipin Samar и Charlie Lai из Sun Microsystems в 1995 году, с тех он сильно не менялся. В 1997 году Open Group опубликовала предварительные спецификации на X/Open Single Sign-on (XSSO), что стандартизовало API для PAM и добавило расширения для одноразовой (или достаточно интегрированной) подписи. На момент написания этого документа эта спецификация ещё не была принята за стандарт.</p></div><div class=paragraph><p>Хотя эта статья посвящена в основном FreeBSD 5.x, в которой используется OpenPAM, она подойдёт для FreeBSD 4.x, использующей Linux-PAM, и других операционных систем, таких, как Linux и Solaris™.</p></div></div></div><div class=sect1><h2 id=pam-terms>2. Термины и соглашения<a class=anchor href=#pam-terms></a></h2><div class=sectionbody></div></div><div class=sect1><h2 id=pam-definitions>3. Определения<a class=anchor href=#pam-definitions></a></h2><div class=sectionbody><div class=paragraph><p>Терминология, используемая в PAM, достаточно запутана. Ни оригинальная работа Samar и Lai, ни спецификация XSSO не делают никаких попыток формально определить термины для различных объектов и участвующих в PAM сторон, а термины, которые они используют (но не определяют) иногда неверны и неоднозначны. Первой попыткой создать недвусмысленную и согласованную терминологию была работа, которую написал Andrew G. Morgan (автор Linux-PAM) в 1999 году. Хотя выбор терминологии, которую сделал Морган, был гигантским скачком вперед, это, по мнению автора данной статьи, не означает ее правильность. Далее делается попытка, в значительной степени на основе работы Моргана, дать точные и недвусмысленные определения терминов для всех участников и объектов PAM.</p></div><div class="dlist glosslist"><dl><dt class=hdlist1>учётная запись (account)</dt><dd><p>Набор полномочий, которые аппликант запрашивает от арбитратора.</p></dd><dt class=hdlist1>аппликант (applicant)</dt><dd><p>Пользователь или объект, запрашивающие аутентификацию.</p></dd><dt class=hdlist1>арбитратор (arbitrator)</dt><dd><p>Пользователь или объект, имеющий привилегии, достаточные для проверки полномочий аппликанта и права подтвердить или отклонить запрос.</p></dd><dt class=hdlist1>цепочка (chain)</dt><dd><p>Последовательность модулей, которые будут вызваны в ответ на запрос PAM. В цепочку включена информация о последовательности вызовов модулей, аргументах, которые нужно им передать, и о том, как интерпретировать результаты.</p></dd><dt class=hdlist1>клиент (client)</dt><dd><p>Приложение, отвечающее за инициирование запроса на аутентификацию от имени аппликанта и получающее от него необходимую для аутентификации информацию.</p></dd><dt class=hdlist1>подсистема (facility)</dt><dd><p>Одна из четырех основных групп функциональности, которые дает PAM: аутентификация, управление учетными записями, управление сеансом и обновление ключом аутентификации.</p></dd><dt class=hdlist1>модуль (module)</dt><dd><p>Набор из одной или большего количества связанных функций, реализующих определенную подсистему аутентификации, собранный в один (обычно динамически загружаемый) двоичный файл, идентифицируемый по имени.</p></dd><dt class=hdlist1>политика (policy)</dt><dd><p>Полный набор конфигурационных деклараций, описывающих, как обрабатывать запросы PAM к определенной услуге. Политика обычно состоит из четырех цепочек, по одной для каждой подсистемы, хотя некоторые службы используют не все четыре подсистемы.</p></dd><dt class=hdlist1>сервер (server)</dt><dd><p>Приложение, выступающее от имени арбитратора для общения с клиентом, запрашивания аутентификационной информации, проверки полномочий аппликанта и подтверждающее или отклоняющее запрос.</p></dd><dt class=hdlist1>сервис (service)</dt><dd><p>Класс серверов, предоставляющих похожую или связанную функциональность, и требующую подобную аутентификацию. Политики PAM задаются на основе сервисов, так что ко всем серверам, объявляющим одно и тоже имя сервиса, будет применяться одна и та же политика.</p></dd><dt class=hdlist1>сеанс (session)</dt><dd><p>Контекст, в котором сервис оказывается аппликанту сервером. Одна из четырех подсистем PAM, управление сеансом, касается исключительно настройке и очистке этого контекста.</p></dd><dt class=hdlist1>ключ (token)</dt><dd><p>Блок информации, связанный с учётной записью, например, пароль или ключевая фраза, которую аппликант должен предоставить для своей идентификации.</p></dd><dt class=hdlist1>транзакция (transaction)</dt><dd><p>Последовательность запросов от одного и того же аппликанта к одному и тому же экземпляру того же самого сервера, начиная с аутентификации и установления сеанса и заканчивая закрытием сеанса.</p></dd></dl></div></div></div><div class=sect1><h2 id=pam-usage-examples>4. Примеры использования<a class=anchor href=#pam-usage-examples></a></h2><div class=sectionbody><div class=paragraph><p>Этот раздел предназначен для иллюстрации значений некоторых терминов, определенных выше, при помощи простых примеров.</p></div></div></div><div class=sect1><h2 id=_объединенные_клиент_и_сервер>5. Объединенные клиент и сервер<a class=anchor href=#_объединенные_клиент_и_сервер></a></h2><div class=sectionbody><div class=paragraph><p>В этом простом примере показывается пользователь <code>alice</code>, выполняющий команду <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> для того, чтобы стать пользователем <code>root</code>.</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% <span class=nb>whoami
</span>alice

% <span class=nb>ls</span> <span class=nt>-l</span> <span class=sb>`</span>which su<span class=sb>`</span>
<span class=nt>-r-sr-xr-x</span>  1 root  wheel  10744 Dec  6 19:06 /usr/bin/su

% su -
Password: xi3kiune
<span class=c># whoami</span>
root</code></pre></div></div><div class=ulist><ul><li><p>Аппликантом является <code>alice</code>.</p></li><li><p>Учетной записью является <code>root</code>.</p></li><li><p>Процесс <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> является как клиентом, так и сервером.</p></li><li><p>Аутентификационным ключом является <code>xi3kiune</code>.</p></li><li><p>Арбитратором выступает <code>root</code>, и именно поэтому у команды <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> выставлен бит выполнения с правами <code>root</code>.</p></li></ul></div></div></div><div class=sect1><h2 id=_клиент_и_сервер_разделены>6. Клиент и сервер разделены<a class=anchor href=#_клиент_и_сервер_разделены></a></h2><div class=sectionbody><div class=paragraph><p>В примере ниже рассматривается пользователь <code>eve</code>, пытающийся установить <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a>-соединение с <code>login.example.com</code>, и успешно входя как пользователь <code>bob</code>. Боб должен был выбрать пароль получше!</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% <span class=nb>whoami
</span>eve

% ssh bob@login.example.com
bob@login.example.com<span class=s1>&#39;s password:
% god
Last login: Thu Oct 11 09:52:57 2001 from 192.168.0.1
Copyright (c) 1980, 1983, 1986, 1988, 1990, 1991, 1993, 1994
        The Regents of the University of California.  All rights reserved.
FreeBSD 4.4-STABLE (LOGIN) 4: Tue Nov 27 18:10:34 PST 2001

Welcome to FreeBSD!
%
%
</span></code></pre></div></div><div class=ulist><ul><li><p>Аппликантом является <code>eve</code>.</p></li><li><p>Клиентом является процесс <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh&amp;sektion=1&amp;format=html">ssh(1)</a> пользователя Eve.</p></li><li><p>Сервером является процесс <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a> на машине <code>login.example.com</code></p></li><li><p>Учетной записью является <code>bob</code>.</p></li><li><p>Ключом аутентификации является <code>god</code>.</p></li><li><p>Хотя этого не видно в примере, но арбитратором является <code>root</code>.</p></li></ul></div></div></div><div class=sect1><h2 id=_пример_политики>7. Пример политики<a class=anchor href=#_пример_политики></a></h2><div class=sectionbody><div class=paragraph><p>Следующее является политикой, используемой во FreeBSD по умолчанию для <code>sshd</code>:</p></div><div class="literalblock programlisting"><div class=content><pre>sshd   auth            required        pam_nologin.so  no_warn
sshd   auth            required        pam_unix.so     no_warn try_first_pass
sshd   account         required        pam_login_access.so
sshd   account         required        pam_unix.so
sshd   session         required        pam_lastlog.so  no_fail
sshd   password        required        pam_permit.so</pre></div></div><div class=ulist><ul><li><p>Эта политика применяется к службе <code>sshd</code> (что не обязательно ограничено сервером <a href="https://man.freebsd.org/cgi/man.cgi?query=sshd&amp;sektion=8&amp;format=html">sshd(8)</a>).</p></li><li><p><code>auth</code>, <code>account</code>, <code>session</code> и <code>password</code> являются подсистемами.</p></li><li><p><span class=filename>pam_nologin.so</span>, <span class=filename>pam_unix.so</span>, <span class=filename>pam_login_access.so</span>, <span class=filename>pam_lastlog.so</span> и <span class=filename>pam_permit.so</span> являются модулями. Из этого примера видно, что <span class=filename>pam_unix.so</span> реализует по крайней мере две подсистемы (аутентификацию и управление учётными записями).</p></li></ul></div></div></div><div class=sect1><h2 id=pam-essentials>8. Основы PAM<a class=anchor href=#pam-essentials></a></h2><div class=sectionbody></div></div><div class=sect1><h2 id=pam-facilities-primitives>9. Подсистемы и примитивы<a class=anchor href=#pam-facilities-primitives></a></h2><div class=sectionbody><div class=paragraph><p>API для PAM предоставляет шесть различных примитивов для аутентификации, сгруппированных в четыре подсистемы, каждая из которых описывается ниже.</p></div><div class=dlist><dl><dt class=hdlist1><code>auth</code></dt><dd><p><em>Аутентификация.</em> Эта подсистема, собственно говоря, реализует аутентификацию аппликанта и выяснение полномочий учётной записи. Она предоставляет два примитива:</p><div class=ulist><ul><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3&amp;format=html">pam_authenticate(3)</a> аутентифицирует аппликанта, обычно запрашивая аутентификационный ключ и сравнивая его со значением, хранящимся в базе данных или получаемым от сервера аутентификации.</p></li><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3&amp;format=html">pam_setcred(3)</a> устанавливает полномочия учётной записи, такие, как идентификатор пользователя, членство в группах и ограничения на использование ресурсов.</p></li></ul></div></dd><dt class=hdlist1><code>account</code></dt><dd><p><em>Управление учётной записью.</em> Эта подсистема обрабатывает вопросы доступности учетной записи, не связанные с аутентификацией, такие, как ограничения в доступе на основе времени суток или загрузки сервера. Он предоставляет единственный примитив:</p><div class=ulist><ul><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;format=html">pam_acct_mgmt(3)</a> проверяет, доступна ли запрашиваемая учётная запись.</p></li></ul></div></dd><dt class=hdlist1><code>session</code></dt><dd><p><em>Управление сеансом.</em> Эта подсистема отрабатывает задачи, связанные с установлением и закрытием сеанса, такие, как учет входов пользователей. Она предоставляет два примитива:</p><div class=ulist><ul><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3&amp;format=html">pam_open_session(3)</a> выполняет действия, связанные с установлением сеанса: добавление записей в базы данных <span class=filename>utmp</span> и <span class=filename>wtmp</span>, запуск агента SSH и так далее.</p></li><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3&amp;format=html">pam_close_session(3)</a> выполняет действия, связанные с закрытием сеанса: добавление записей в базы данных <span class=filename>utmp</span> и <span class=filename>wtmp</span>, завершение работы агента SSH и так далее.</p></li></ul></div></dd><dt class=hdlist1><code>password</code></dt><dd><p><em>Управление паролем.</em> Эта подсистема используется для изменения ключа аутентификации, связанного с учетной записью, по причине истечения его срока действия или желания пользователя изменить его. Она предоставляет единственный примитив:</p><div class=ulist><ul><li><p>Функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3&amp;format=html">pam_chauthtok(3)</a> изменяет ключ аутентификации, опционально проверяя, что он труден для подбора, не использовался ранее и так далее.</p></li></ul></div></dd></dl></div></div></div><div class=sect1><h2 id=pam-modules>10. Модули<a class=anchor href=#pam-modules></a></h2><div class=sectionbody><div class=paragraph><p>Модули являются центральной концепцией в PAM; в конце концов, им соответствует буква "M" в сокращении "PAM". Модуль PAM представляет собой самодостаточный кусок программного кода, который реализует примитивы одной или большего количества подсистем одного конкретного механизма; к возможным механизмам для подсистемы аутентификации, к примеру, относятся базы данных паролей UNIX®, системы NIS, LDAP или Radius.</p></div></div></div><div class=sect1><h2 id=pam-module-naming>11. Именование модулей<a class=anchor href=#pam-module-naming></a></h2><div class=sectionbody><div class=paragraph><p>Во FreeBSD каждый механизм реализуется в отдельном модуле с именем <code>pam_mechanism.so</code> (например, <code>pam_unix.so</code> для механизма UNIX®.) В других реализациях иногда отдельные модули используются для разных подсистем, и в их имя включается, кроме названия механизма, и имя подсистемы. К примеру, в Solaris™ имеется модуль <code>pam_dial_auth.so.1</code>, который часто используется для аутентификации пользователей, работающих по коммутируемым каналам связи.</p></div></div></div><div class=sect1><h2 id=pam-module-versioning>12. Версии модулей<a class=anchor href=#pam-module-versioning></a></h2><div class=sectionbody><div class=paragraph><p>Изначальная реализация PAM во FreeBSD, которая была основана на Linux-PAM, не использовала номера версий для модулей PAM. Это будет приводить к проблемам при работе унаследованных приложений, которые могут быть скомпонованы со старыми версиями системных библиотек, так как способа подгрузить соответствующую версию требуемых модулей нет.</p></div><div class=paragraph><p>OpenPAM, с другой стороны, ищет модули, которые имеют тот же самый номер версии, что и библиотека PAM (на данный момент 2), и использует модуль без версии, только если модуль с известной версией не был загружен. Поэтому для старых приложений могут предоставляться старые модули, при этом новые (или заново построенные) приложения будут использовать все возможности последних версий модулей.</p></div><div class=paragraph><p>Хотя модули PAM в Solaris™ имеют номер версии, по-настоящему номер версии в них не отслеживается, потому что номер является частью имени и должен включаться в конфигурацию.</p></div></div></div><div class=sect1><h2 id=pam-chains-policies>13. Цепочки и политики<a class=anchor href=#pam-chains-policies></a></h2><div class=sectionbody><div class=paragraph><p>Когда сервер инициирует PAM-транзакцию, библиотека PAM пытается загрузить политику для службы, указанной при вызове функции <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_start&amp;sektion=3&amp;format=html">pam_start(3)</a>. Политика определяет, как должны обрабатываться запросы на аутентификацию, и задаётся в конфигурационном файле. Это составляет другую основополагающую концепцию PAM: возможность администратору настраивать политику безопасности системы (в самом широком её понимании) простым редактированием текстового файла.</p></div><div class=paragraph><p>Политика состоит из четырёх цепочек, по одной на каждый из методов PAM. Каждое звено представляет собой последовательность конфигурационных утверждений, задающих вызываемый модуль, некоторые (необязательные) параметры для передачи в модуль, и управляющий флаг, описывающий, как интерпретировать возвращаемый из модуля код.</p></div><div class=paragraph><p>Понимание смысла управляющего флага необходимо для понимания конфигурационных файлов PAM. Существуют четыре различных управляющих флага:</p></div><div class=dlist><dl><dt class=hdlist1><code>binding</code></dt><dd><p>Если модуль отработал успешно, и ни один из предыдущих модулей в цепочке не сработал отрицательно, то цепочка прерывается, а запрос подтверждается. Если же модуль отработает неудачно, то выполняется оставшаяся часть цепочки, однако запрос отвергается.</p><div class=paragraph><p>Этот управляющий флаг был добавлен компанией Sun в Solaris™ 9 (SunOS™ 5.9), и поддерживается в OpenPAM.</p></div></dd><dt class=hdlist1><code>required</code></dt><dd><p>Если модуль возвратил положительный ответ, выполняется оставшаяся часть цепочки, запрос удовлетворяется, если никакой другой модуль не отработает отрицательно. Если же модуль возвратит отрицательный ответ, остаток цепочки тоже отрабатывается, но запрос отвергается.</p></dd><dt class=hdlist1><code>requisite</code></dt><dd><p>Если модуль возвращает положительный ответ, выполняется оставшаяся часть цепочки, запрос удовлетворяется, если никакой другой модуль не отработает отрицательно. Если же модуль отрабатывает отрицательно, то отработка цепочки немедленно прекращается, а запрос отвергается.</p></dd><dt class=hdlist1><code>sufficient</code></dt><dd><p>Если модуль возвратит положительный ответ, и ни один из предыдущих модулей в цепочке на отработал отрицательно, то отработка цепочки немедленно прекращается, а запрос удовлетворяется. Если модуль отработал отрицательно, то результат игнорируется и цепочка отрабатывается дальше.</p><div class=paragraph><p>Так как семантика этого флага может оказаться запутанной, особенно при его использовании с последним модулем в цепочке, рекомендуется вместо него использовать управляющий флаг <code>binding</code>, если реализация его поддерживает.</p></div></dd><dt class=hdlist1><code>optional</code></dt><dd><p>Модуль отрабатывается, но результат выполнения игнорируется. Если все модули в цепочке помечены как <code>optional</code>, то удовлетворяться будут все запросы.
Когда сервер вызывает один из шести PAM-примитивов, PAM запрашивает цепочку подсистемы, к которой принадлежит примитив, и запускает каждый модуль, перечисленный в цепочке в порядке их перечисления, пока список не будет исчерпан либо не будет определено, что дальнейшей обработки не нужно (по причине достижение модуля, вернувшего положительный ответ при условии <code>binding</code> или <code>sufficient</code>, либо отрицательный с условием <code>requisite</code>). Запрос подтверждается, если только был вызван по крайней мере один модуль, и все неопциональные модули вернули положительный ответ.</p></dd></dl></div><div class=paragraph><p>Заметьте, что возможно, хотя это не распространено, перечислять один и тот же модуль несколько раз в одной цепочке. К примеру, модуль, просматривающий имена и пароли пользователя в сервере каталога может быть вызван несколько раз с различными параметрами, задающими различные серверы каталогов для связи. PAM считает различные появления одного модуля в той же самой цепочке разными и не связанными модулями.</p></div></div></div><div class=sect1><h2 id=pam-transactions>14. Транзакции<a class=anchor href=#pam-transactions></a></h2><div class=sectionbody><div class=paragraph><p>Жизненный цикл типичной PAM-транзакции описан ниже. Заметьте, что в случае, если любой из перечисленных шагов оканчивается неудачно, сервер должен выдать клиенту соответствующее сообщение об ошибке и прервать транзакцию.</p></div><div class="olist arabic"><ol class=arabic><li><p>Если это необходимо, сервер получает полномочия арбитратора через независимый от PAM механизм-чаще всего по факту запуска пользователем <code>root</code> или с установленным setuid-битом <code>root</code>.</p></li><li><p>Сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_start&amp;sektion=3&amp;format=html">pam_start(3)</a> для инициализации библиотеки PAM и задания имени сервиса и целевой учётной записи, а также регистрации подходящего способа общения.</p></li><li><p>Сервер получает различную информацию, относящуюся к транзакции (такую, как имя пользователя аппликанта и имя хоста, на котором запущен клиент), и отправляет её в PAM при помощи функции <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_set_item&amp;sektion=3&amp;format=html">pam_set_item(3)</a>.</p></li><li><p>Сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_authenticate&amp;sektion=3&amp;format=html">pam_authenticate(3)</a> для аутентификации аппликанта.</p></li><li><p>Сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;format=html">pam_acct_mgmt(3)</a> для проверки того, что запрошенная учётная запись доступна и корректна. Если пароль верен, но его срок истёк, <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_acct_mgmt&amp;sektion=3&amp;format=html">pam_acct_mgmt(3)</a> возвратит результат <code>PAM_NEW_AUTHTOK_REQD</code>, а не <code>PAM_SUCCESS</code>.</p></li><li><p>Если на предыдущем шаге был получен результат <code>PAM_NEW_AUTHTOK_REQD</code>, то сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3&amp;format=html">pam_chauthtok(3)</a> для того, чтобы вынудить клиента изменить ключ аутентификации для запрошенной учётной записи.</p></li><li><p>Теперь, когда аппликант полностью аутентифицирован, сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3&amp;format=html">pam_setcred(3)</a> для получения полномочий запрошенной учётной записи. Сделать это возможно, потому что он работает как арбитратор, и оставляет за собой полномочия арбитратора.</p></li><li><p>После получения необходимых полномочий, сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_open_session&amp;sektion=3&amp;format=html">pam_open_session(3)</a> для установления сеанса.</p></li><li><p>Теперь сервер выполняет тот сервис, который затребовал клиент-например, предоставляет аппликанту оболочку.</p></li><li><p>После того, как сервер закончил обслуживание клиента, он вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_close_session&amp;sektion=3&amp;format=html">pam_close_session(3)</a> для закрытия сеанса.</p></li><li><p>Наконец, сервер вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_end&amp;sektion=3&amp;format=html">pam_end(3)</a> для оповещения библиотеки PAM о том, что работа с ней завершена и какие-либо выделенные в течение сеанса ресурсы можно освободить.</p></li></ol></div></div></div><div class=sect1><h2 id=pam-config>15. Настройка PAM<a class=anchor href=#pam-config></a></h2><div class=sectionbody></div></div><div class=sect1><h2 id=pam-config-file>16. Файлы политик PAM<a class=anchor href=#pam-config-file></a></h2><div class=sectionbody></div></div><div class=sect1><h2 id=pam-config-pam.conf>17. Файл <span class=filename>/etc/pam.conf</span><a class=anchor href=#pam-config-pam.conf></a></h2><div class=sectionbody><div class=paragraph><p>Традиционно файлом политик PAM является <span class=filename>/etc/pam.conf</span>. Он содержит все политики PAM для вашей системы. Каждая строка файла описывает один шаг в цепочке, как показано ниже:</p></div><div class="literalblock programlisting"><div class=content><pre>login   auth    required        pam_nologin.so  no_warn</pre></div></div><div class=paragraph><p>Поля следуют в таком порядке: имя службы, имя подсистемы, управляющий флаг, имя модуля и параметры модуля. Любые дополнительные поля интерпретируются как дополнительные параметры модуля.</p></div><div class=paragraph><p>Для каждой пары сервис/подсистема составляется отдельная цепочка, и тогда получается, что, хотя порядок следования строк для одной и той же услуги и подсистемы является значимым, порядок перечисления отдельных сервисов не значим. В примерах из оригинальной работы по PAM строки конфигурации сгруппированы по подсистемам, в поставляемом с Solaris™ файле <span class=filename>pam.conf</span> именно так и сделано, но в стандартном конфигурационном файле из поставки FreeBSD строки настроек сгруппированы по сервисам. Подходит любой из этих способов; они имеют один и тот же смысл.</p></div></div></div><div class=sect1><h2 id=pam-config-pam.d>18. Каталог <span class=filename>/etc/pam.d</span><a class=anchor href=#pam-config-pam.d></a></h2><div class=sectionbody><div class=paragraph><p>OpenPAM и Linux-PAM поддерживают альтернативный механизм настройки, который для FreeBSD является предпочтительным. В этой схеме каждая политика содержится в отдельном файле с именем, соответствующем сервису, к которому она применяется. Эти файлы размещаются в каталоге <span class=filename>/etc/pam.d/</span>.</p></div><div class=paragraph><p>Такие файлы политик, ориентированные на сервисы, имеют только четыре поля, вместо пяти полей в файле <span class=filename>pam.conf</span>: поле имени сервиса опущено. Таким образом, вместо примера строки файла <span class=filename>pam.conf</span> из предыдущего раздела получится следующая строка в файле <span class=filename>/etc/pam.d/login</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>auth    required        pam_nologin.so  no_warn</pre></div></div><div class=paragraph><p>Как следствие такого упрощённого синтаксиса, возможно использование одних и тех же политик для нескольких сервисов, связывая каждое имя сервиса с тем же самым файлом политик. К примеру, для использования той же самой политики для сервисов <code>su</code> и <code>sudo</code>, можно сделать следующее:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># cd /etc/pam.d</span>
<span class=c># ln -s su sudo</span></code></pre></div></div><div class=paragraph><p>Это работает, потому что имя сервиса определяется именем файла, а не его указанием в файле политики, так что один и тот же файл может использоваться для нескольких сервисов с разными названиями.</p></div><div class=paragraph><p>Так как политика каждого сервиса хранится в отдельном файле, то механизм <span class=filename>pam.d</span> делает установку дополнительных политик для программных пакетов сторонних разработчиков очень лёгкой задачей.</p></div></div></div><div class=sect1><h2 id=pam-config-file-order>19. Порядок поиска политик<a class=anchor href=#pam-config-file-order></a></h2><div class=sectionbody><div class=paragraph><p>Как вы видели выше, политики PAM могут находиться в нескольких местах. Что будет, если политики для одного и того же сервиса имеются в разных местах?</p></div><div class=paragraph><p>Необходимо осознать, что система конфигурации PAM ориентирована на цепочки.</p></div></div></div><div class=sect1><h2 id=pam-config-breakdown>20. Структура строки настройки<a class=anchor href=#pam-config-breakdown></a></h2><div class=sectionbody><div class=paragraph><p>Как это объяснено в <a href=#pam-config-file>Файлы политик PAM</a>, каждая строка файла <span class=filename>/etc/pam.conf</span> состоит из четырёх или большего количества полей: имени сервиса, имени подсистемы, управляющего флага, имени модуля и дополнительных параметров модуля, которые могут отсутствовать.</p></div><div class=paragraph><p>Имя сервиса обычно (хотя не всегда) является именем приложения, которое этот сервис обслуживает. Если вы не уверены, обратитесь к документации по конкретному приложению для определения используемого имени сервиса.</p></div><div class=paragraph><p>Заметьте, что если вы используете <span class=filename>/etc/pam.d/</span> вместо <span class=filename>/etc/pam.conf</span>, то имя сервиса задается именем файла политики, и опускается из строк настройки, которые в таком случае начинаются с названия подсистемы.</p></div><div class=paragraph><p>Имя подсистемы представляет собой одно из четырёх ключевых слов, описанных в <a href=#pam-facilities-primitives>Подсистемы и примитивы</a>.</p></div><div class=paragraph><p>Точно также управляющий флаг является одним из четырёх ключевых слов, описанных в <a href=#pam-chains-policies>Цепочки и политики</a>, в котором рассказано, как интерпретировать возвращаемый из модуля код. В Linux-PAM поддерживается альтернативный синтаксис, который позволяет указать действие, связанной с каждый возможным кодом возврата, но этого следует избегать, так как он не является стандартным и тесно связан со способом диспетчеризации вызовов сервисов в Linux-PAM (а он значительно отличается от способа взаимодействия в Solaris™ и OpenPAM). Не вызывает удивления тот факт, что в OpenPAM этот синтаксис не поддерживается.</p></div></div></div><div class=sect1><h2 id=pam-policies>21. Политики<a class=anchor href=#pam-policies></a></h2><div class=sectionbody><div class=paragraph><p>Для корректной настройки PAM необходимо понимать, как происходит интерпретация политик.</p></div><div class=paragraph><p>В момент, когда приложение вызывает функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_start&amp;sektion=3&amp;format=html">pam_start(3)</a>, библиотека PAM загружает политику для указанного сервиса и выстраивает четыре цепочки модулей (по одной для каждой подсистемы). Если одна или большее количество этих цепочек являются пустыми, то будут выполняться подстановки соответствующих цепочек из политики для сервиса <code>other</code>.</p></div><div class=paragraph><p>Когда затем приложение вызывает одну из шести примитивов PAM, библиотека PAM выделяет из цепочки нужную подсистему и вызывает функцию, соответствующую сервису, в каждом модуле, перечисленном в цепочке, в том порядке, в каком они перечислены в конфигурации. После каждого обращения к функции сервиса, тип модуля и возвращённый из этой функции код результата выполнения используются для того, что делать дальше. За некоторыми исключениями, которые будут описаны ниже, применяется такая таблица:</p></div><table class="tableblock frame-all grid-all stretch"><caption class=title>Таблица 1. Сводная таблица отработки цепочек PAM</caption><col style=width:25%><col style=width:25%><col style=width:25%><col style=width:25%><thead><tr><th class="tableblock halign-left valign-top"></th><th class="tableblock halign-left valign-top">PAM_SUCCESS</th><th class="tableblock halign-left valign-top">PAM_IGNORE</th><th class="tableblock halign-left valign-top">other</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class=tableblock>binding</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>if (!fail) break;</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>fail = true;</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>required</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>fail = true;</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>requisite</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>fail = true; break;</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>sufficient</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>if (!fail) break;</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>optional</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>-</p></td></tr></tbody></table><div class=paragraph><p>Если переменная <code>fail</code> принимает истинное значение в конце отработки цепочки, или когда достигнут "break", диспетчер возвращает код ошибки, возвращённый первым модулем, отработавшим неудачно. В противном случае возвращается <code>PAM_SUCCESS</code>.</p></div><div class=paragraph><p>Первым исключением является то, что код ошибки <code>PAM_NEW_AUTHTOK_REQD</code> интерпретируется как успешный результат, кроме случая, когда модуль отработал успешно, и по крайней мере один модуль возвратил <code>PAM_NEW_AUTHTOK_REQD</code>, тогда диспетчер возвратит результат <code>PAM_NEW_AUTHTOK_REQD</code>.</p></div><div class=paragraph><p>Вторым исключением является то, что <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_setcred&amp;sektion=3&amp;format=html">pam_setcred(3)</a> считает, что модули <code>binding</code> и <code>sufficient</code> являются равнозначными <code>required</code>.</p></div><div class=paragraph><p>Третьим и последним исключением является то, что функция <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_chauthtok&amp;sektion=3&amp;format=html">pam_chauthtok(3)</a> отрабатывает полную цепочку дважды (один раз для предварительных проверок, и ещё раз для реального задания пароля), и на подготовительной фазе она считает, что модули <code>binding</code> и <code>sufficient</code> являются равнозначными <code>required</code>.</p></div></div></div><div class=sect1><h2 id=pam-freebsd-modules>22. Модули PAM во FreeBSD<a class=anchor href=#pam-freebsd-modules></a></h2><div class=sectionbody><div class=sect2><h3 id=pam-modules-deny>22.1. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_deny&amp;sektion=8&amp;format=html">pam_deny(8)</a><a class=anchor href=#pam-modules-deny></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_deny&amp;sektion=8&amp;format=html">pam_deny(8)</a> является одним из простейших доступных модулей; на любой запрос он возвращает результат <code>PAM_AUTH_ERR</code>. Он полезен для быстрого отключения сервиса (добавьте его на верх каждой цепочки) или завершения цепочек модулей <code>sufficient</code>.</p></div></div><div class=sect2><h3 id=pam-modules-echo>22.2. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_echo&amp;sektion=8&amp;format=html">pam_echo(8)</a><a class=anchor href=#pam-modules-echo></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_echo&amp;sektion=8&amp;format=html">pam_echo(8)</a> просто передаёт свои параметры в функцию взаимодействия как сообщение <code>PAM_TEXT_INFO</code>. В основном полезна для отладки, но также может использоваться для вывода сообщений, таких как "Unauthorized access will be prosecuted" до запуска процедуры аутентификации.</p></div></div><div class=sect2><h3 id=pam-modules-exec>22.3. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_exec&amp;sektion=8&amp;format=html">pam_exec(8)</a><a class=anchor href=#pam-modules-exec></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_exec&amp;sektion=8&amp;format=html">pam_exec(8)</a> воспринимает первый переданный ему параметр как имя программы для выполнения, а остальные аргументы передаются этой программе в качестве параметров командной строки. Одним из возможных применений является его использование для запуска в момент регистрации в системе программы монтирования домашнего каталога пользователя.</p></div></div><div class=sect2><h3 id=pam-modules-ftpusers>22.4. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ftpusers&amp;sektion=8&amp;format=html">pam_ftpusers(8)</a><a class=anchor href=#pam-modules-ftpusers></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ftpusers&amp;sektion=8&amp;format=html">pam_ftpusers(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-group>22.5. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_group&amp;sektion=8&amp;format=html">pam_group(8)</a><a class=anchor href=#pam-modules-group></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_group&amp;sektion=8&amp;format=html">pam_group(8)</a> принимает или отвергает аппликантов в зависимости от их членства в определённой файловой группе (обычно <code>wheel</code> для <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>). В первую очередь предназначен для сохранения традиционного поведения утилиты BSD <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>, хотя имеет и много других применений, таких как отключение определённых групп пользователей от некоторого сервиса.</p></div></div><div class=sect2><h3 id=pam-modules-guest>22.6. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_guest&amp;sektion=8&amp;format=html">pam_guest(8)</a><a class=anchor href=#pam-modules-guest></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_guest&amp;sektion=8&amp;format=html">pam_guest(8)</a> позволяет осуществлять гостевые входы с использованием фиксированных имён входа в систему. На пароль могут накладываться различные ограничения, однако действием по умолчанию является ввод любого пароля при использовании имени, соответствующего гостевому входу. Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_guest&amp;sektion=8&amp;format=html">pam_guest(8)</a> можно легко использовать для реализации анонимных входов на FTP.</p></div></div><div class=sect2><h3 id=pam-modules-krb5>22.7. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_krb5&amp;sektion=8&amp;format=html">pam_krb5(8)</a><a class=anchor href=#pam-modules-krb5></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_krb5&amp;sektion=8&amp;format=html">pam_krb5(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-ksu>22.8. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ksu&amp;sektion=8&amp;format=html">pam_ksu(8)</a><a class=anchor href=#pam-modules-ksu></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ksu&amp;sektion=8&amp;format=html">pam_ksu(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-lastlog>22.9. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_lastlog&amp;sektion=8&amp;format=html">pam_lastlog(8)</a><a class=anchor href=#pam-modules-lastlog></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_lastlog&amp;sektion=8&amp;format=html">pam_lastlog(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-login-access>22.10. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_login_access&amp;sektion=8&amp;format=html">pam_login_access(8)</a><a class=anchor href=#pam-modules-login-access></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_login_access&amp;sektion=8&amp;format=html">pam_login_access(8)</a> предоставляет реализацию примитива для управления учётными записями, который вводит в действие ограничения на вход, задаваемые в таблице <a href="https://man.freebsd.org/cgi/man.cgi?query=login.access&amp;sektion=5&amp;format=html">login.access(5)</a>.</p></div></div><div class=sect2><h3 id=pam-modules-nologin>22.11. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_nologin&amp;sektion=8&amp;format=html">pam_nologin(8)</a><a class=anchor href=#pam-modules-nologin></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_nologin&amp;sektion=8&amp;format=html">pam_nologin(8)</a> отвергает любые входы не пользователем root, если существует файл <span class=filename>/var/run/nologin</span>. Обычно этот файл создаётся утилитой <a href="https://man.freebsd.org/cgi/man.cgi?query=shutdown&amp;sektion=8&amp;format=html">shutdown(8)</a>, когда до запланированного завершения работы системы остаётся менее пяти минут.</p></div></div><div class=sect2><h3 id=pam-modules-opie>22.12. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opie&amp;sektion=8&amp;format=html">pam_opie(8)</a><a class=anchor href=#pam-modules-opie></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opie&amp;sektion=8&amp;format=html">pam_opie(8)</a> реализует метод аутентификации <a href="https://man.freebsd.org/cgi/man.cgi?query=opie&amp;sektion=4&amp;format=html">opie(4)</a>. Система <a href="https://man.freebsd.org/cgi/man.cgi?query=opie&amp;sektion=4&amp;format=html">opie(4)</a> является механизмом работы по схеме запрос-ответ, при котором ответ на каждый запрос является прямой функцией от запроса и ключевой фразы, так что ответ может быть легко и "вовремя" вычислен любым, знающим ключевую фразу, что избавляет от необходимости передавать пароль. Кроме того, так как в <a href="https://man.freebsd.org/cgi/man.cgi?query=opie&amp;sektion=4&amp;format=html">opie(4)</a> никогда повторно не используется запрос, ответ на который был корректно получен, эта схема является устойчивой к атакам, основанным на повторе действий.</p></div></div><div class=sect2><h3 id=pam-modules-opieaccess>22.13. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8&amp;format=html">pam_opieaccess(8)</a><a class=anchor href=#pam-modules-opieaccess></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8&amp;format=html">pam_opieaccess(8)</a> дополняет модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opie&amp;sektion=8&amp;format=html">pam_opie(8)</a>. Его работа заключается в выполнении ограничений, задаваемых файлом <a href="https://man.freebsd.org/cgi/man.cgi?query=opieaccess&amp;sektion=5&amp;format=html">opieaccess(5)</a>, который определяет условия, при которых пользователь, нормально прошедший аутентификацию посредством <a href="https://man.freebsd.org/cgi/man.cgi?query=opie&amp;sektion=4&amp;format=html">opie(4)</a>, может использовать альтернативные методы. Чаще всего он используется для запрета использования аутентификации на основе паролей с непроверенных хостов.</p></div><div class=paragraph><p>Для эффективности модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opieaccess&amp;sektion=8&amp;format=html">pam_opieaccess(8)</a> должен быть определён в цепочке <code>auth</code> как <code>requisite</code> сразу же после записи <code>sufficient</code> для <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_opie&amp;sektion=8&amp;format=html">pam_opie(8)</a>, но перед любыми другими модулями.</p></div></div><div class=sect2><h3 id=pam-modules-passwdqc>22.14. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8&amp;format=html">pam_passwdqc(8)</a><a class=anchor href=#pam-modules-passwdqc></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_passwdqc&amp;sektion=8&amp;format=html">pam_passwdqc(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-permit>22.15. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_permit&amp;sektion=8&amp;format=html">pam_permit(8)</a><a class=anchor href=#pam-modules-permit></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_permit&amp;sektion=8&amp;format=html">pam_permit(8)</a> является одним из самых простым из имеющихся; на любой запрос он отвечает <code>PAM_SUCCESS</code>. Он полезен в качестве замены пустого места для сервисов, когда одна или большее количество цепочек в противном случае останутся пустыми.</p></div></div><div class=sect2><h3 id=pam-modules-radius>22.16. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_radius&amp;sektion=8&amp;format=html">pam_radius(8)</a><a class=anchor href=#pam-modules-radius></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_radius&amp;sektion=8&amp;format=html">pam_radius(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-rhosts>22.17. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_rhosts&amp;sektion=8&amp;format=html">pam_rhosts(8)</a><a class=anchor href=#pam-modules-rhosts></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_rhosts&amp;sektion=8&amp;format=html">pam_rhosts(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-rootok>22.18. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_rootok&amp;sektion=8&amp;format=html">pam_rootok(8)</a><a class=anchor href=#pam-modules-rootok></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_rootok&amp;sektion=8&amp;format=html">pam_rootok(8)</a> возвращает положительный результат в том и только в том случае, если реальный id пользователя процесса, его вызвавшего (предполагается, что его запускает аппликант) равен 0. Это полезно для несетевых сервисов, таких как <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> или <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a>, к которым пользователь <code>root</code> должен иметь автоматический доступ.</p></div></div><div class=sect2><h3 id=pam-modules-securetty>22.19. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_securetty&amp;sektion=8&amp;format=html">pam_securetty(8)</a><a class=anchor href=#pam-modules-securetty></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_securetty&amp;sektion=8&amp;format=html">pam_securetty(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-self>22.20. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_self&amp;sektion=8&amp;format=html">pam_self(8)</a><a class=anchor href=#pam-modules-self></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_self&amp;sektion=8&amp;format=html">pam_self(8)</a> возвращает положительный результат тогда и только тогда, когда имена аппликанта соответствуют целевой учётной записи. Больше всего это пригодится в несетевых сервисах, таких как <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a>, в которых идентификация аппликанта может быть с лёгкостью проверена.</p></div></div><div class=sect2><h3 id=pam-modules-ssh>22.21. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ssh&amp;sektion=8&amp;format=html">pam_ssh(8)</a><a class=anchor href=#pam-modules-ssh></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_ssh&amp;sektion=8&amp;format=html">pam_ssh(8)</a> предоставляет как сервис аутентификации, так и сеанса. Сервис аутентификации позволяет пользователям, имеющим секретные ключи SSH, защищённые паролями, в своих каталогах <span class=filename>~/.ssh</span>, аутентифицироваться посредством этих паролей. Сеансовый сервис запускает <a href="https://man.freebsd.org/cgi/man.cgi?query=ssh-agent&amp;sektion=1&amp;format=html">ssh-agent(1)</a> и загружает ключи, которые были расшифрованы на фазе аутентификации. Такая возможность, в частности, полезна для локальных входов в систему, как в систему X (посредством <a href="https://man.freebsd.org/cgi/man.cgi?query=xdm&amp;sektion=1&amp;format=html">xdm(1)</a> или другого X-менеджера входов, умеющего работать с PAM), так и на консоль.</p></div></div><div class=sect2><h3 id=pam-modules-tacplus>22.22. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_tacplus&amp;sektion=8&amp;format=html">pam_tacplus(8)</a><a class=anchor href=#pam-modules-tacplus></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_tacplus&amp;sektion=8&amp;format=html">pam_tacplus(8)</a></p></div></div><div class=sect2><h3 id=pam-modules-unix>22.23. <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_unix&amp;sektion=8&amp;format=html">pam_unix(8)</a><a class=anchor href=#pam-modules-unix></a></h3><div class=paragraph><p>Модуль <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_unix&amp;sektion=8&amp;format=html">pam_unix(8)</a> реализует традиционную аутентификацию UNIX® на основе паролей, использующую функцию <a href="https://man.freebsd.org/cgi/man.cgi?query=getpwnam&amp;sektion=3&amp;format=html">getpwnam(3)</a> для получения пароля целевой учётной записи и сравнивающую её с тем, что представил аппликант. Он также предоставляет средства управления учётными записями (отслеживая время действия учётной записи и пароля) и смены паролей. Наверное, это самый полезный модуль, так как подавляющее большинство администраторов хотят сохранить исторически сложившееся поведение по крайней мере некоторых сервисов.</p></div></div></div></div><div class=sect1><h2 id=pam-appl-prog>23. Программирование приложений с PAM<a class=anchor href=#pam-appl-prog></a></h2><div class=sectionbody><div class=paragraph><p>Этот раздел ещё не написан.</p></div></div></div><div class=sect1><h2 id=pam-module-prog>24. Программирование модуля PAM<a class=anchor href=#pam-module-prog></a></h2><div class=sectionbody><div class=paragraph><p>Этот раздел ещё не написан.</p></div></div></div><div class=sect1><h2 id=pam-sample-appl>Приложение A: Пример PAM-приложения<a class=anchor href=#pam-sample-appl></a></h2><div class=sectionbody><div class=paragraph><p>Далее следует минимальная реализация программы <a href="https://man.freebsd.org/cgi/man.cgi?query=su&amp;sektion=1&amp;format=html">su(1)</a> с использованием PAM. Заметьте, что в ней используется специфичная для OpenPAM функция взаимодействия <a href="https://man.freebsd.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3&amp;format=html">openpam_ttyconv(3)</a>, объявление которой расположено в файле <span class=filename>security/openpam.h</span>. Если вы собираетесь строить это приложение в системе с другой библиотекой PAM, вам необходимо будет создать собственную функцию взаимодействия. Надёжную функцию взаимодействия неожиданно трудно написать; та, что находится в <a href=#pam-sample-conv>Пример функции взаимодействия PAM</a>, хороша в качестве отправной точки, но в реальных приложениях использоваться не может.</p></div><div class="literalblock programlisting"><div class=content><pre>/*-
 * Copyright (c) 2002,2003 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * (&#34;CBOSS&#34;), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $P4: //depot/projects/openpam/bin/su/su.c#10 $
 * $FreeBSD: head/en_US.ISO8859-1/articles/pam/su.c 38826 2012-05-17 19:12:14Z hrs $
 */

#include &lt;sys/param.h&gt;
#include &lt;sys/wait.h&gt;

#include &lt;err.h&gt;
#include &lt;pwd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;syslog.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_appl.h&gt;
#include &lt;security/openpam.h&gt;	/* for openpam_ttyconv() */

extern char **environ;

static pam_handle_t *pamh;
static struct pam_conv pamc;

static void
usage(void)
{

	fprintf(stderr, &#34;Usage: su [login [args]]\n&#34;);
	exit(1);
}

int
main(int argc, char *argv[])
{
	char hostname[MAXHOSTNAMELEN];
	const char *user, *tty;
	char **args, **pam_envlist, **pam_env;
	struct passwd *pwd;
	int o, pam_err, status;
	pid_t pid;

	while ((o = getopt(argc, argv, &#34;h&#34;)) != -1)
		switch (o) {
		case &#39;h&#39;:
		default:
			usage();
		}

	argc -= optind;
	argv += optind;

	if (argc &gt; 0) {
		user = *argv;
		--argc;
		++argv;
	} else {
		user = &#34;root&#34;;
	}

	/* initialize PAM */
	pamc.conv = &amp;openpam_ttyconv;
	pam_start(&#34;su&#34;, user, &amp;pamc, &amp;pamh);

	/* set some items */
	gethostname(hostname, sizeof(hostname));
	if ((pam_err = pam_set_item(pamh, PAM_RHOST, hostname)) != PAM_SUCCESS)
		goto pamerr;
	user = getlogin();
	if ((pam_err = pam_set_item(pamh, PAM_RUSER, user)) != PAM_SUCCESS)
		goto pamerr;
	tty = ttyname(STDERR_FILENO);
	if ((pam_err = pam_set_item(pamh, PAM_TTY, tty)) != PAM_SUCCESS)
		goto pamerr;

	/* authenticate the applicant */
	if ((pam_err = pam_authenticate(pamh, 0)) != PAM_SUCCESS)
		goto pamerr;
	if ((pam_err = pam_acct_mgmt(pamh, 0)) == PAM_NEW_AUTHTOK_REQD)
		pam_err = pam_chauthtok(pamh, PAM_CHANGE_EXPIRED_AUTHTOK);
	if (pam_err != PAM_SUCCESS)
		goto pamerr;

	/* establish the requested credentials */
	if ((pam_err = pam_setcred(pamh, PAM_ESTABLISH_CRED)) != PAM_SUCCESS)
		goto pamerr;

	/* authentication succeeded; open a session */
	if ((pam_err = pam_open_session(pamh, 0)) != PAM_SUCCESS)
		goto pamerr;

	/* get mapped user name; PAM may have changed it */
	pam_err = pam_get_item(pamh, PAM_USER, (const void **)&amp;user);
	if (pam_err != PAM_SUCCESS || (pwd = getpwnam(user)) == NULL)
		goto pamerr;

	/* export PAM environment */
	if ((pam_envlist = pam_getenvlist(pamh)) != NULL) {
		for (pam_env = pam_envlist; *pam_env != NULL; ++pam_env) {
			putenv(*pam_env);
			free(*pam_env);
		}
		free(pam_envlist);
	}

	/* build argument list */
	if ((args = calloc(argc + 2, sizeof *args)) == NULL) {
		warn(&#34;calloc()&#34;);
		goto err;
	}
	*args = pwd-&gt;pw_shell;
	memcpy(args + 1, argv, argc * sizeof *args);

	/* fork and exec */
	switch ((pid = fork())) {
	case -1:
		warn(&#34;fork()&#34;);
		goto err;
	case 0:
		/* child: give up privs and start a shell */

		/* set uid and groups */
		if (initgroups(pwd-&gt;pw_name, pwd-&gt;pw_gid) == -1) {
			warn(&#34;initgroups()&#34;);
			_exit(1);
		}
		if (setgid(pwd-&gt;pw_gid) == -1) {
			warn(&#34;setgid()&#34;);
			_exit(1);
		}
		if (setuid(pwd-&gt;pw_uid) == -1) {
			warn(&#34;setuid()&#34;);
			_exit(1);
		}
		execve(*args, args, environ);
		warn(&#34;execve()&#34;);
		_exit(1);
	default:
		/* parent: wait for child to exit */
		waitpid(pid, &amp;status, 0);

		/* close the session and release PAM resources */
		pam_err = pam_close_session(pamh, 0);
		pam_end(pamh, pam_err);

		exit(WEXITSTATUS(status));
	}

pamerr:
	fprintf(stderr, &#34;Sorry\n&#34;);
err:
	pam_end(pamh, pam_err);
	exit(1);
}</pre></div></div></div></div><div class=sect1><h2 id=pam-sample-module>Приложение B: Пример PAM-модуля<a class=anchor href=#pam-sample-module></a></h2><div class=sectionbody><div class=paragraph><p>Далее приведена минимальная реализация <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_unix&amp;sektion=8&amp;format=html">pam_unix(8)</a>, предоставляющая только сервисы аутентификации. Она должна строиться и работать с большинством из реализаций PAM, но использует возможности расширений OpenPAM, если они присутствуют: отметьте использование функции <a href="https://man.freebsd.org/cgi/man.cgi?query=pam_get_authtok&amp;sektion=3&amp;format=html">pam_get_authtok(3)</a>, которая кардинально упрощает организацию ввода пароля пользователем.</p></div><div class="literalblock programlisting"><div class=content><pre>/*-
 * Copyright (c) 2002 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * (&#34;CBOSS&#34;), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $P4: //depot/projects/openpam/modules/pam_unix/pam_unix.c#3 $
 * $FreeBSD: head/en_US.ISO8859-1/articles/pam/pam_unix.c 38826 2012-05-17 19:12:14Z hrs $
 */

#include &lt;sys/param.h&gt;

#include &lt;pwd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_modules.h&gt;
#include &lt;security/pam_appl.h&gt;

#ifndef _OPENPAM
static char password_prompt[] = &#34;Password:&#34;;
#endif

#ifndef PAM_EXTERN
#define PAM_EXTERN
#endif

PAM_EXTERN int
pam_sm_authenticate(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{
#ifndef _OPENPAM
	struct pam_conv *conv;
	struct pam_message msg;
	const struct pam_message *msgp;
	struct pam_response *resp;
#endif
	struct passwd *pwd;
	const char *user;
	char *crypt_password, *password;
	int pam_err, retry;

	/* identify user */
	if ((pam_err = pam_get_user(pamh, &amp;user, NULL)) != PAM_SUCCESS)
		return (pam_err);
	if ((pwd = getpwnam(user)) == NULL)
		return (PAM_USER_UNKNOWN);

	/* get password */
#ifndef _OPENPAM
	pam_err = pam_get_item(pamh, PAM_CONV, (const void **)&amp;conv);
	if (pam_err != PAM_SUCCESS)
		return (PAM_SYSTEM_ERR);
	msg.msg_style = PAM_PROMPT_ECHO_OFF;
	msg.msg = password_prompt;
	msgp = &amp;msg;
#endif
	for (retry = 0; retry &lt; 3; ++retry) {
#ifdef _OPENPAM
		pam_err = pam_get_authtok(pamh, PAM_AUTHTOK,
		    (const char **)&amp;password, NULL);
#else
		resp = NULL;
		pam_err = (*conv-&gt;conv)(1, &amp;msgp, &amp;resp, conv-&gt;appdata_ptr);
		if (resp != NULL) {
			if (pam_err == PAM_SUCCESS)
				password = resp-&gt;resp;
			else
				free(resp-&gt;resp);
			free(resp);
		}
#endif
		if (pam_err == PAM_SUCCESS)
			break;
	}
	if (pam_err == PAM_CONV_ERR)
		return (pam_err);
	if (pam_err != PAM_SUCCESS)
		return (PAM_AUTH_ERR);

	/* compare passwords */
	if ((!pwd-&gt;pw_passwd[0] &amp;&amp; (flags &amp; PAM_DISALLOW_NULL_AUTHTOK)) ||
	    (crypt_password = crypt(password, pwd-&gt;pw_passwd)) == NULL ||
	    strcmp(crypt_password, pwd-&gt;pw_passwd) != 0)
		pam_err = PAM_AUTH_ERR;
	else
		pam_err = PAM_SUCCESS;
#ifndef _OPENPAM
	free(password);
#endif
	return (pam_err);
}

PAM_EXTERN int
pam_sm_setcred(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_acct_mgmt(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_open_session(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_close_session(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SUCCESS);
}

PAM_EXTERN int
pam_sm_chauthtok(pam_handle_t *pamh, int flags,
	int argc, const char *argv[])
{

	return (PAM_SERVICE_ERR);
}

#ifdef PAM_MODULE_ENTRY
PAM_MODULE_ENTRY(&#34;pam_unix&#34;);
#endif</pre></div></div></div></div><div class=sect1><h2 id=pam-sample-conv>Приложение C: Пример функции взаимодействия PAM<a class=anchor href=#pam-sample-conv></a></h2><div class=sectionbody><div class=paragraph><p>Функция взаимодействия, приводимая ниже, является значительно упрощённой версией функции <a href="https://man.freebsd.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3&amp;format=html">openpam_ttyconv(3)</a> из OpenPAM. Она полнофункциональна, и должна послужить источником идей о том, как должна себя вести функция взаимодействия, однако она слишком проста для реальных приложений. Даже если вы не используете OpenPAM, можете сгрузить исходный код и использовать <a href="https://man.freebsd.org/cgi/man.cgi?query=openpam_ttyconv&amp;sektion=3&amp;format=html">openpam_ttyconv(3)</a> в своих целях; мы надеемся, что она достаточно надёжна в качестве функции для взаимодействия с терминальными устройствами.</p></div><div class="literalblock programlisting"><div class=content><pre>/*-
 * Copyright (c) 2002 Networks Associates Technology, Inc.
 * All rights reserved.
 *
 * This software was developed for the FreeBSD Project by ThinkSec AS and
 * Network Associates Laboratories, the Security Research Division of
 * Network Associates, Inc.  under DARPA/SPAWAR contract N66001-01-C-8035
 * (&#34;CBOSS&#34;), as part of the DARPA CHATS research program.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. The name of the author may not be used to endorse or promote
 *    products derived from this software without specific prior written
 *    permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * $FreeBSD: head/en_US.ISO8859-1/articles/pam/converse.c 38826 2012-05-17 19:12:14Z hrs $
 */

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

#include &lt;security/pam_appl.h&gt;

int
converse(int n, const struct pam_message **msg,
	struct pam_response **resp, void *data)
{
	struct pam_response *aresp;
	char buf[PAM_MAX_RESP_SIZE];
	int i;

	data = data;
	if (n &lt;= 0 || n &gt; PAM_MAX_NUM_MSG)
		return (PAM_CONV_ERR);
	if ((aresp = calloc(n, sizeof *aresp)) == NULL)
		return (PAM_BUF_ERR);
	for (i = 0; i &lt; n; ++i) {
		aresp[i].resp_retcode = 0;
		aresp[i].resp = NULL;
		switch (msg[i]-&gt;msg_style) {
		case PAM_PROMPT_ECHO_OFF:
			aresp[i].resp = strdup(getpass(msg[i]-&gt;msg));
			if (aresp[i].resp == NULL)
				goto fail;
			break;
		case PAM_PROMPT_ECHO_ON:
			fputs(msg[i]-&gt;msg, stderr);
			if (fgets(buf, sizeof buf, stdin) == NULL)
				goto fail;
			aresp[i].resp = strdup(buf);
			if (aresp[i].resp == NULL)
				goto fail;
			break;
		case PAM_ERROR_MSG:
			fputs(msg[i]-&gt;msg, stderr);
			if (strlen(msg[i]-&gt;msg) &gt; 0 &amp;&amp;
			    msg[i]-&gt;msg[strlen(msg[i]-&gt;msg) - 1] != &#39;\n&#39;)
				fputc(&#39;\n&#39;, stderr);
			break;
		case PAM_TEXT_INFO:
			fputs(msg[i]-&gt;msg, stdout);
			if (strlen(msg[i]-&gt;msg) &gt; 0 &amp;&amp;
			    msg[i]-&gt;msg[strlen(msg[i]-&gt;msg) - 1] != &#39;\n&#39;)
				fputc(&#39;\n&#39;, stdout);
			break;
		default:
			goto fail;
		}
	}
	*resp = aresp;
	return (PAM_SUCCESS);
 fail:
        for (i = 0; i &lt; n; ++i) {
                if (aresp[i].resp != NULL) {
                        memset(aresp[i].resp, 0, strlen(aresp[i].resp));
                        free(aresp[i].resp);
                }
        }
        memset(aresp, 0, n * sizeof *aresp);
	*resp = NULL;
	return (PAM_CONV_ERR);
}</pre></div></div></div></div><div class=sect1><h2 id=pam-further>Lectures complémentaires<a class=anchor href=#pam-further></a></h2><div class=sectionbody><div class=sect2><h3 id=_publications>Publications<a class=anchor href=#_publications></a></h3><div class=paragraph><p><em><a href=http://www.sun.com/software/solaris/pam/pam.external.pdf>Rendre les services de connexion indépendants des technologies d’authentification</a></em>. Vipin Samar et Charlie Lai. Sun Microsystems.</p></div><div class=paragraph><p><em><a href=http://www.opengroup.org/pubs/catalog/p702.htm>X/Open Single Sign-on Preliminary Specification</a></em>. The Open Group. 1-85912-144-6. June 1997.</p></div><div class=paragraph><p><em><a href=http://www.kernel.org/pub/linux/libs/pam/pre/doc/current-draft.txt>Pluggable Authentication Modules</a></em>. Andrew G. Morgan. 1999-10-06.</p></div></div><div class=sect2><h3 id=_guides_utilisateur>Guides utilisateur<a class=anchor href=#_guides_utilisateur></a></h3><div class=paragraph><p><em><a href=http://www.sun.com/software/solaris/pam/pam.admin.pdf>Administration de PAM</a></em>. Sun Microsystems.</p></div></div><div class=sect2><h3 id=_page_internet_liées>Page internet liées<a class=anchor href=#_page_internet_liées></a></h3><div class=paragraph><p><em><a href=http://openpam.sourceforge.net/>La page d’OpenPAM</a></em>. Dag-Erling Smørgrav. ThinkSec AS.</p></div><div class=paragraph><p><em><a href=http://www.kernel.org/pub/linux/libs/pam/>La page de Linux-PAM</a></em>. Andrew G. Morgan.</p></div><div class=paragraph><p><em><a href=http://wwws.sun.com/software/solaris/pam/>La page de Solaris PAM</a></em>. Sun Microsystems.</p></div></div></div></div><hr><div class=last-modified><p><strong>Изменено</strong>: 3 ноября 2021 г. by <a href="https://cgit.freebsd.org/doc/commit/?id=64acd169b8" target=_blank>Sergio Carlavilla Delgado</a></p></div></div><aside class=toc><div class=toc-content><h3>Содержание</h3><nav id=TableOfContents><ul><li><a href=#pam-intro>1. Введение</a></li><li><a href=#pam-terms>2. Термины и соглашения</a></li><li><a href=#pam-definitions>3. Определения</a></li><li><a href=#pam-usage-examples>4. Примеры использования</a></li><li><a href=#_объединенные_клиент_и_сервер>5. Объединенные клиент и сервер</a></li><li><a href=#_клиент_и_сервер_разделены>6. Клиент и сервер разделены</a></li><li><a href=#_пример_политики>7. Пример политики</a></li><li><a href=#pam-essentials>8. Основы PAM</a></li><li><a href=#pam-facilities-primitives>9. Подсистемы и примитивы</a></li><li><a href=#pam-modules>10. Модули</a></li><li><a href=#pam-module-naming>11. Именование модулей</a></li><li><a href=#pam-module-versioning>12. Версии модулей</a></li><li><a href=#pam-chains-policies>13. Цепочки и политики</a></li><li><a href=#pam-transactions>14. Транзакции</a></li><li><a href=#pam-config>15. Настройка PAM</a></li><li><a href=#pam-config-file>16. Файлы политик PAM</a></li><li><a href=#pam-config-pam.conf>17. Файл <span class=filename>/etc/pam.conf</span></a></li><li><a href=#pam-config-pam.d>18. Каталог <span class=filename>/etc/pam.d</span></a></li><li><a href=#pam-config-file-order>19. Порядок поиска политик</a></li><li><a href=#pam-config-breakdown>20. Структура строки настройки</a></li><li><a href=#pam-policies>21. Политики</a></li><li><a href=#pam-freebsd-modules>22. Модули PAM во FreeBSD</a></li><li><a href=#pam-appl-prog>23. Программирование приложений с PAM</a></li><li><a href=#pam-module-prog>24. Программирование модуля PAM</a></li><li><a href=#pam-sample-appl>Приложение A: Пример PAM-приложения</a></li><li><a href=#pam-sample-module>Приложение B: Пример PAM-модуля</a></li><li><a href=#pam-sample-conv>Приложение C: Пример функции взаимодействия PAM</a></li><li><a href=#pam-further>Lectures complémentaires</a></li></ul></nav><hr><div class=resources><h3>Материалы</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Скачать PDF"></i><a href=https://download.freebsd.org/doc/ru/articles/pam/pam_ru.pdf>Скачать PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Редактировать эту страницу"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/ru/_index target=_blank>Редактировать эту страницу</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=https://docs.freebsd.org/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=https://docs.freebsd.org/ru/languages><img src=https://docs.freebsd.org/images/language.png class=language-image alt="Выберите язык">
<span>Русский</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>Система</option><option value=theme-light>Светлый</option><option value=theme-dark>Тёмный</option><option value=theme-high-contrast>Высокая контрастность</option></select></div></div></section><section class=about-column><h3 class=column-title>О нас</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>Фонд FreeBSD</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Получить FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Кодекс Этики</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Бюллетени Безопасности</a></li></ul></section><section class=documentation-column><h3 class=column-title>Документация</h3><ul class=column-elements-container><li><a href=/ru class=column-element>Портал документации</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Страницы Справочника</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Презентации и публикации</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Предыдущие версии</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>Документы 4.4BSD</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Сообщество</h3><ul class=column-elements-container><li><a href=https://docs.freebsd.org/ru/articles/contributing class=column-element>Принять участие</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Форум Сообщества</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Списки рассылки</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>Каналы IRC</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Трекер ошибок</a></li></ul></section><section class=legal-column><h3 class=column-title>Юридическая информация</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Пожертвования</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Лицензирование</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Политика Конфиденциальности</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Юридические оговорки</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 Проект FreeBSD. Все права защищены</p><span>Сделано с помощью <span class=heart>♥</span> Сообществом FreeBSD</span></section></div></footer></body></html>