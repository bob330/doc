<!doctype html><html class=theme-light lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Implementing UFS Journaling on a Desktop PC"><meta name=keywords content="UFS,Journaling,Desktop,FreeBSD"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=https://docs.freebsd.org/en/articles/gjournal-desktop/><title>Implementing UFS Journaling on a Desktop PC | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=https://docs.freebsd.org/favicon.ico><link rel=stylesheet href=https://docs.freebsd.org/styles/main.min.css><link rel=stylesheet href=https://docs.freebsd.org/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Implementing UFS Journaling on a Desktop PC"><meta property="og:description" content="Implementing UFS Journaling on a Desktop PC"><meta property="og:type" content="website"><meta property="og:image" content="https://docs.freebsd.org/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs.freebsd.org/en/articles/gjournal-desktop/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"https:\/\/docs.freebsd.org\/en\/articles\/gjournal-desktop\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=https://docs.freebsd.org/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=https://docs.freebsd.org/en/books/handbook>FreeBSD Handbook</a></li><li><a href=https://docs.freebsd.org/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=https://docs.freebsd.org/en/books>Books</a></li><li><a href=https://docs.freebsd.org/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=https://docs.freebsd.org/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Implementing UFS Journaling on a Desktop PC</h1><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Introduction</a></li><li><a href=#understanding-journaling>2. Understanding Journaling in FreeBSD</a></li><li><a href=#reserve-space>3. Steps During the Installation of FreeBSD</a></li><li><a href=#configure-journal>4. Setting Up Journaling</a></li><li><a href=#troubleshooting-gjournal>5. Troubleshooting Journaling</a></li><li><a href=#further-reading>6. Further Reading</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Abstract</p></div><div class=paragraph><p>A journaling file system uses a log to record all transactions that take place in the file system, and preserves its integrity in the event of a system crash or power failure.
Although it is still possible to lose unsaved changes to files, journaling almost completely eliminates the possibility of file system corruption caused by an unclean shutdown.
It also shortens to a minimum the time required for after-failure file system checking.
Although the UFS file system employed by FreeBSD does not implement journaling itself, the new journal class of the GEOM framework in FreeBSD 7.<em>X</em> can be used to provide file system independent journaling.
This article explains how to implement UFS journaling on a typical desktop PC scenario.</p></div><hr></div></div><div class=sect1><h2 id=introduction>1. Introduction<a class=anchor href=#introduction></a></h2><div class=sectionbody><div class=paragraph><p>While professional servers are usually well protected from unforeseen shutdowns, the typical desktop is at the mercy of power failures, accidental resets, and other user related incidents that can lead to unclean shutdowns.
Soft Updates usually protect the file system efficiently in such cases, although most of the times a lengthy background check is required.
On rare occasions, file system corruption reaches a point where user intervention is required and data may be lost.</p></div><div class=paragraph><p>The new journaling capability provided by GEOM can greatly assist in such scenarios, by virtually eliminating the time required for file system checking, and ensuring that the file system is quickly restored to a consistent state.</p></div><div class=paragraph><p>This article describes a procedure for implementing UFS journaling on a typical desktop PC scenario (one hard disk used for both operating system and data).
It should be followed during a fresh installation of FreeBSD.
The steps are simple enough and do not require overly complex interaction with the command line.</p></div><div class=paragraph><p>After reading this article, you will know:</p></div><div class=ulist><ul><li><p>How to reserve space for journaling during a new installation of FreeBSD.</p></li><li><p>How to load and enable the <code>geom_journal</code> module (or build support for it in your custom kernel).</p></li><li><p>How to convert your existing file systems to utilize journaling, and what options to use in <span class=filename>/etc/fstab</span> to mount them.</p></li><li><p>How to implement journaling in new (empty) partitions.</p></li><li><p>How to troubleshoot common problems associated with journaling.</p></li></ul></div><div class=paragraph><p>Before reading this article, you should be able to:</p></div><div class=ulist><ul><li><p>Understand basic UNIX® and FreeBSD concepts.</p></li><li><p>Be familiar with the installation procedure of FreeBSD and the sysinstall utility.</p></li></ul></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>The procedure described here is intended for preparing a new installation where no actual user data is stored on the disk yet.
While it is possible to modify and extend this procedure for systems already in production, you should <em>backup</em> all important data before doing so.
Messing around with disks and partitions at a low level can lead to fatal mistakes and data loss.</p></div></td></tr></tbody></table></div></div></div><div class=sect1><h2 id=understanding-journaling>2. Understanding Journaling in FreeBSD<a class=anchor href=#understanding-journaling></a></h2><div class=sectionbody><div class=paragraph><p>The journaling provided by GEOM in FreeBSD 7.<em>X</em> is not file system specific (unlike for example the ext3 file system in Linux®) but is functioning at the block level.
Though this means it can be applied to different file systems, for FreeBSD 7.0-RELEASE, it can only be used on UFS2.</p></div><div class=paragraph><p>This functionality is provided by loading the <span class=filename>geom_journal.ko</span> module into the kernel (or building it into a custom kernel) and using the <code>gjournal</code> command to configure the file systems.
In general, you would like to journal large file systems, like <span class=filename>/usr</span>.
You will need however (see the following section) to reserve some free disk space.</p></div><div class=paragraph><p>When a file system is journaled, some disk space is needed to keep the journal itself.
The disk space that holds the actual data is referred to as the <em>data provider</em>, while the one that holds the journal is referred to as the <em>journal provider</em>.
The data and journal providers need to be on different partitions when journaling an existing (non-empty) partition.
When journaling a new partition, you have the option to use a single provider for both data and journal.
In any case, the <code>gjournal</code> command combines both providers to create the final journaled file system.
For example:</p></div><div class=ulist><ul><li><p>You wish to journal your <span class=filename>/usr</span> file system, stored in <span class=filename>/dev/ad0s1f</span> (which already contains data).</p></li><li><p>You reserved some free disk space in a partition in <span class=filename>/dev/ad0s1g</span>.</p></li><li><p>Using <code>gjournal</code>, a new <span class=filename>/dev/ad0s1f.journal</span> device is created where <span class=filename>/dev/ad0s1f</span> is the data provider, and <span class=filename>/dev/ad0s1g</span> is the journal provider. This new device is then used for all subsequent file operations.</p></li></ul></div><div class=paragraph><p>The amount of disk space you need to reserve for the journal provider depends on the usage load of the file system and not on the size of the data provider.
For example on a typical office desktop, a 1 GB journal provider for the <span class=filename>/usr</span> file system will suffice, while a machine that deals with heavy disk I/O (i.e. video editing) may need more.
A kernel panic will occur if the journal space is exhausted before it has a chance to be committed.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The journal sizes suggested here, are highly unlikely to cause problems in typical desktop use (such as web browsing, word processing and playback of media files).
If your workload includes intense disk activity, use the following rule for maximum reliability: Your RAM size should fit in 30% of the journal provider’s space.
For example, if your system has 1 GB RAM, create an approximately 3.3 GB journal provider.
(Multiply your RAM size with 3.3 to obtain the size of the journal).</p></div></td></tr></tbody></table></div><div class=paragraph><p>For more information about journaling, please read the manual page of <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>.</p></div></div></div><div class=sect1><h2 id=reserve-space>3. Steps During the Installation of FreeBSD<a class=anchor href=#reserve-space></a></h2><div class=sectionbody><div class=sect2><h3 id=_reserving_space_for_journaling>3.1. Reserving Space for Journaling<a class=anchor href=#_reserving_space_for_journaling></a></h3><div class=paragraph><p>A typical desktop machine usually has one hard disk that stores both the OS and user data.
Arguably, the default partitioning scheme selected by sysinstall is more or less suitable: A desktop machine does not need a large <span class=filename>/var</span> partition, while <span class=filename>/usr</span> is allocated the bulk of the disk space, since user data and a lot of packages are installed into its subdirectories.</p></div><div class=paragraph><p>The default partitioning (the one obtained by pressing <kbd>A</kbd> at the FreeBSD partition editor, called Disklabel) does not leave any unallocated space.
Each partition that will be journaled, requires another partition for the journal.
Since the <span class=filename>/usr</span> partition is the largest, it makes sense to shrink this partition slightly, to obtain the space required for journaling.</p></div><div class=paragraph><p>In our example, an 80 GB disk is used.
The following screenshot shows the default partitions created by Disklabel during installation:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel1.png alt=disklabel1></div></div><div class=paragraph><p>If this is more or less what you need, it is very easy to adjust for journaling.
Simply use the arrow keys to move the highlight to the <span class=filename>/usr</span> partition and press <kbd>D</kbd> to delete it.</p></div><div class=paragraph><p>Now, move the highlight to the disk name at the top of the screen and press <kbd>C</kbd> to create a new partition for <span class=filename>/usr</span>.
This new partition should be smaller by 1 GB (if you intend to journal <span class=filename>/usr</span> only), or 2 GB (if you intend to journal both <span class=filename>/usr</span> and <span class=filename>/var</span>).
From the pop-up that appears, opt to create a file system, and type <span class=filename>/usr</span> as the mount point.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Should you journal the <span class=filename>/var</span> partition? Normally, journaling makes sense on quite large partitions.
You may decide not to journal <span class=filename>/var</span>, although doing so on a typical desktop will cause no harm.
If the file system is lightly used (quite probable for a desktop) you may wish to allocate less disk space for its journal.</p></div><div class=paragraph><p>In our example, we journal both <span class=filename>/usr</span> and <span class=filename>/var</span>.
You may of course adjust the procedure to your own needs.</p></div></td></tr></tbody></table></div><div class=paragraph><p>To keep things as easy going as possible, we are going to use sysinstall to create the partitions required for journaling.
However, during installation, sysinstall insists on asking a mount point for each partition you create.
At this point, you do not have any mount points for the partitions that will hold the journals, and in reality you <em>do not even need them</em>.
These are not partitions that we are ever going to mount somewhere.</p></div><div class=paragraph><p>To avoid these problems with sysinstall, we are going to create the journal partitions as swap space.
Swap is never mounted, and sysinstall has no problem creating as many swap partitions as needed.
After the first reboot, <span class=filename>/etc/fstab</span> will have to be edited, and the extra swap space entries removed.</p></div><div class=paragraph><p>To create the swap, again use the arrow keys to move the highlight to the top of Disklabel screen, so that the disk name itself is highlighted.
Then press <kbd>N</kbd>, enter the desired size (<em>1024M</em>), and select "swap space" from the pop-up menu that appears.
Repeat for every journal you wish to create.
In our example, we create two partitions to provide for the journals of <span class=filename>/usr</span> and <span class=filename>/var</span>.
The final result is shown in the following screenshot:</p></div><div class=imageblock><div class=content><img src=../../../images/articles/gjournal-desktop/disklabel2.png alt=disklabel2></div></div><div class=paragraph><p>When you have completed creating the partitions, we suggest you write down the partition names, and mount points, so you can easily refer to this information during the configuration phase.
This will help alleviate mistakes that may damage your installation.
The following table shows our notes for the sample configuration:</p></div><table class="tableblock frame-all grid-all stretch"><caption class=title>Table 1. Partitions and Journals</caption><col style=width:33.3333%><col style=width:33.3333%><col style=width:33.3334%><thead><tr><th class="tableblock halign-left valign-top">Partition</th><th class="tableblock halign-left valign-top">Mount Point</th><th class="tableblock halign-left valign-top">Journal</th></tr></thead><tbody><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1d</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/var</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1h</p></td></tr><tr><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1f</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>/usr</p></td><td class="tableblock halign-left valign-top"><p class=tableblock>ad0s1g</p></td></tr></tbody></table><div class=paragraph><p>Continue the installation as you would normally do.
We would however suggest you postpone installation of third party software (packages) until you have completely setup journaling.</p></div></div><div class=sect2><h3 id=first-boot>3.2. Booting for the first time<a class=anchor href=#first-boot></a></h3><div class=paragraph><p>Your system will come up normally, but you will need to edit <span class=filename>/etc/fstab</span> and remove the extra swap partitions you created for the journals.
Normally, the swap partition you will actually use is the one with the "b" suffix (i.e. ad0s1b in our example).
Remove all other swap space entries and reboot so that FreeBSD will stop using them.</p></div><div class=paragraph><p>When the system comes up again, we will be ready to configure journaling.</p></div></div></div></div><div class=sect1><h2 id=configure-journal>4. Setting Up Journaling<a class=anchor href=#configure-journal></a></h2><div class=sectionbody><div class=sect2><h3 id=running-gjournal>4.1. Executing <code>gjournal</code><a class=anchor href=#running-gjournal></a></h3><div class=paragraph><p>Having prepared all the required partitions, it is quite easy to configure journaling.
We will need to switch to single user mode, so login as <code>root</code> and type:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Press <kbd>Enter</kbd> to get the default shell.
We will need to unmount the partitions that will be journaled, in our example <span class=filename>/usr</span> and <span class=filename>/var</span>:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Load the module required for journaling:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span></code></pre></div></div><div class=paragraph><p>Now, use your notes to determine which partition will be used for each journal.
In our example, <span class=filename>/usr</span> is <span class=filename>ad0s1f</span> and its journal will be <span class=filename>ad0s1g</span>, while <span class=filename>/var</span> is <span class=filename>ad0s1d</span> and will be journaled to <span class=filename>ad0s1h</span>.
The following commands are required:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad0s1f ad0s1g</span>
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.

<span class=c># gjournal label ad0s1d ad0s1h</span>
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.</code></pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>If the last sector of either partition is used, <code>gjournal</code> will return an error.
You will have to run the command using the <code>-f</code> flag to force an overwrite, i.e.:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -f ad0s1d ad0s1h</span></code></pre></div></div><div class=paragraph><p>Since this is a new installation, it is highly unlikely that anything will be actually overwritten.</p></div></td></tr></tbody></table></div><div class=paragraph><p>At this point, two new devices are created, namely <span class=filename>ad0s1d.journal</span> and <span class=filename>ad0s1f.journal</span>.
These represent the <span class=filename>/var</span> and <span class=filename>/usr</span> partitions we have to mount.
Before mounting, we must however set the journal flag on them and clear the Soft Updates flag:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J enable -n disable ad0s1d.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared

<span class=c># tunefs -J enable -n disable ad0s1f.journal</span>
tunefs: gjournal <span class=nb>set
</span>tunefs: soft updates cleared</code></pre></div></div><div class=paragraph><p>Now, mount the new devices manually at their respective places (note that we can now use the <code>async</code> mount option):</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o async /dev/ad0s1d.journal /var</span>
<span class=c># mount -o async /dev/ad0s1f.journal /usr</span></code></pre></div></div><div class=paragraph><p>Edit <span class=filename>/etc/fstab</span> and update the entries for <span class=filename>/usr</span> and <span class=filename>/var</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f.journal     /usr            ufs     rw,async      2       2
/dev/ad0s1d.journal     /var            ufs     rw,async      2       2</pre></div></div><div class="admonitionblock warning"><table><tbody><tr><td class=icon><i class="fa icon-warning" title=Warning></i></td><td class=content><div class=paragraph><p>Make sure the above entries are correct, or you will have trouble starting up normally after you reboot!</p></div></td></tr></tbody></table></div><div class=paragraph><p>Finally, edit <span class=filename>/boot/loader.conf</span> and add the following line so the <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> module is loaded at every boot:</p></div><div class="literalblock programlisting"><div class=content><pre>geom_journal_load=&#34;YES&#34;</pre></div></div><div class=paragraph><p>Congratulations! Your system is now set for journaling.
You can either type <code>exit</code> to return to multi-user mode, or reboot to test your configuration (recommended).
During the boot you will see messages like the following:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>ad0: 76293MB XEC XE800JD-00HBC0 08.02D08 at ata0-master SATA150
GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.</code></pre></div></div><div class=paragraph><p>After an unclean shutdown, the messages will vary slightly, i.e.:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>GEOM_JOURNAL: Journal ad0s1d consistent.</code></pre></div></div><div class=paragraph><p>This usually means that <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> used the information in the journal provider to return the file system to a consistent state.</p></div></div><div class=sect2><h3 id=gjournal-new>4.2. Journaling Newly Created Partitions<a class=anchor href=#gjournal-new></a></h3><div class=paragraph><p>While the above procedure is necessary for journaling partitions that already contain data, journaling an empty partition is somewhat easier, since both the data and the journal provider can be stored in the same partition.
For example, assume a new disk was installed, and a new partition <span class=filename>/dev/ad1s1d</span> was created.
Creating the journal would be as simple as:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label ad1s1d</span></code></pre></div></div><div class=paragraph><p>The journal size will be 1 GB by default.
You may adjust it by using the <code>-s</code> option.
The value can be given in bytes, or appended by <code>K</code>, <code>M</code> or <code>G</code> to denote Kilobytes, Megabytes or Gigabytes respectively.
Note that <code>gjournal</code> will not allow you to create unsuitably small journal sizes.</p></div><div class=paragraph><p>For example, to create a 2 GB journal, you could use the following command:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal label -s 2G ad1s1d</span></code></pre></div></div><div class=paragraph><p>You can then create a file system on your new partition, and enable journaling using the <code>-J</code> option:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># newfs -J /dev/ad1s1d.journal</span></code></pre></div></div></div><div class=sect2><h3 id=configure-kernel>4.3. Building Journaling into Your Custom Kernel<a class=anchor href=#configure-kernel></a></h3><div class=paragraph><p>If you do not wish to load <code>geom_journal</code> as a module, you can build its functions right into your kernel.
Edit your custom kernel configuration file, and make sure it includes these two lines:</p></div><div class="literalblock programlisting"><div class=content><pre>options UFS_GJOURNAL # Note: This is already in GENERIC

options GEOM_JOURNAL # You will have to add this one</pre></div></div><div class=paragraph><p>Rebuild and reinstall your kernel following the relevant <a href=https://docs.freebsd.org/en/books/handbook/#kernelconfig>instructions in the FreeBSD Handbook.</a></p></div><div class=paragraph><p>Do not forget to remove the relevant "load" entry from <span class=filename>/boot/loader.conf</span> if you have previously used it.</p></div></div></div></div><div class=sect1><h2 id=troubleshooting-gjournal>5. Troubleshooting Journaling<a class=anchor href=#troubleshooting-gjournal></a></h2><div class=sectionbody><div class=paragraph><p>The following section covers frequently asked questions regarding problems related to journaling.</p></div><div class=sect2><h3 id=_i_am_getting_kernel_panics_during_periods_of_high_disk_activity_how_is_this_related_to_journaling>5.1. I am getting kernel panics during periods of high disk activity. How is this related to journaling?<a class=anchor href=#_i_am_getting_kernel_panics_during_periods_of_high_disk_activity_how_is_this_related_to_journaling></a></h3><div class=paragraph><p>The journal probably fills up before it has a chance to get committed (flushed) to disk.
Keep in mind the size of the journal depends on the usage load, and not the size of the data provider.
If your disk activity is high, you need a larger partition for the journal.
See the note in the <a href=../gjournal-desktop/#understanding-journaling>Understanding Journaling in FreeBSD</a> section.</p></div></div><div class=sect2><h3 id=_i_made_some_mistake_during_configuration_and_i_cannot_boot_normally_now_can_this_be_fixed_some_way>5.2. I made some mistake during configuration, and I cannot boot normally now. Can this be fixed some way?<a class=anchor href=#_i_made_some_mistake_during_configuration_and_i_cannot_boot_normally_now_can_this_be_fixed_some_way></a></h3><div class=paragraph><p>You either forgot (or misspelled) the entry in <span class=filename>/boot/loader.conf</span>, or there are errors in your <span class=filename>/etc/fstab</span> file.
These are usually easy to fix.
Press <kbd>Enter</kbd> to get to the default single user shell.
Then locate the root of the problem:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># cat /boot/loader.conf</span></code></pre></div></div><div class=paragraph><p>If the <code>geom_journal_load</code> entry is missing or misspelled, the journaled devices are never created.
Load the module manually, mount all partitions, and continue with multi-user boot:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal load</span>

GEOM_JOURNAL: Journal 2948326772: ad0s1g contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1h contains journal.
GEOM_JOURNAL: Journal 3193218002: ad0s1d contains data.
GEOM_JOURNAL: Journal ad0s1d clean.
GEOM_JOURNAL: Journal 2948326772: ad0s1f contains data.
GEOM_JOURNAL: Journal ad0s1f clean.

<span class=c># mount -a</span>
<span class=c># exit</span>
<span class=o>(</span>boot continues<span class=o>)</span></code></pre></div></div><div class=paragraph><p>If, on the other hand, this entry is correct, have a look at <span class=filename>/etc/fstab</span>.
You will probably find a misspelled or missing entry.
In this case, mount all remaining partitions by hand and continue with the multi-user boot.</p></div></div><div class=sect2><h3 id=_can_i_remove_journaling_and_return_to_my_standard_file_system_with_soft_updates>5.3. Can I remove journaling and return to my standard file system with Soft Updates?<a class=anchor href=#_can_i_remove_journaling_and_return_to_my_standard_file_system_with_soft_updates></a></h3><div class=paragraph><p>Sure.
Use the following procedure, which reverses the changes.
The partitions you created for the journal providers can then be used for other purposes, if you so wish.</p></div><div class=paragraph><p>Login as <code>root</code> and switch to single user mode:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># shutdown now</span></code></pre></div></div><div class=paragraph><p>Unmount the journaled partitions:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># umount /usr /var</span></code></pre></div></div><div class=paragraph><p>Synchronize the journals:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal sync</span></code></pre></div></div><div class=paragraph><p>Stop the journaling providers:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal stop ad0s1d.journal</span>
<span class=c># gjournal stop ad0s1f.journal</span></code></pre></div></div><div class=paragraph><p>Clear journaling metadata from all the devices used:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># gjournal clear ad0s1d</span>
<span class=c># gjournal clear ad0s1f</span>
<span class=c># gjournal clear ad0s1g</span>
<span class=c># gjournal clear ad0s1h</span></code></pre></div></div><div class=paragraph><p>Clear the file system journaling flag, and restore the Soft Updates flag:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># tunefs -J disable -n enable ad0s1d</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span>

<span class=c># tunefs -J disable -n enable ad0s1f</span>
tunefs: gjournal cleared
tunefs: soft updates <span class=nb>set</span></code></pre></div></div><div class=paragraph><p>Remount the old devices by hand:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># mount -o rw /dev/ad0s1d /var</span>
<span class=c># mount -o rw /dev/ad0s1f /usr</span></code></pre></div></div><div class=paragraph><p>Edit <span class=filename>/etc/fstab</span> and restore it to its original state:</p></div><div class="literalblock programlisting"><div class=content><pre>/dev/ad0s1f     /usr            ufs     rw      2       2
/dev/ad0s1d     /var            ufs     rw      2       2</pre></div></div><div class=paragraph><p>Finally, edit <span class=filename>/boot/loader.conf</span>, remove the entry that loads the <code>geom_journal</code> module and reboot.</p></div></div></div></div><div class=sect1><h2 id=further-reading>6. Further Reading<a class=anchor href=#further-reading></a></h2><div class=sectionbody><div class=paragraph><p>Journaling is a fairly new feature of FreeBSD, and as such, it is not very well documented yet.
You may however find the following additional references useful:</p></div><div class=ulist><ul><li><p>A <a href=https://docs.freebsd.org/en/books/handbook/#geom-gjournal>new section on journaling</a> is now part of the FreeBSD Handbook.</p></li><li><p><a href=https://lists.freebsd.org/pipermail/freebsd-current/2006-June/064043.html>This post</a> in <a href=https://lists.FreeBSD.org/subscription/freebsd-current>FreeBSD-CURRENT mailing list</a> by <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a>'s developer, <code>Paweł Jakub Dawidek &lt;<a href=mailto:pjd@FreeBSD.org>pjd@FreeBSD.org</a>></code>.</p></li><li><p><a href=https://lists.freebsd.org/pipermail/freebsd-questions/2008-April/173501.html>This post</a> in <a href=https://lists.FreeBSD.org/subscription/freebsd-questions>FreeBSD general questions mailing list</a> by <code>Ivan Voras &lt;<a href=mailto:ivoras@FreeBSD.org>ivoras@FreeBSD.org</a>></code>.</p></li><li><p>The manual pages of <a href="https://man.freebsd.org/cgi/man.cgi?query=gjournal&amp;sektion=8&amp;format=html">gjournal(8)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=geom&amp;sektion=8&amp;format=html">geom(8)</a>.</p></li></ul></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: September 20, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=2d2f5d38cc" target=_blank>Fernando Apesteguía</a></p></div></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#introduction>1. Introduction</a></li><li><a href=#understanding-journaling>2. Understanding Journaling in FreeBSD</a></li><li><a href=#reserve-space>3. Steps During the Installation of FreeBSD</a></li><li><a href=#configure-journal>4. Setting Up Journaling</a></li><li><a href=#troubleshooting-gjournal>5. Troubleshooting Journaling</a></li><li><a href=#further-reading>6. Further Reading</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/articles/gjournal-desktop/gjournal-desktop_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=https://docs.freebsd.org/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=https://docs.freebsd.org/en/languages><img src=https://docs.freebsd.org/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=https://docs.freebsd.org/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>