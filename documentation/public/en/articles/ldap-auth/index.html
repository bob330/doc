<!doctype html><html class=theme-light lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Guide for the configuration of an LDAP server for authentication on FreeBSD"><meta name=keywords content="LDAP,Authentication,OpenLDAP,configuration,guide,tutorial,FreeBSD"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/en/articles/ldap-auth/><title>LDAP Authentication | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="LDAP Authentication"><meta property="og:description" content="Guide for the configuration of an LDAP server for authentication on FreeBSD"><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="http://172.16.201.134:1313/en/articles/ldap-auth/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/en\/articles\/ldap-auth\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/en/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/en/books>Books</a></li><li><a href=http://172.16.201.134:1313/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>LDAP Authentication</h1><div class=copyright>Copyright © 2007-2008 The FreeBSD Documentation Project</div><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#preface>1. Preface</a></li><li><a href=#ldap>2. Configuring LDAP</a></li><li><a href=#client>3. Client Configuration</a></li><li><a href=#secure>4. Security Considerations</a></li><li><a href=#useful>Appendix A: Useful Aids</a></li><li><a href=#ssl-ca>Appendix B: OpenSSL Certificates for LDAP</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Abstract</p></div><div class=paragraph><p>This document is intended as a guide for the configuration of an LDAP server (principally an OpenLDAP server) for authentication on FreeBSD.
This is useful for situations where many servers need the same user accounts, for example as a replacement for NIS.</p></div><hr></div></div><div class=sect1><h2 id=preface>1. Preface<a class=anchor href=#preface></a></h2><div class=sectionbody><div class=paragraph><p>This document is intended to give the reader enough of an understanding of LDAP to configure an LDAP server.
This document will attempt to provide an explanation of <a class=package href=https://cgit.freebsd.org/ports/tree/net/nss_ldap/>net/nss_ldap</a> and <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> for use with client machines services for use with the LDAP server.</p></div><div class=paragraph><p>When finished, the reader should be able to configure and deploy a FreeBSD server that can host an LDAP directory, and to configure and deploy a FreeBSD server which can authenticate against an LDAP directory.</p></div><div class=paragraph><p>This article is not intended to be an exhaustive account of the security, robustness, or best practice considerations for configuring LDAP or the other services discussed herein.
While the author takes care to do everything correctly, they do not address security issues beyond a general scope.
This article should be considered to lay the theoretical groundwork only, and any actual implementation should be accompanied by careful requirement analysis.</p></div></div></div><div class=sect1><h2 id=ldap>2. Configuring LDAP<a class=anchor href=#ldap></a></h2><div class=sectionbody><div class=paragraph><p>LDAP stands for "Lightweight Directory Access Protocol" and is a subset of the X.500 Directory Access Protocol.
Its most recent specifications are in <a href=http://www.ietf.org/rfc/rfc4510.txt>RFC4510</a> and friends.
Essentially it is a database that expects to be read from more often than it is written to.</p></div><div class=paragraph><p>The LDAP server <a href=http://www.openldap.org/>OpenLDAP</a> will be used in the examples in this document; while the principles here should be generally applicable to many different servers, most of the concrete administration is OpenLDAP-specific.
There are several server versions in ports, for example <a class=package href=https://cgit.freebsd.org/ports/tree/net/openldap26-server/>net/openldap26-server</a>.
Client servers will need the corresponding <a class=package href=https://cgit.freebsd.org/ports/tree/net/openldap26-client/>net/openldap26-client</a> libraries.</p></div><div class=paragraph><p>There are (basically) two areas of the LDAP service which need configuration.
The first is setting up a server to receive connections properly, and the second is adding entries to the server’s directory so that FreeBSD tools know how to interact with it.</p></div><div class=sect2><h3 id=ldap-connect>2.1. Setting Up the Server for Connections<a class=anchor href=#ldap-connect></a></h3><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>This section is specific to OpenLDAP.
If you are using another server, you will need to consult that server’s documentation.</p></div></td></tr></tbody></table></div><div class=sect3><h4 id=ldap-connect-install>2.1.1. Installing OpenLDAP<a class=anchor href=#ldap-connect-install></a></h4><div class=paragraph><p>First, install OpenLDAP:</p></div><div id=oldap-install class=exampleblock><div class=title>Example 1. Installing OpenLDAP</div><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># cd /usr/ports/net/openldap26-server</span>
<span class=c># make install clean</span></code></pre></div></div></div></div><div class=paragraph><p>This installs the <code>slapd</code> and <code>slurpd</code> binaries, along with the required OpenLDAP libraries.</p></div></div><div class=sect3><h4 id=ldap-connect-config>2.1.2. Configuring OpenLDAP<a class=anchor href=#ldap-connect-config></a></h4><div class=paragraph><p>Next we must configure OpenLDAP.</p></div><div class=paragraph><p>You will want to require encryption in your connections to the LDAP server; otherwise your users' passwords will be transferred in plain text, which is considered insecure.
The tools we will be using support two very similar kinds of encryption, SSL and TLS.</p></div><div class=paragraph><p>TLS stands for "Transportation Layer Security".
Services that employ TLS tend to connect on the <em>same</em> ports as the same services without TLS; thus an SMTP server which supports TLS will listen for connections on port 25, and an LDAP server will listen on 389.</p></div><div class=paragraph><p>SSL stands for "Secure Sockets Layer", and services that implement SSL do <em>not</em> listen on the same ports as their non-SSL counterparts.
Thus SMTPS listens on port 465 (not 25), HTTPS listens on 443, and LDAPS on 636.</p></div><div class=paragraph><p>The reason SSL uses a different port than TLS is because a TLS connection begins as plain text, and switches to encrypted traffic after the <code>STARTTLS</code> directive.
SSL connections are encrypted from the beginning.
Other than that there are no substantial differences between the two.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>We will adjust OpenLDAP to use TLS, as SSL is considered deprecated.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Once OpenLDAP is installed via ports, the following configuration parameters in <span class=filename>/usr/local/etc/openldap/slapd.conf</span> will enable TLS:</p></div><div class="literalblock programlisting"><div class=content><pre>security ssf=128

TLSCertificateFile /path/to/your/cert.crt
TLSCertificateKeyFile /path/to/your/cert.key
TLSCACertificateFile /path/to/your/cacert.crt</pre></div></div><div class=paragraph><p>Here, <code>ssf=128</code> tells OpenLDAP to require 128-bit encryption for all connections, both search and update.
This parameter may be configured based on the security needs of your site, but rarely you need to weaken it, as most LDAP client libraries support strong encryption.</p></div><div class=paragraph><p>The <span class=filename>cert.crt</span>, <span class=filename>cert.key</span>, and <span class=filename>cacert.crt</span> files are necessary for clients to authenticate <em>you</em> as the valid LDAP server.
If you simply want a server that runs, you can create a self-signed certificate with OpenSSL:</p></div><div id=genrsa class=exampleblock><div class=title>Example 2. Generating an RSA Key</div><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% openssl genrsa <span class=nt>-out</span> cert.key 1024
Generating RSA private key, 1024 bit long modulus
....................++++++
...++++++
e is 65537 <span class=o>(</span>0x10001<span class=o>)</span>

% openssl req <span class=nt>-new</span> <span class=nt>-key</span> cert.key <span class=nt>-out</span> cert.csr</code></pre></div></div></div></div><div class=paragraph><p>At this point you should be prompted for some values.
You may enter whatever values you like; however, it is important the "Common Name" value be the fully qualified domain name of the OpenLDAP server.
In our case, and the examples here, the server is <em>server.example.org</em>.
Incorrectly setting this value will cause clients to fail when making connections.
This can the cause of great frustration, so ensure that you follow these steps closely.</p></div><div class=paragraph><p>Finally, the certificate signing request needs to be signed:</p></div><div id=self-sign class=exampleblock><div class=title>Example 3. Self-signing the Certificate</div><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% openssl x509 <span class=nt>-req</span> <span class=nt>-in</span> cert.csr <span class=nt>-days</span> 365 <span class=nt>-signkey</span> cert.key <span class=nt>-out</span> cert.crt
Signature ok
<span class=nv>subject</span><span class=o>=</span>/C<span class=o>=</span>AU/ST<span class=o>=</span>Some-State/O<span class=o>=</span>Internet Widgits Pty Ltd
Getting Private key</code></pre></div></div></div></div><div class=paragraph><p>This will create a self-signed certificate that can be used for the directives in <span class=filename>slapd.conf</span>, where <span class=filename>cert.crt</span> and <span class=filename>cacert.crt</span> are the same file.
If you are going to use many OpenLDAP servers (for replication via <code>slurpd</code>) you
will want to see <a href=../ldap-auth/#ssl-ca>OpenSSL Certificates for LDAP</a> to generate a CA key and use it to sign individual server certificates.</p></div><div class=paragraph><p>Once this is done, put the following in <span class=filename>/etc/rc.conf</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>slapd_enable=&#34;YES&#34;</pre></div></div><div class=paragraph><p>Then run <code>/usr/local/etc/rc.d/slapd start</code>.
This should start OpenLDAP.
Confirm that it is listening on 389 with</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% sockstat <span class=nt>-4</span> <span class=nt>-p</span> 389
ldap     slapd      3261  7  tcp4   <span class=k>*</span>:389                 <span class=k>*</span>:<span class=k>*</span></code></pre></div></div></div><div class=sect3><h4 id=ldap-connect-client>2.1.3. Configuring the Client<a class=anchor href=#ldap-connect-client></a></h4><div class=paragraph><p>Install the <a class=package href=https://cgit.freebsd.org/ports/tree/net/openldap26-client/>net/openldap26-client</a> port for the OpenLDAP libraries.
The client machines will always have OpenLDAP libraries since that is all <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> and <a class=package href=https://cgit.freebsd.org/ports/tree/net/nss_ldap/>net/nss_ldap</a> support, at least for the moment.</p></div><div class=paragraph><p>The configuration file for the OpenLDAP libraries is <span class=filename>/usr/local/etc/openldap/ldap.conf</span>.
Edit this file to contain the following values:</p></div><div class="literalblock programlisting"><div class=content><pre>base dc=example,dc=org
uri ldap://server.example.org/
ssl start_tls
tls_cacert /path/to/your/cacert.crt</pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>It is important that your clients have access to <span class=filename>cacert.crt</span>, otherwise they will not be able to connect.</p></div></td></tr></tbody></table></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>There are two files called <span class=filename>ldap.conf</span>.
The first is this file, which is for the OpenLDAP libraries and defines how to talk to the server.
The second is <span class=filename>/usr/local/etc/ldap.conf</span>, and is for pam_ldap.</p></div></td></tr></tbody></table></div><div class=paragraph><p>At this point you should be able to run <code>ldapsearch -Z</code> on the client machine; <code>-Z</code> means "use TLS".
If you encounter an error, then something is configured wrong; most likely it is your certificates.
Use <a href="https://man.freebsd.org/cgi/man.cgi?query=openssl&amp;sektion=1&amp;format=html">openssl(1)</a>'s <code>s_client</code> and <code>s_server</code> to ensure you have them configured and signed properly.</p></div></div></div><div class=sect2><h3 id=ldap-database>2.2. Entries in the Database<a class=anchor href=#ldap-database></a></h3><div class=paragraph><p>Authentication against an LDAP directory is generally accomplished by attempting to bind to the directory as the connecting user.
This is done by establishing a "simple" bind on the directory with the user name supplied.
If there is an entry with the <code>uid</code> equal to the user name and that entry’s <code>userPassword</code> attribute matches the password supplied, then the bind is successful.</p></div><div class=paragraph><p>The first thing we have to do is figure out is where in the directory our users will live.</p></div><div class=paragraph><p>The base entry for our database is <code>dc=example,dc=org</code>.
The default location for users that most clients seem to expect is something like <code>ou=people,<em>base</em></code>, so that is what will be used here.
However keep in mind that this is configurable.</p></div><div class=paragraph><p>So the ldif entry for the <code>people</code> organizational unit will look like:</p></div><div class="literalblock programlisting"><div class=content><pre>dn: ou=people,dc=example,dc=org
objectClass: top
objectClass: organizationalUnit
ou: people</pre></div></div><div class=paragraph><p>All users will be created as subentries of this organizational unit.</p></div><div class=paragraph><p>Some thought might be given to the object class your users will belong to.
Most tools by default will use <code>people</code>, which is fine if you simply want to provide entries against which to authenticate.
However, if you are going to store user information in the LDAP database as well, you will probably want to use <code>inetOrgPerson</code>, which has many useful attributes.
In either case, the relevant schemas need to be loaded in <span class=filename>slapd.conf</span>.</p></div><div class=paragraph><p>For this example we will use the <code>person</code> object class.
If you are using <code>inetOrgPerson</code>, the steps are basically identical, except that the <code>sn</code> attribute is required.</p></div><div class=paragraph><p>To add a test-user named <code>tuser</code>, the ldif would be:</p></div><div class="literalblock programlisting"><div class=content><pre>dn: uid=tuser,ou=people,dc=example,dc=org
objectClass: person
objectClass: posixAccount
objectClass: shadowAccount
objectClass: top
uidNumber: 10000
gidNumber: 10000
homeDirectory: /home/tuser
loginShell: /bin/csh
uid: tuser
cn: tuser</pre></div></div><div class=paragraph><p>I start my LDAP users' UIDs at 10000 to avoid collisions with system accounts; you can configure whatever number you wish here, as long as it is less than 65536.</p></div><div class=paragraph><p>We also need group entries.
They are as configurable as user entries, but we will use the defaults below:</p></div><div class="literalblock programlisting"><div class=content><pre>dn: ou=groups,dc=example,dc=org
objectClass: top
objectClass: organizationalUnit
ou: groups

dn: cn=tuser,ou=groups,dc=example,dc=org
objectClass: posixGroup
objectClass: top
gidNumber: 10000
cn: tuser</pre></div></div><div class=paragraph><p>To enter these into your database, you can use <code>slapadd</code> or <code>ldapadd</code> on a file containing these entries.
Alternatively, you can use <a class=package href=https://cgit.freebsd.org/ports/tree/sysutils/ldapvi/>sysutils/ldapvi</a>.</p></div><div class=paragraph><p>The <code>ldapsearch</code> utility on the client machine should now return these entries.
If it does, your database is properly configured to be used as an LDAP authentication server.</p></div></div></div></div><div class=sect1><h2 id=client>3. Client Configuration<a class=anchor href=#client></a></h2><div class=sectionbody><div class=paragraph><p>The client should already have OpenLDAP libraries from
<a href=../ldap-auth/#ldap-connect-client>Configuring the Client</a>, but if you are installing several client machines you will need to install <a class=package href=https://cgit.freebsd.org/ports/tree/net/openldap26-client/>net/openldap26-client</a> on each of them.</p></div><div class=paragraph><p>FreeBSD requires two ports to be installed to authenticate against an LDAP server, <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> and <a class=package href=https://cgit.freebsd.org/ports/tree/net/nss_ldap/>net/nss_ldap</a>.</p></div><div class=sect2><h3 id=client-auth>3.1. Authentication<a class=anchor href=#client-auth></a></h3><div class=paragraph><p><a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> is configured via <span class=filename>/usr/local/etc/ldap.conf</span>.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>This is a <em>different file</em> than the OpenLDAP library functions' configuration file, <span class=filename>/usr/local/etc/openldap/ldap.conf</span>; however, it takes many of the same options; in fact it is a superset of that file.
For the rest of this section, references to <span class=filename>ldap.conf</span> will mean <span class=filename>/usr/local/etc/ldap.conf</span>.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Thus, we will want to copy all of our original configuration parameters from <span class=filename>openldap/ldap.conf</span> to the new <span class=filename>ldap.conf</span>.
Once this is done, we want to tell <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> what to look for on the directory server.</p></div><div class=paragraph><p>We are identifying our users with the <code>uid</code> attribute.
To configure this (though it is the default), set the <code>pam_login_attribute</code> directive in <span class=filename>ldap.conf</span>:</p></div><div id=set-pam-login-attr class=exampleblock><div class=title>Example 4. Setting <code>pam_login_attribute</code></div><div class=content><div class="literalblock programlisting"><div class=content><pre>pam_login_attribute uid</pre></div></div></div></div><div class=paragraph><p>With this set, <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a> will search the entire LDAP directory under <code>base</code> for the value <code>uid=<em>username</em></code>.
If it finds one and only one entry, it will attempt to bind as that user with the password it was given.
If it binds correctly, then it will allow access.
Otherwise it will fail.</p></div><div class=paragraph><p>Users whose shell is not in <span class=filename>/etc/shells</span> will not be able to log in.
This is particularly important when Bash is set as the user shell on the LDAP server.
Bash is not included with a default installation of FreeBSD.
When installed from a package or port, it is located at <span class=filename>/usr/local/bin/bash</span>.
Verify that the path to the shell on the server is set correctly:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% getent passwd username</code></pre></div></div><div class=paragraph><p>There are two choices when the output shows <code>/bin/bash</code> in the last column.
The first is to change the user’s entry on the LDAP server to <span class=filename>/usr/local/bin/bash</span>.
The second option is to create a symlink on the LDAP client computer so Bash is found at the correct location:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># ln -s /usr/local/bin/bash /bin/bash</span></code></pre></div></div><div class=paragraph><p>Make sure that <span class=filename>/etc/shells</span> contains entries for both <code>/usr/local/bin/bash</code> and <code>/bin/bash</code>.
The user will then be able to log in to the system with Bash as their shell.</p></div><div class=sect3><h4 id=client-auth-pam>3.1.1. PAM<a class=anchor href=#client-auth-pam></a></h4><div class=paragraph><p>PAM, which stands for "Pluggable Authentication Modules", is the method by which FreeBSD authenticates most of its sessions.
To tell FreeBSD we wish to use an LDAP server, we will have to add a line to the appropriate PAM file.</p></div><div class=paragraph><p>Most of the time the appropriate PAM file is <span class=filename>/etc/pam.d/sshd</span>, if you want to use SSH (remember to set the relevant options in <span class=filename>/etc/ssh/sshd_config</span>, otherwise SSH will not use PAM).</p></div><div class=paragraph><p>To use PAM for authentication, add the line</p></div><div class="literalblock programlisting"><div class=content><pre>auth  sufficient  /usr/local/lib/pam_ldap.so  no_warn</pre></div></div><div class=paragraph><p>Exactly where this line shows up in the file and which options appear in the fourth column determine the exact behavior of the authentication mechanism; see <a href="https://man.freebsd.org/cgi/man.cgi?query=pam&amp;sektion=d&amp;format=html">pam(d)</a></p></div><div class=paragraph><p>With this configuration you should be able to authenticate a user against an LDAP directory.
PAM will perform a bind with your credentials, and if successful will tell SSH to allow access.</p></div><div class=paragraph><p>However it is not a good idea to allow <em>every</em> user in the directory into <em>every</em> client machine.
With the current configuration, all that a user needs to log into a machine is an LDAP entry.
Fortunately there are a few ways to restrict user access.</p></div><div class=paragraph><p><span class=filename>ldap.conf</span> supports a <code>pam_groupdn</code> directive; every account that connects to this machine needs to be a member of the group specified here.
For example, if you have</p></div><div class="literalblock programlisting"><div class=content><pre>pam_groupdn cn=servername,ou=accessgroups,dc=example,dc=org</pre></div></div><div class=paragraph><p>in <span class=filename>ldap.conf</span>, then only members of that group will be able to log in.
There are a few things to bear in mind, however.</p></div><div class=paragraph><p>Members of this group are specified in one or more <code>memberUid</code> attributes, and each attribute must have the full distinguished name of the member.
So <code>memberUid: someuser</code> will not work; it must be:</p></div><div class="literalblock programlisting"><div class=content><pre>memberUid: uid=someuser,ou=people,dc=example,dc=org</pre></div></div><div class=paragraph><p>Additionally, this directive is not checked in PAM during authentication, it is checked during account management, so you will need a second line in your PAM files under <code>account</code>.
This will require, in turn, <em>every</em> user to be listed in the group, which is not necessarily what we want.
To avoid blocking users that are not in LDAP, you should enable the <code>ignore_unknown_user</code> attribute.
Finally, you should set the <code>ignore_authinfo_unavail</code> option so that you are not locked out of every computer when the LDAP server is unavailable.</p></div><div class=paragraph><p>Your <span class=filename>pam.d/sshd</span> might then end up looking like this:</p></div><div id=pam class=exampleblock><div class=title>Example 5. Sample <span class=filename>pam.d/sshd</span></div><div class=content><div class="literalblock programlisting"><div class=content><pre>auth            required        pam_nologin.so          no_warn
auth            sufficient      pam_opie.so             no_warn no_fake_prompts
auth            requisite       pam_opieaccess.so       no_warn allow_local
auth            sufficient      /usr/local/lib/pam_ldap.so      no_warn
auth            required        pam_unix.so             no_warn try_first_pass

account         required        pam_login_access.so
account         required        /usr/local/lib/pam_ldap.so      no_warn ignore_authinfo_unavail ignore_unknown_user</pre></div></div></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Since we are adding these lines specifically to <span class=filename>pam.d/sshd</span>, this will only have an effect on SSH sessions.
LDAP users will be unable to log in at the console.
To change this behavior, examine the other files in <span class=filename>/etc/pam.d</span> and modify them accordingly.</p></div></td></tr></tbody></table></div></div></div><div class=sect2><h3 id=client-nss>3.2. Name Service Switch<a class=anchor href=#client-nss></a></h3><div class=paragraph><p>NSS is the service that maps attributes to names.
So, for example, if a file is owned by user <code>1001</code>, an application will query NSS for the name of <code>1001</code>, and it might get <code>bob</code> or <code>ted</code> or whatever the user’s name is.</p></div><div class=paragraph><p>Now that our user information is kept in LDAP, we need to tell NSS to look there when queried.</p></div><div class=paragraph><p>The <a class=package href=https://cgit.freebsd.org/ports/tree/net/nss_ldap/>net/nss_ldap</a> port does this.
It uses the same configuration file as <a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_ldap/>security/pam_ldap</a>, and should not need any extra parameters once it is installed.
Instead, what is left is simply to edit <span class=filename>/etc/nsswitch.conf</span> to take advantage of the directory.
Simply replace the following lines:</p></div><div class="literalblock programlisting"><div class=content><pre>group: compat
passwd: compat</pre></div></div><div class=paragraph><p>with</p></div><div class="literalblock programlisting"><div class=content><pre>group: files ldap
passwd: files ldap</pre></div></div><div class=paragraph><p>This will allow you to map usernames to UIDs and UIDs to usernames.</p></div><div class=paragraph><p>Congratulations! You should now have working LDAP authentication.</p></div></div><div class=sect2><h3 id=caveats>3.3. Caveats<a class=anchor href=#caveats></a></h3><div class=paragraph><p>Unfortunately, as of the time this was written FreeBSD did not support changing user passwords with <a href="https://man.freebsd.org/cgi/man.cgi?query=passwd&amp;sektion=1&amp;format=html">passwd(1)</a>.
As a result of this, most administrators are left to implement a solution themselves.
I provide some examples here.
Note that if you write your own password change script, there are some security
issues you should be made aware of; see <a href=../ldap-auth/#security-passwd>Password Storage</a></p></div><div id=chpw-shell class=exampleblock><div class=title>Example 6. Shell Script for Changing Passwords</div><div class=content><div class="literalblock programlisting"><div class=content><pre>#!/bin/sh

stty -echo
read -p &#34;Old Password: &#34; oldp; echo
read -p &#34;New Password: &#34; np1; echo
read -p &#34;Retype New Password: &#34; np2; echo
stty echo

if [ &#34;$np1&#34; != &#34;$np2&#34; ]; then
  echo &#34;Passwords do not match.&#34;
  exit 1
fi

ldappasswd -D uid=&#34;$USER&#34;,ou=people,dc=example,dc=org \
  -w &#34;$oldp&#34; \
  -a &#34;$oldp&#34; \
  -s &#34;$np1&#34;</pre></div></div></div></div><div class="admonitionblock caution"><table><tbody><tr><td class=icon><i class="fa icon-caution" title=Caution></i></td><td class=content><div class=paragraph><p>This script does hardly any error checking, but more important it is very cavalier about how it stores your passwords.
If you do anything like this, at least adjust the <code>security.bsd.see_other_uids</code> sysctl value:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># sysctl security.bsd.see_other_uids=0</span></code></pre></div></div></td></tr></tbody></table></div><div class=paragraph><p>A more flexible (and probably more secure) approach can be used by writing a custom program, or even a web interface.
The following is part of a Ruby library that can change LDAP passwords.
It sees use both on the command line, and on the web.</p></div><div id=chpw-ruby class=exampleblock><div class=title>Example 7. Ruby Script for Changing Passwords</div><div class=content><div class="literalblock programlisting"><div class=content><pre>require &#39;ldap&#39;
require &#39;base64&#39;
require &#39;digest&#39;
require &#39;password&#39; # ruby-password

ldap_server = &#34;ldap.example.org&#34;
luser = &#34;uid=#{ENV[&#39;USER&#39;]},ou=people,dc=example,dc=org&#34;

# get the new password, check it, and create a salted hash from it
def get_password
  pwd1 = Password.get(&#34;New Password: &#34;)
  pwd2 = Password.get(&#34;Retype New Password: &#34;)

  raise if pwd1 != pwd2
  pwd1.check # check password strength

  salt = rand.to_s.gsub(/0\./, &#39;&#39;)
  pass = pwd1.to_s
  hash = &#34;{SSHA}&#34;+Base64.encode64(Digest::SHA1.digest(&#34;#{pass}#{salt}&#34;)+salt).chomp!
  return hash
end

oldp = Password.get(&#34;Old Password: &#34;)
newp = get_password

# We&#39;ll just replace it.  That we can bind proves that we either know
# the old password or are an admin.

replace = LDAP::Mod.new(LDAP::LDAP_MOD_REPLACE | LDAP::LDAP_MOD_BVALUES,
                        &#34;userPassword&#34;,
                        [newp])

conn = LDAP::SSLConn.new(ldap_server, 389, true)
conn.set_option(LDAP::LDAP_OPT_PROTOCOL_VERSION, 3)
conn.bind(luser, oldp)
conn.modify(luser, [replace])</pre></div></div></div></div><div class=paragraph><p>Although not guaranteed to be free of security holes (the password is kept in memory, for example) this is cleaner and more flexible than a simple <code>sh</code> script.</p></div></div></div></div><div class=sect1><h2 id=secure>4. Security Considerations<a class=anchor href=#secure></a></h2><div class=sectionbody><div class=paragraph><p>Now that your machines (and possibly other services) are authenticating against your LDAP server, this server needs to be protected at least as well as <span class=filename>/etc/master.passwd</span> would be on a regular server, and possibly even more so since a broken or cracked LDAP server would break every client service.</p></div><div class=paragraph><p>Remember, this section is not exhaustive.
You should continually review your configuration and procedures for improvements.</p></div><div class=sect2><h3 id=secure-readonly>4.1. Setting Attributes Read-only<a class=anchor href=#secure-readonly></a></h3><div class=paragraph><p>Several attributes in LDAP should be read-only.
If left writable by the user, for example, a user could change his <code>uidNumber</code> attribute to <code>0</code> and get <code>root</code> access!</p></div><div class=paragraph><p>To begin with, the <code>userPassword</code> attribute should not be world-readable.
By default, anyone who can connect to the LDAP server can read this attribute.
To disable this, put the following in <span class=filename>slapd.conf</span>:</p></div><div id=hide-userpass class=exampleblock><div class=title>Example 8. Hide Passwords</div><div class=content><div class="literalblock programlisting"><div class=content><pre>access to dn.subtree=&#34;ou=people,dc=example,dc=org&#34;
  attrs=userPassword
  by self write
  by anonymous auth
  by * none

access to *
  by self write
  by * read</pre></div></div></div></div><div class=paragraph><p>This will disallow reading of the <code>userPassword</code> attribute, while still allowing users to change their own passwords.</p></div><div class=paragraph><p>Additionally, you’ll want to keep users from changing some of their own attributes.
By default, users can change any attribute (except for those which the LDAP schemas themselves deny changes), such as <code>uidNumber</code>.
To close this hole, modify the above to</p></div><div id=attrib-readonly class=exampleblock><div class=title>Example 9. Read-only Attributes</div><div class=content><div class="literalblock programlisting"><div class=content><pre>access to dn.subtree=&#34;ou=people,dc=example,dc=org&#34;
  attrs=userPassword
  by self write
  by anonymous auth
  by * none

access to attrs=homeDirectory,uidNumber,gidNumber
  by * read

access to *
  by self write
  by * read</pre></div></div></div></div><div class=paragraph><p>This will stop users from being able to masquerade as other users.</p></div></div><div class=sect2><h3 id=secure-root>4.2. <code>root</code> Account Definition<a class=anchor href=#secure-root></a></h3><div class=paragraph><p>Often the <code>root</code> or manager account for the LDAP service will be defined in the configuration file.
OpenLDAP supports this, for example, and it works, but it can lead to trouble if <span class=filename>slapd.conf</span> is compromised.
It may be better to use this only to bootstrap yourself into LDAP, and then define a <code>root</code> account there.</p></div><div class=paragraph><p>Even better is to define accounts that have limited permissions, and omit a <code>root</code> account entirely.
For example, users that can add or remove user accounts are added to one group, but they cannot themselves change the membership of this group.
Such a security policy would help mitigate the effects of a leaked password.</p></div><div class=sect3><h4 id=manager-acct>4.2.1. Creating a Management Group<a class=anchor href=#manager-acct></a></h4><div class=paragraph><p>Say you want your IT department to be able to change home directories for users, but you do not want all of them to be able to add or remove users.
The way to do this is to add a group for these admins:</p></div><div id=manager-acct-dn class=exampleblock><div class=title>Example 10. Creating a Management Group</div><div class=content><div class="literalblock programlisting"><div class=content><pre>dn: cn=homemanagement,dc=example,dc=org
objectClass: top
objectClass: posixGroup
cn: homemanagement
gidNumber: 121 # required for posixGroup
memberUid: uid=tuser,ou=people,dc=example,dc=org
memberUid: uid=user2,ou=people,dc=example,dc=org</pre></div></div></div></div><div class=paragraph><p>And then change the permissions attributes in <span class=filename>slapd.conf</span>:</p></div><div id=management-acct-acl class=exampleblock><div class=title>Example 11. ACLs for a Home Directory Management Group</div><div class=content><div class="literalblock programlisting"><div class=content><pre>access to dn.subtree=&#34;ou=people,dc=example,dc=org&#34;
  attr=homeDirectory
  by dn=&#34;cn=homemanagement,dc=example,dc=org&#34;
  dnattr=memberUid write</pre></div></div></div></div><div class=paragraph><p>Now <code>tuser</code> and <code>user2</code> can change other users' home directories.</p></div><div class=paragraph><p>In this example we have given a subset of administrative power to certain users without giving them power in other domains.
The idea is that soon no single user account has the power of a <code>root</code> account, but every power root had is had by at least one user.
The <code>root</code> account then becomes unnecessary and can be removed.</p></div></div></div><div class=sect2><h3 id=security-passwd>4.3. Password Storage<a class=anchor href=#security-passwd></a></h3><div class=paragraph><p>By default OpenLDAP will store the value of the <code>userPassword</code> attribute as it stores any other data: in the clear.
Most of the time it is base 64 encoded, which provides enough protection to keep an honest administrator from knowing your password, but little else.</p></div><div class=paragraph><p>It is a good idea, then, to store passwords in a more secure format, such as SSHA (salted SHA).
This is done by whatever program you use to change users' passwords.</p></div></div></div></div><div class=sect1><h2 id=useful>Appendix A: Useful Aids<a class=anchor href=#useful></a></h2><div class=sectionbody><div class=paragraph><p>There are a few other programs that might be useful, particularly if you have many users and do not want to configure everything manually.</p></div><div class=paragraph><p><a class=package href=https://cgit.freebsd.org/ports/tree/security/pam_mkhomedir/>security/pam_mkhomedir</a> is a PAM module that always succeeds; its purpose is to create home directories for users which do not have them.
If you have dozens of client servers and hundreds of users, it is much easier to use this and set up skeleton directories than to prepare every home directory.</p></div><div class=paragraph><p><a class=package href=https://cgit.freebsd.org/ports/tree/sysutils/ldapvi/>sysutils/ldapvi</a> is a great utility for editing LDAP values in an LDIF-like syntax.
The directory (or subsection of the directory) is presented in the editor chosen by the <code>EDITOR</code> environment variable.
This makes it easy to enable large-scale changes in the directory without having to write a custom tool.</p></div><div class=paragraph><p><a class=package href=https://cgit.freebsd.org/ports/tree/security/openssh-portable/>security/openssh-portable</a> has the ability to contact an LDAP server to verify SSH keys.
This is extremely nice if you have many servers and do not want to copy your public keys across all of them.</p></div></div></div><div class=sect1><h2 id=ssl-ca>Appendix B: OpenSSL Certificates for LDAP<a class=anchor href=#ssl-ca></a></h2><div class=sectionbody><div class=paragraph><p>If you are hosting two or more LDAP servers, you will probably not want to use self-signed certificates, since each client will have to be configured to work with each certificate.
While this is possible, it is not nearly as simple as creating your own certificate authority, and signing your servers' certificates with that.</p></div><div class=paragraph><p>The steps here are presented as they are with very little attempt at explaining what is going on-further explanation can be found in <a href="https://man.freebsd.org/cgi/man.cgi?query=openssl&amp;sektion=1&amp;format=html">openssl(1)</a> and its friends.</p></div><div class=paragraph><p>To create a certificate authority, we simply need a self-signed certificate and key.
The steps for this again are</p></div><div id=make-cert class=exampleblock><div class=title>Example 12. Creating a Certificate</div><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% openssl genrsa <span class=nt>-out</span> root.key 1024
% openssl req <span class=nt>-new</span> <span class=nt>-key</span> root.key <span class=nt>-out</span> root.csr
% openssl x509 <span class=nt>-req</span> <span class=nt>-days</span> 1024 <span class=nt>-in</span> root.csr <span class=nt>-signkey</span> root.key <span class=nt>-out</span> root.crt</code></pre></div></div></div></div><div class=paragraph><p>These will be your root CA key and certificate.
You will probably want to encrypt the key and store it in a cool, dry place; anyone with access to it can masquerade as one of your LDAP servers.</p></div><div class=paragraph><p>Next, using the first two steps above create a key <span class=filename>ldap-server-one.key</span> and certificate signing request <span class=filename>ldap-server-one.csr</span>.
Once you sign the signing request with <span class=filename>root.key</span>, you will be able to use <span class=filename>ldap-server-one.*</span> on your LDAP servers.</p></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>Do not forget to use the fully qualified domain name for the "common name" attribute when generating the certificate signing request; otherwise clients will reject a connection with you, and it can be very tricky to diagnose.</p></div></td></tr></tbody></table></div><div class=paragraph><p>To sign the key, use <code>-CA</code> and <code>-CAkey</code> instead of <code>-signkey</code>:</p></div><div id=ca-sign class=exampleblock><div class=title>Example 13. Signing as a Certificate Authority</div><div class=content><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% openssl x509 <span class=nt>-req</span> <span class=nt>-days</span> 1024 <span class=se>\</span>
<span class=nt>-in</span> ldap-server-one.csr <span class=nt>-CA</span> root.crt <span class=nt>-CAkey</span> root.key <span class=se>\</span>
<span class=nt>-out</span> ldap-server-one.crt</code></pre></div></div></div></div><div class=paragraph><p>The resulting file will be the certificate that you can use on your LDAP servers.</p></div><div class=paragraph><p>Finally, for clients to trust all your servers, distribute <span class=filename>root.crt</span> (the <em>certificate</em>, not the key!) to each client, and specify it in the <code>TLSCACertificateFile</code> directive in <span class=filename>ldap.conf</span>.</p></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: September 23, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=c6f45f0053" target=_blank>Fernando Apesteguía</a></p></div></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#preface>1. Preface</a></li><li><a href=#ldap>2. Configuring LDAP</a></li><li><a href=#client>3. Client Configuration</a></li><li><a href=#secure>4. Security Considerations</a></li><li><a href=#useful>Appendix A: Useful Aids</a></li><li><a href=#ssl-ca>Appendix B: OpenSSL Certificates for LDAP</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/articles/ldap-auth/ldap-auth_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/en/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>