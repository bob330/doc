<!doctype html><html class=theme-light lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Independent Verification of IPsec Functionality in FreeBSD"><meta name=keywords content="IPsec,verification,FreeBSD"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/en/articles/ipsec-must/><title>Independent Verification of IPsec Functionality in FreeBSD | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Independent Verification of IPsec Functionality in FreeBSD"><meta property="og:description" content="Independent Verification of IPsec Functionality in FreeBSD"><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="http://172.16.201.134:1313/en/articles/ipsec-must/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/en\/articles\/ipsec-must\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/en/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/en/books>Books</a></li><li><a href=http://172.16.201.134:1313/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>Independent Verification of IPsec Functionality in FreeBSD</h1><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>Motif, OSF/1, and UNIX are registered trademarks and IT DialTone and The Open Group are trademarks of The Open Group in the United States and other countries.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#problem>1. The Problem</a></li><li><a href=#solution>2. The Solution</a></li><li><a href=#experiment>3. The Experiment</a></li><li><a href=#caveat>4. Caveat</a></li><li><a href=#IPsec>5. IPsec---Definition</a></li><li><a href=#ipsec-install>6. Installing IPsec</a></li><li><a href=#kernel>7. src/sys/i386/conf/KERNELNAME</a></li><li><a href=#code>8. Maurer’s Universal Statistical Test (for block size=8 bits)</a></li></ul></nav></div><div id=preamble><div class=sectionbody><div class="paragraph abstract-title"><p>Abstract</p></div><div class=paragraph><p>You installed IPsec and it seems to be working.
How do you know? I describe a method for experimentally verifying that IPsec is working.</p></div><hr></div></div><div class=sect1><h2 id=problem>1. The Problem<a class=anchor href=#problem></a></h2><div class=sectionbody><div class=paragraph><p>First, lets assume you have <a href=../:ipsec-must/#ipsec-install>Installing IPsec</a>.
How do you know it is <a href=../:ipsec-must/#caveat>Caveat</a>? Sure, your connection will not work if it is misconfigured, and it will work when you finally get it right.
<a href="https://man.freebsd.org/cgi/man.cgi?query=netstat&amp;sektion=1&amp;format=html">netstat(1)</a> will list it. But can you independently confirm it?</p></div></div></div><div class=sect1><h2 id=solution>2. The Solution<a class=anchor href=#solution></a></h2><div class=sectionbody><div class=paragraph><p>First, some crypto-relevant info theory:</p></div><div class="olist arabic"><ol class=arabic><li><p>Encrypted data is uniformly distributed, i.e., has maximal entropy per symbol;</p></li><li><p>Raw, uncompressed data is typically redundant, i.e., has sub-maximal entropy.</p></li></ol></div><div class=paragraph><p>Suppose you could measure the entropy of the data to- and from- your network interface.
Then you could see the difference between unencrypted data and encrypted data.
This would be true even if some of the data in "encrypted mode" was not encrypted---as the outermost IP header must be if the packet is to be routable.</p></div><div class=sect2><h3 id=MUST>2.1. MUST<a class=anchor href=#MUST></a></h3><div class=paragraph><p>Ueli Maurer’s "Universal Statistical Test for Random Bit Generators"(<a href=https://web.archive.org/web/20011115002319/http://www.geocities.com/SiliconValley/Code/4704/universal.pdf>MUST</a>) quickly measures the entropy of a sample.
It uses a compression-like algorithm.
<a href=../:ipsec-must/#code>Maurer’s Universal Statistical Test (for block size8 bits)</a> for a variant which measures successive (~quarter megabyte) chunks of a file.</p></div></div><div class=sect2><h3 id=tcpdump>2.2. Tcpdump<a class=anchor href=#tcpdump></a></h3><div class=paragraph><p>We also need a way to capture the raw network data.
A program called <a href="https://man.freebsd.org/cgi/man.cgi?query=tcpdump&amp;sektion=1&amp;format=html">tcpdump(1)</a> lets you do this, if you have enabled the
<em>Berkeley Packet Filter</em> interface in your <a href=../:ipsec-must/#kernel>src/sys/i386/conf/KERNELNAME</a>.</p></div><div class=paragraph><p>The command:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell> tcpdump <span class=nt>-c</span> 4000 <span class=nt>-s</span> 10000 <span class=nt>-w</span> dumpfile.bin</code></pre></div></div><div class=paragraph><p>will capture 4000 raw packets to <em>dumpfile.bin</em>.
Up to 10,000 bytes per packet will be captured in this example.</p></div></div></div></div><div class=sect1><h2 id=experiment>3. The Experiment<a class=anchor href=#experiment></a></h2><div class=sectionbody><div class=paragraph><p>Here is the experiment:</p></div><div class="exampleblock procedure"><div class=content><div class="olist arabic"><ol class=arabic><li><p>Open a window to an IPsec host and another window to an insecure host.</p></li><li><p>Now start <a href=../:ipsec-must/#tcpdump>Tcpdump</a>.</p></li><li><p>In the "secure" window, run the UNIX® command <a href="https://man.freebsd.org/cgi/man.cgi?query=yes&amp;sektion=1&amp;format=html">yes(1)</a>, which will stream the <code>y</code> character. After a while, stop this. Switch to the insecure window, and repeat. After a while, stop.</p></li><li><p>Now run <a href=../:ipsec-must/#code>Maurer’s Universal Statistical Test (for block size8 bits)</a> on the captured packets. You should see something like the following. The important thing to note is that the secure connection has 93% (6.7) of the expected value (7.18), and the "normal" connection has 29% (2.1) of the expected value.</p><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>% tcpdump <span class=nt>-c</span> 4000 <span class=nt>-s</span> 10000 <span class=nt>-w</span> ipsecdemo.bin
% uliscan ipsecdemo.bin
Uliscan 21 Dec 98
<span class=nv>L</span><span class=o>=</span>8 256 258560
Measuring file ipsecdemo.bin
Init <span class=k>done
</span>Expected value <span class=k>for </span><span class=nv>L</span><span class=o>=</span>8 is 7.1836656
6.9396 <span class=nt>--------------------------------------------------------</span>
6.6177 <span class=nt>-----------------------------------------------------</span>
6.4100 <span class=nt>---------------------------------------------------</span>
2.1101 <span class=nt>-----------------</span>
2.0838 <span class=nt>-----------------</span>
2.0983 <span class=nt>-----------------</span></code></pre></div></div></li></ol></div></div></div></div></div><div class=sect1><h2 id=caveat>4. Caveat<a class=anchor href=#caveat></a></h2><div class=sectionbody><div class=paragraph><p>This experiment shows that IPsec <em>does</em> seem to be distributing the payload data <em>uniformly</em>, as encryption should.
However, the experiment described here <em>cannot</em> detect many possible flaws in a system (none of which do I have any evidence for).
These include poor key generation or exchange, data or keys being visible to others, use of weak algorithms, kernel subversion, etc.
Study the source; know the code.</p></div></div></div><div class=sect1><h2 id=IPsec>5. IPsec---Definition<a class=anchor href=#IPsec></a></h2><div class=sectionbody><div class=paragraph><p>Internet Protocol security extensions to IPv4; required for IPv6.
A protocol for negotiating encryption and authentication at the IP (host-to-host) level.
SSL secures only one application socket; SSH secures only a login; PGP secures only a specified file or message.
IPsec encrypts everything between two hosts.</p></div></div></div><div class=sect1><h2 id=ipsec-install>6. Installing IPsec<a class=anchor href=#ipsec-install></a></h2><div class=sectionbody><div class=paragraph><p>Most of the modern versions of FreeBSD have IPsec support in their base source.
So you will need to include the <code>IPSEC</code> option in your kernel config and, after kernel rebuild and reinstall, configure IPsec connections using <a href="https://man.freebsd.org/cgi/man.cgi?query=setkey&amp;sektion=8&amp;format=html">setkey(8)</a> command.</p></div><div class=paragraph><p>A comprehensive guide on running IPsec on FreeBSD is provided in <a href=https://docs.freebsd.org/en/books/handbook/#ipsec>FreeBSD Handbook</a>.</p></div></div></div><div class=sect1><h2 id=kernel>7. src/sys/i386/conf/KERNELNAME<a class=anchor href=#kernel></a></h2><div class=sectionbody><div class=paragraph><p>This needs to be present in the kernel config file to capture network data with <a href="https://man.freebsd.org/cgi/man.cgi?query=tcpdump&amp;sektion=1&amp;format=html">tcpdump(1)</a>.
Be sure to run <a href="https://man.freebsd.org/cgi/man.cgi?query=config&amp;sektion=8&amp;format=html">config(8)</a> after adding this, and rebuild and reinstall.</p></div><div class="literalblock programlisting"><div class=content><pre>device	bpf</pre></div></div></div></div><div class=sect1><h2 id=code>8. Maurer’s Universal Statistical Test (for block size=8 bits)<a class=anchor href=#code></a></h2><div class=sectionbody><div class=paragraph><p>You can find the same code at <a href=https://web.archive.org/web/20031204230654/http://www.geocities.com:80/SiliconValley/Code/4704/uliscanc.txt>this link</a>.</p></div><div class="literalblock programlisting"><div class=content><pre>/*
  ULISCAN.c   ---blocksize of 8

  1 Oct 98
  1 Dec 98
  21 Dec 98       uliscan.c derived from ueli8.c

  This version has // comments removed for Sun cc

  This implements Ueli M Maurer&#39;s &#34;Universal Statistical Test for Random
  Bit Generators&#34; using L=8

  Accepts a filename on the command line; writes its results, with other
  info, to stdout.

  Handles input file exhaustion gracefully.

  Ref: J. Cryptology v 5 no 2, 1992 pp 89-105
  also on the web somewhere, which is where I found it.

  -David Honig
  honig@sprynet.com

  Usage:
  ULISCAN filename
  outputs to stdout
*/

#define L 8
#define V (1&lt;&lt;L)
#define Q (10*V)
#define K (100   *Q)
#define MAXSAMP (Q + K)

#include &lt;stdio.h&gt;
#include &lt;math.h&gt;

int main(argc, argv)
int argc;
char **argv;
{
  FILE *fptr;
  int i,j;
  int b, c;
  int table[V];
  double sum = 0.0;
  int iproduct = 1;
  int run;

  extern double   log(/* double x */);

  printf(&#34;Uliscan 21 Dec 98 \nL=%d %d %d \n&#34;, L, V, MAXSAMP);

  if (argc &lt; 2) {
    printf(&#34;Usage: Uliscan filename\n&#34;);
    exit(-1);
  } else {
    printf(&#34;Measuring file %s\n&#34;, argv[1]);
  }

  fptr = fopen(argv[1],&#34;rb&#34;);

  if (fptr == NULL) {
    printf(&#34;Can&#39;t find %s\n&#34;, argv[1]);
    exit(-1);
  }

  for (i = 0; i &lt; V; i++) {
    table[i] = 0;
  }

  for (i = 0; i &lt; Q; i++) {
    b = fgetc(fptr);
    table[b] = i;
  }

  printf(&#34;Init done\n&#34;);

  printf(&#34;Expected value for L=8 is 7.1836656\n&#34;);

  run = 1;

  while (run) {
    sum = 0.0;
    iproduct = 1;

    if (run)
      for (i = Q; run &amp;&amp; i &lt; Q + K; i++) {
        j = i;
        b = fgetc(fptr);

        if (b &lt; 0)
          run = 0;

        if (run) {
          if (table[b] &gt; j)
            j += K;

          sum += log((double)(j-table[b]));

          table[b] = i;
        }
      }

    if (!run)
      printf(&#34;Premature end of file; read %d blocks.\n&#34;, i - Q);

    sum = (sum/((double)(i - Q))) /  log(2.0);
    printf(&#34;%4.4f &#34;, sum);

    for (i = 0; i &lt; (int)(sum*8.0 + 0.50); i++)
      printf(&#34;-&#34;);

    printf(&#34;\n&#34;);

    /* refill initial table */
    if (0) {
      for (i = 0; i &lt; Q; i++) {
        b = fgetc(fptr);
        if (b &lt; 0) {
          run = 0;
        } else {
          table[b] = i;
        }
      }
    }
  }
}</pre></div></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: September 23, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=c6f45f0053" target=_blank>Fernando Apesteguía</a></p></div></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#problem>1. The Problem</a></li><li><a href=#solution>2. The Solution</a></li><li><a href=#experiment>3. The Experiment</a></li><li><a href=#caveat>4. Caveat</a></li><li><a href=#IPsec>5. IPsec---Definition</a></li><li><a href=#ipsec-install>6. Installing IPsec</a></li><li><a href=#kernel>7. src/sys/i386/conf/KERNELNAME</a></li><li><a href=#code>8. Maurer’s Universal Statistical Test (for block size=8 bits)</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/articles/ipsec-must/ipsec-must_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/en/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>