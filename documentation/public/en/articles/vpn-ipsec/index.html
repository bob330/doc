<!doctype html><html class=theme-light lang=en><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="VPN over IPsec"><meta name=keywords content><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=http://172.16.201.134:1313/en/articles/vpn-ipsec/><title>VPN over IPsec | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=http://172.16.201.134:1313/favicon.ico><link rel=stylesheet href=http://172.16.201.134:1313/styles/main.min.css><link rel=stylesheet href=http://172.16.201.134:1313/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="VPN over IPsec"><meta property="og:description" content="VPN over IPsec"><meta property="og:type" content="website"><meta property="og:image" content="http://172.16.201.134:1313/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="http://172.16.201.134:1313/en/articles/vpn-ipsec/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"http:\/\/172.16.201.134:1313\/en\/articles\/vpn-ipsec\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=http://172.16.201.134:1313/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=http://172.16.201.134:1313/en/books/handbook>FreeBSD Handbook</a></li><li><a href=http://172.16.201.134:1313/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=http://172.16.201.134:1313/en/books>Books</a></li><li><a href=http://172.16.201.134:1313/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=http://172.16.201.134:1313/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><main class=main-wrapper-article><div class=article><h1 class=title>VPN over IPsec</h1><div class=copyright>Copyright © 2023 The FreeBSD Documentation Project</div><div class=legalnotice><a id=trademarks></a><details><summary>trademarks</summary><p>FreeBSD is a registered trademark of the FreeBSD Foundation.</p><p>Many of the designations used by manufacturers and sellers to distinguish their products are claimed as trademarks. Where those designations appear in this document, and the FreeBSD Project was aware of the trademark claim, the designations have been followed by the “™” or the “®” symbol.</p></details></div><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#_configuring_a_vpn_on_freebsd>1. Configuring a VPN on FreeBSD</a></li></ul></nav></div><div id=preamble><div class=sectionbody><hr><div class=paragraph><p>Internet Protocol Security (IPsec) is a set of protocols which sit on top of the Internet Protocol (IP) layer.
It allows two or more hosts to communicate in a secure manner by authenticating and encrypting each IP packet of a communication session.
The FreeBSD IPsec network stack is based on the <a href=http://www.kame.net/>http://www.kame.net/</a> implementation and supports both IPv4 and IPv6 sessions.</p></div><div class=paragraph><p>IPsec is comprised of the following sub-protocols:</p></div><div class=ulist><ul><li><p><em>Encapsulated Security Payload (ESP)</em>: this protocol protects the IP packet data from third party interference by encrypting the contents using symmetric cryptography algorithms such as Blowfish and 3DES.</p></li><li><p><em>Authentication Header (AH)</em>: this protocol protects the IP packet header from third party interference and spoofing by computing a cryptographic checksum and hashing the IP packet header fields with a secure hashing function. This is then followed by an additional header that contains the hash, to allow the information in the packet to be authenticated.</p></li><li><p><em>IP Payload Compression Protocol (IPComp</em>): this protocol tries to increase communication performance by compressing the IP payload in order to reduce the amount of data sent.</p></li></ul></div><div class=paragraph><p>These protocols can either be used together or separately, depending on the environment.</p></div><div class=paragraph><p>IPsec supports two modes of operation.
The first mode, <em>Transport Mode</em>, protects communications between two hosts.
The second mode, <em>Tunnel Mode</em>, is used to build virtual tunnels, commonly known as Virtual Private Networks (VPNs).
Consult <a href="https://man.freebsd.org/cgi/man.cgi?query=ipsec&amp;sektion=4&amp;format=html">ipsec(4)</a> for detailed information on the IPsec subsystem in FreeBSD.</p></div><div class=paragraph><p>The article demonstrates the process of setting up an IPsecVPN between a home network and a corporate network.</p></div><div class=paragraph><p>In the example scenario:</p></div><div class=ulist><ul><li><p>Both sites are connected to the Internet through a gateway that is running FreeBSD.</p></li><li><p>The gateway on each network has at least one external IP address. In this example, the corporate LAN’s external IP address is <code>172.16.5.4</code> and the home LAN’s external IP address is <code>192.168.1.12</code>.</p></li><li><p>The internal addresses of the two networks can be either public or private IP addresses. However, the address space must not overlap. In this example, the corporate LAN’s internal IP address is <code>10.246.38.1</code> and the home LAN’s internal IP address is <code>10.0.0.5</code>.</p></li></ul></div><div class="literalblock programlisting"><div class=content><pre>           corporate                          home
10.246.38.1/24 -- 172.16.5.4 &lt;--&gt; 192.168.1.12 -- 10.0.0.5/24</pre></div></div></div></div><div class=sect1><h2 id=_configuring_a_vpn_on_freebsd>1. Configuring a VPN on FreeBSD<a class=anchor href=#_configuring_a_vpn_on_freebsd></a></h2><div class=sectionbody><div class=paragraph><p>To begin, <a class=package href=https://cgit.freebsd.org/ports/tree/security/ipsec-tools/>security/ipsec-tools</a> must be installed from the Ports Collection.
This software provides a number of applications which support the configuration.</p></div><div class=paragraph><p>The next requirement is to create two <a href="https://man.freebsd.org/cgi/man.cgi?query=gif&amp;sektion=4&amp;format=html">gif(4)</a> pseudo-devices which will be used to tunnel packets and allow both networks to communicate properly.
As <code>root</code>, run the following command on each gateway:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>corp-gw# ifconfig gif0 create
corp-gw# ifconfig gif0 10.246.38.1 10.0.0.5
corp-gw# ifconfig gif0 tunnel 172.16.5.4 192.168.1.12</code></pre></div></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>home-gw# ifconfig gif0 create
home-gw# ifconfig gif0 10.0.0.5 10.246.38.1
home-gw# ifconfig gif0 tunnel 192.168.1.12 172.16.5.4</code></pre></div></div><div class=paragraph><p>Verify the setup on each gateway, using <code>ifconfig gif0</code>.
Here is the output from the home gateway:</p></div><div class="literalblock programlisting"><div class=content><pre>gif0: flags=8051 mtu 1280
tunnel inet 172.16.5.4 --&gt; 192.168.1.12
inet6 fe80::2e0:81ff:fe02:5881%gif0 prefixlen 64 scopeid 0x6
inet 10.246.38.1 --&gt; 10.0.0.5 netmask 0xffffff00</pre></div></div><div class=paragraph><p>Here is the output from the corporate gateway:</p></div><div class="literalblock programlisting"><div class=content><pre>gif0: flags=8051 mtu 1280
tunnel inet 192.168.1.12 --&gt; 172.16.5.4
inet 10.0.0.5 --&gt; 10.246.38.1 netmask 0xffffff00
inet6 fe80::250:bfff:fe3a:c1f%gif0 prefixlen 64 scopeid 0x4</pre></div></div><div class=paragraph><p>Once complete, both internal IP addresses should be reachable using <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a>:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>home-gw# ping 10.0.0.5
PING 10.0.0.5 <span class=o>(</span>10.0.0.5<span class=o>)</span>: 56 data bytes
64 bytes from 10.0.0.5: <span class=nv>icmp_seq</span><span class=o>=</span>0 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>42.786 ms
64 bytes from 10.0.0.5: <span class=nv>icmp_seq</span><span class=o>=</span>1 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>19.255 ms
64 bytes from 10.0.0.5: <span class=nv>icmp_seq</span><span class=o>=</span>2 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>20.440 ms
64 bytes from 10.0.0.5: <span class=nv>icmp_seq</span><span class=o>=</span>3 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>21.036 ms
<span class=nt>---</span> 10.0.0.5 ping statistics <span class=nt>---</span>
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max/stddev <span class=o>=</span> 19.255/25.879/42.786/9.782 ms

corp-gw# ping 10.246.38.1
PING 10.246.38.1 <span class=o>(</span>10.246.38.1<span class=o>)</span>: 56 data bytes
64 bytes from 10.246.38.1: <span class=nv>icmp_seq</span><span class=o>=</span>0 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>28.106 ms
64 bytes from 10.246.38.1: <span class=nv>icmp_seq</span><span class=o>=</span>1 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>42.917 ms
64 bytes from 10.246.38.1: <span class=nv>icmp_seq</span><span class=o>=</span>2 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>127.525 ms
64 bytes from 10.246.38.1: <span class=nv>icmp_seq</span><span class=o>=</span>3 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>119.896 ms
64 bytes from 10.246.38.1: <span class=nv>icmp_seq</span><span class=o>=</span>4 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>154.524 ms
<span class=nt>---</span> 10.246.38.1 ping statistics <span class=nt>---</span>
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev <span class=o>=</span> 28.106/94.594/154.524/49.814 ms</code></pre></div></div><div class=paragraph><p>As expected, both sides have the ability to send and receive ICMP packets from the privately configured addresses.
Next, both gateways must be told how to route packets in order to correctly send traffic from the networks behind each gateway.
The following commands will achieve this goal:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>corp-gw# route add 10.0.0.0 10.0.0.5 255.255.255.0
corp-gw# route add net 10.0.0.0: gateway 10.0.0.5
home-gw# route add 10.246.38.0 10.246.38.1 255.255.255.0
home-gw# route add host 10.246.38.0: gateway 10.246.38.1</code></pre></div></div><div class=paragraph><p>Internal machines should be reachable from each gateway as well as from machines behind the gateways.
Again, use <a href="https://man.freebsd.org/cgi/man.cgi?query=ping&amp;sektion=8&amp;format=html">ping(8)</a> to confirm:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>corp-gw# ping <span class=nt>-c</span> 3 10.0.0.8
PING 10.0.0.8 <span class=o>(</span>10.0.0.8<span class=o>)</span>: 56 data bytes
64 bytes from 10.0.0.8: <span class=nv>icmp_seq</span><span class=o>=</span>0 <span class=nv>ttl</span><span class=o>=</span>63 <span class=nb>time</span><span class=o>=</span>92.391 ms
64 bytes from 10.0.0.8: <span class=nv>icmp_seq</span><span class=o>=</span>1 <span class=nv>ttl</span><span class=o>=</span>63 <span class=nb>time</span><span class=o>=</span>21.870 ms
64 bytes from 10.0.0.8: <span class=nv>icmp_seq</span><span class=o>=</span>2 <span class=nv>ttl</span><span class=o>=</span>63 <span class=nb>time</span><span class=o>=</span>198.022 ms
<span class=nt>---</span> 10.0.0.8 ping statistics <span class=nt>---</span>
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max/stddev <span class=o>=</span> 21.870/101.846/198.022/74.001 ms

home-gw# ping <span class=nt>-c</span> 3 10.246.38.107
PING 10.246.38.1 <span class=o>(</span>10.246.38.107<span class=o>)</span>: 56 data bytes
64 bytes from 10.246.38.107: <span class=nv>icmp_seq</span><span class=o>=</span>0 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>53.491 ms
64 bytes from 10.246.38.107: <span class=nv>icmp_seq</span><span class=o>=</span>1 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>23.395 ms
64 bytes from 10.246.38.107: <span class=nv>icmp_seq</span><span class=o>=</span>2 <span class=nv>ttl</span><span class=o>=</span>64 <span class=nb>time</span><span class=o>=</span>23.865 ms
<span class=nt>---</span> 10.246.38.107 ping statistics <span class=nt>---</span>
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max/stddev <span class=o>=</span> 21.145/31.721/53.491/12.179 ms</code></pre></div></div><div class=paragraph><p>At this point, traffic is flowing between the networks encapsulated in a gif tunnel but without any encryption.
Next, use IPSec to encrypt traffic using pre-shared keys (PSK).
Other than the IP addresses, <span class=filename>/usr/local/etc/racoon/racoon.conf</span> on both gateways will be identical and look similar to:</p></div><div class="literalblock programlisting"><div class=content><pre>path    pre_shared_key  &#34;/usr/local/etc/racoon/psk.txt&#34;; #location of pre-shared key file
log     debug;	#log verbosity setting: set to &#39;notify&#39; when testing and debugging is complete

padding	# options are not to be changed
{
        maximum_length  20;
        randomize       off;
        strict_check    off;
        exclusive_tail  off;
}

timer	# timing options. change as needed
{
        counter         5;
        interval        20 sec;
        persend         1;
#       natt_keepalive  15 sec;
        phase1          30 sec;
        phase2          15 sec;
}

listen	# address [port] that racoon will listen on
{
        isakmp          172.16.5.4 [500];
        isakmp_natt     172.16.5.4 [4500];
}

remote  192.168.1.12 [500]
{
        exchange_mode   main,aggressive;
        doi             ipsec_doi;
        situation       identity_only;
        my_identifier   address 172.16.5.4;
        peers_identifier        address 192.168.1.12;
        lifetime        time 8 hour;
        passive         off;
        proposal_check  obey;
#       nat_traversal   off;
        generate_policy off;

                        proposal {
                                encryption_algorithm    blowfish;
                                hash_algorithm          md5;
                                authentication_method   pre_shared_key;
                                lifetime time           30 sec;
                                dh_group                1;
                        }
}

sainfo  (address 10.246.38.0/24 any address 10.0.0.0/24 any)	# address $network/$netmask $type address $network/$netmask $type ( $type being any or esp)
{								# $network must be the two internal networks you are joining.
        pfs_group       1;
        lifetime        time    36000 sec;
        encryption_algorithm    blowfish,3des;
        authentication_algorithm        hmac_md5,hmac_sha1;
        compression_algorithm   deflate;
}</pre></div></div><div class=paragraph><p>For descriptions of each available option, refer to the manual page for <span class=filename>racoon.conf</span>.</p></div><div class=paragraph><p>The Security Policy Database (SPD) needs to be configured so that FreeBSD and racoon are able to encrypt and decrypt network traffic between the hosts.</p></div><div class=paragraph><p>This can be achieved with a shell script, similar to the following, on the corporate gateway.
This file will be used during system initialization and should be saved as <span class=filename>/usr/local/etc/racoon/setkey.conf</span>.</p></div><div class="literalblock programlisting"><div class=content><pre>flush;
spdflush;
# To the home network
spdadd 10.246.38.0/24 10.0.0.0/24 any -P out ipsec esp/tunnel/172.16.5.4-192.168.1.12/use;
spdadd 10.0.0.0/24 10.246.38.0/24 any -P in ipsec esp/tunnel/192.168.1.12-172.16.5.4/use;</pre></div></div><div class=paragraph><p>Once in place, racoon may be started on both gateways using the following command:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell><span class=c># /usr/local/sbin/racoon -F -f /usr/local/etc/racoon/racoon.conf -l /var/log/racoon.log</span></code></pre></div></div><div class=paragraph><p>The output should be similar to the following:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>corp-gw# /usr/local/sbin/racoon <span class=nt>-F</span> <span class=nt>-f</span> /usr/local/etc/racoon/racoon.conf
Foreground mode.
2006-01-30 01:35:47: INFO: begin Identity Protection mode.
2006-01-30 01:35:48: INFO: received Vendor ID: KAME/racoon
2006-01-30 01:35:55: INFO: received Vendor ID: KAME/racoon
2006-01-30 01:36:04: INFO: ISAKMP-SA established 172.16.5.4[500]-192.168.1.12[500] spi:623b9b3bd2492452:7deab82d54ff704a
2006-01-30 01:36:05: INFO: initiate new phase 2 negotiation: 172.16.5.4[0]192.168.1.12[0]
2006-01-30 01:36:09: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.12[0]-&gt;172.16.5.4[0] <span class=nv>spi</span><span class=o>=</span>28496098<span class=o>(</span>0x1b2d0e2<span class=o>)</span>
2006-01-30 01:36:09: INFO: IPsec-SA established: ESP/Tunnel 172.16.5.4[0]-&gt;192.168.1.12[0] <span class=nv>spi</span><span class=o>=</span>47784998<span class=o>(</span>0x2d92426<span class=o>)</span>
2006-01-30 01:36:13: INFO: respond new phase 2 negotiation: 172.16.5.4[0]192.168.1.12[0]
2006-01-30 01:36:18: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.12[0]-&gt;172.16.5.4[0] <span class=nv>spi</span><span class=o>=</span>124397467<span class=o>(</span>0x76a279b<span class=o>)</span>
2006-01-30 01:36:18: INFO: IPsec-SA established: ESP/Tunnel 172.16.5.4[0]-&gt;192.168.1.12[0] <span class=nv>spi</span><span class=o>=</span>175852902<span class=o>(</span>0xa7b4d66<span class=o>)</span></code></pre></div></div><div class=paragraph><p>To ensure the tunnel is working properly, switch to another console and use <a href="https://man.freebsd.org/cgi/man.cgi?query=tcpdump&amp;sektion=1&amp;format=html">tcpdump(1)</a> to view network traffic using the following command.
Replace <code>em0</code> with the network interface card as required:</p></div><div class=listingblock><div class=content><pre class="rouge highlight"><code data-lang=shell>corp-gw# tcpdump <span class=nt>-i</span> em0 host 172.16.5.4 and dst 192.168.1.12</code></pre></div></div><div class=paragraph><p>Data similar to the following should appear on the console.
If not, there is an issue and debugging the returned data will be required.</p></div><div class="literalblock programlisting"><div class=content><pre>01:47:32.021683 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xa)
01:47:33.022442 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xb)
01:47:34.024218 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xc)</pre></div></div><div class=paragraph><p>At this point, both networks should be available and seem to be part of the same network.
Most likely both networks are protected by a firewall.
To allow traffic to flow between them, rules need to be added to pass packets.
For the <a href="https://man.freebsd.org/cgi/man.cgi?query=ipfw&amp;sektion=8&amp;format=html">ipfw(8)</a> firewall, add the following lines to the firewall configuration file:</p></div><div class="literalblock programlisting"><div class=content><pre>ipfw add 00201 allow log esp from any to any
ipfw add 00202 allow log ah from any to any
ipfw add 00203 allow log ipencap from any to any
ipfw add 00204 allow log udp from any 500 to any</pre></div></div><div class="admonitionblock note"><table><tbody><tr><td class=icon><i class="fa icon-note" title=Note></i></td><td class=content><div class=paragraph><p>The rule numbers may need to be altered depending on the current host configuration.</p></div></td></tr></tbody></table></div><div class=paragraph><p>For users of <a href="https://man.freebsd.org/cgi/man.cgi?query=pf&amp;sektion=4&amp;format=html">pf(4)</a> or <a href="https://man.freebsd.org/cgi/man.cgi?query=ipf&amp;sektion=8&amp;format=html">ipf(8)</a>, the following rules should do the trick:</p></div><div class="literalblock programlisting"><div class=content><pre>pass in quick proto esp from any to any
pass in quick proto ah from any to any
pass in quick proto ipencap from any to any
pass in quick proto udp from any port = 500 to any port = 500
pass in quick on gif0 from any to any
pass out quick proto esp from any to any
pass out quick proto ah from any to any
pass out quick proto ipencap from any to any
pass out quick proto udp from any port = 500 to any port = 500
pass out quick on gif0 from any to any</pre></div></div><div class=paragraph><p>Finally, to allow the machine to start support for the VPN during system initialization, add the following lines to <span class=filename>/etc/rc.conf</span>:</p></div><div class="literalblock programlisting"><div class=content><pre>ipsec_enable=&#34;YES&#34;
ipsec_program=&#34;/usr/local/sbin/setkey&#34;
ipsec_file=&#34;/usr/local/etc/racoon/setkey.conf&#34; # allows setting up spd policies on boot
racoon_enable=&#34;yes&#34;</pre></div></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: September 27, 2023 by <a href="https://cgit.freebsd.org/doc/commit/?id=99333306b8" target=_blank>Sergio Carlavilla Delgado</a></p></div></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#_configuring_a_vpn_on_freebsd>1. Configuring a VPN on FreeBSD</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/articles/vpn-ipsec/vpn-ipsec_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside></main><footer><div class=footer-container><section class=logo-column><img src=http://172.16.201.134:1313/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=http://172.16.201.134:1313/en/languages><img src=http://172.16.201.134:1313/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=http://172.16.201.134:1313/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>