<!doctype html><html class=theme-light lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Newbus"><meta name=keywords content="Newbus,overview,API"><meta name=copyright content="1995-2024 The FreeBSD Foundation"><link rel=canonical href=https://docs.freebsd.org/en/books/arch-handbook/newbus/><title>Chapter 14. Newbus | FreeBSD Documentation Portal</title>
<meta name=theme-color content="#790000"><meta name=color-scheme content="system light dark high-contrast"><link rel="shortcut icon" href=https://docs.freebsd.org/favicon.ico><link rel=stylesheet href=https://docs.freebsd.org/styles/main.min.css><link rel=stylesheet href=https://docs.freebsd.org/css/font-awesome-min.css><script defer src=/js/theme-chooser.min.js></script><script defer src=/js/copy-clipboard.min.js></script><script defer src=/js/search.min.js></script><meta name=twitter:card content="summary"><meta name=twitter:domain content="docs.FreeBSD.org"><meta name=twitter:site content="@freebsd"><meta name=twitter:url content="https://twitter.com/freebsd"><meta property="og:title" content="Chapter 14. Newbus"><meta property="og:description" content="Newbus"><meta property="og:type" content="website"><meta property="og:image" content="https://docs.freebsd.org/favicon.ico"><meta property="og:image:alt" content="FreeBSD Logo"><meta property="og:locale" content="en"><meta property="og:url" content="https://docs.freebsd.org/en/books/arch-handbook/newbus/"><meta property="og:site_name" content="FreeBSD Documentation Portal"><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","url":"https:\/\/docs.freebsd.org\/en\/books\/arch-handbook\/newbus\/","name":"FreeBSD Documentation Portal","headline":"FreeBSD Documentation Portal","description":"FreeBSD Documentation Portal"}</script></head><body><header><div class=header-container><div class=logo-menu-bars-container><a href=https://www.FreeBSD.org class=logo><img src=https://docs.freebsd.org/images/FreeBSD-monochromatic.svg width=160 height=50 alt="FreeBSD logo">
</a><label class=menu-bars for=menu-bars><i class="fa fa-bars" aria-hidden=true></i></label></div><input id=menu-bars type=checkbox><nav><ul class=menu><li class=menu-item><input id=about type=checkbox>
<a href=# aria-label="Navigate to About section"><label class=menu-item-description for=about>About
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/about/ target=_blank>About</a></li><li><a href=https://www.freebsd.org/about/ target=_blank>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/about-us/about-the-foundation/ target=_blank>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct/ target=_blank>Code of Conduct</a></li></ul></li><li class=menu-item><input id=download type=checkbox>
<a href=# aria-label="Navigate to get FreeBSD section"><label class=menu-item-description for=download>Get FreeBSD
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/where/ target=_blank>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/releases/ target=_blank>Release Information</a></li><li><a href=https://www.freebsd.org/releng/ target=_blank>Release Engineering</a></li><li><a href=https://www.freebsd.org/security/ target=_blank>Security Advisories</a></li></ul></li><li class=menu-item><input id=documentation type=checkbox>
<a href=# aria-label="Navigate to get Documentation section"><label class=menu-item-description for=documentation>Documentation
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=/en>Documentation portal</a></li><li><a href=https://docs.freebsd.org/en/books/handbook>FreeBSD Handbook</a></li><li><a href=https://docs.freebsd.org/en/books/porters-handbook>Porter's Handbook</a></li><li><a href=https://docs.FreeBSD.org/en/books/fdp-primer>Documentation Project Handbook</a></li><li><a href=https://man.FreeBSD.org target=_blank>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank>Presentations and papers</a></li><li><a href=https://wiki.FreeBSD.org target=_blank>Wiki</a></li><li><a href=https://docs.freebsd.org/en/books>Books</a></li><li><a href=https://docs.freebsd.org/en/articles>Articles</a></li></ul></li><li class=menu-item><input id=community type=checkbox>
<a href=# aria-label="Navigate to get Community section"><label class=menu-item-description for=community>Community
<i class="fa fa-angle-down fa-lg" aria-hidden=true></i></label></a><ul class=sub-menu><li class=title><a href=https://www.freebsd.org/community/>Community</a></li><li><a href=https://docs.freebsd.org/en/articles/contributing>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank>Forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank>Bug Tracker</a></li><li><a href=https://www.freebsd.org/support/ target=_blank>Support</a></li></ul></li></ul></nav><div class=search-donate-container><form class=search method=get id=search-header-form action=https://docs.freebsd.org/search name=search-header-form><input type=hidden name=DB value=en>
<input id=words name=P type=text size=20 maxlength=255>
<button>
<i class="fa fa-search" aria-hidden=true></i></button></form><div class=donate><a href=https://freebsdfoundation.org/donate/ target=_blank><span class=heart>♥</span>
Donate</a></div></div></div></header><input type=checkbox class="hidden toggle" id=menu-control><main class=main-wrapper-book><a id=top></a><aside class=book-menu><div class=book-menu-content><input id=search-book type=text placeholder=Search aria-label=Search maxlength=128><nav id=MenuContents><ul><li><input type=checkbox id=chapter-6dcd22d99f78db2a9aacae23be13866e class=toggle>
<label for=chapter-6dcd22d99f78db2a9aacae23be13866e><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/parti/>Part I. Kernel</a></li><li><input type=checkbox id=chapter-9cc61bc35df69063dc03a5911e1ad9c9 class=toggle>
<label class="icon cursor" for=chapter-9cc61bc35df69063dc03a5911e1ad9c9><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/>Chapter 1. Bootstrapping and Kernel Initialization</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-synopsis>1.1. Synopsis</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-overview>1.2. Overview</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-bios>1.3. The BIOS</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-boot0>1.4. The Master Boot Record (<code>boot0</code>)</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-boot1>1.5. <code>boot1</code> Stage</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#btx-server>1.6. The BTX Server</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot2>1.7. boot2 Stage</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-loader>1.8. loader Stage</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/boot/#boot-kernel>1.9. Kernel Initialization</a></li></ul></li><li><input type=checkbox id=chapter-3a651b0a4b9f6238336624d3c0fa5187 class=toggle>
<label class="icon cursor" for=chapter-3a651b0a4b9f6238336624d3c0fa5187><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/locking/>Chapter 2. Locking Notes</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/locking/#locking-mutexes>2.1. Mutexes</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/locking/#locking-sx>2.2. Shared Exclusive Locks</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/locking/#locking-atomic>2.3. Atomically Protected Variables</a></li></ul></li><li><input type=checkbox id=chapter-bf0b823c107a80f3035dfd6fae09d023 class=toggle>
<label class="icon cursor" for=chapter-bf0b823c107a80f3035dfd6fae09d023><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/kobj/>Chapter 3. Kernel Objects</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/kobj/#kernel-objects-term>3.1. Terminology</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/kobj/#kernel-objects-operation>3.2. Kobj Operation</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/kobj/#kernel-objects-using>3.3. Using Kobj</a></li></ul></li><li><input type=checkbox id=chapter-41dab1afed6cf3ffa54628db4227e196 class=toggle>
<label class="icon cursor" for=chapter-41dab1afed6cf3ffa54628db4227e196><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/jail/>Chapter 4. The Jail Subsystem</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/jail/#jail-arch>4.1. Architecture</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/jail/#jail-restrictions>4.2. Restrictions</a></li></ul></li><li><input type=checkbox id=chapter-e7d9ebcb448b0045179ebe22f8e2e9d8 class=toggle>
<label class="icon cursor" for=chapter-e7d9ebcb448b0045179ebe22f8e2e9d8><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/sysinit/>Chapter 5. The SYSINIT Framework</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sysinit/#sysinit-term>5.1. Terminology</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sysinit/#sysinit-operation>5.2. SYSINIT Operation</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sysinit/#sysinit-using>5.3. Using SYSINIT</a></li></ul></li><li><input type=checkbox id=chapter-8b57b16ba53538421a8fb2152b25976f class=toggle>
<label class="icon cursor" for=chapter-8b57b16ba53538421a8fb2152b25976f><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/>Chapter 6. The TrustedBSD MAC Framework</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-copyright>6.1. MAC Documentation Copyright</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-synopsis>6.2. Synopsis</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-introduction>6.3. Introduction</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-background>6.4. Policy Background</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-framework-kernel-arch>6.5. MAC Framework Kernel Architecture</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-policy-architecture>6.6. MAC Policy Architecture</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-entry-point-reference>6.7. MAC Policy Entry Point Reference</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-userland-arch>6.8. Userland Architecture</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/mac/#mac-conclusion>6.9. Conclusion</a></li></ul></li><li><input type=checkbox id=chapter-28609916419208e3a19d240cf7593906 class=toggle>
<label class="icon cursor" for=chapter-28609916419208e3a19d240cf7593906><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/>Chapter 7. Virtual Memory System</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-physmem>7.1. Management of Physical Memory <code>vm_page_t</code></a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-cache>7.2. The Unified Buffer Cache <code>vm_object_t</code></a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-fileio>7.3. Filesystem I/O <code>struct buf</code></a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-pagetables>7.4. Mapping Page Tables <code>vm_map_t, vm_entry_t</code></a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-kvm>7.5. KVM Memory Mapping</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/vm/#vm-tuning>7.6. Tuning the FreeBSD VM System</a></li></ul></li><li><input type=checkbox id=chapter-716edd44e8ad22ea57cdf273d2578872 class=toggle>
<label class="icon cursor" for=chapter-716edd44e8ad22ea57cdf273d2578872><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/>Chapter 8. SMPng Design Document</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-intro>8.1. Introduction</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-lock-fundamentals>8.2. Basic Tools and Locking Fundamentals</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-design>8.3. General Architecture and Design</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-lock-strategies>8.4. Specific Locking Strategies</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-implementation-notes>8.5. Implementation Notes</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-misc>8.6. Miscellaneous Topics</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/smp/#smp-glossary>Glossary</a></li></ul></li><li><input type=checkbox id=chapter-448f803e40f97b1ff8336db9ba637745 class=toggle>
<label for=chapter-448f803e40f97b1ff8336db9ba637745><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/partii/>Part II. Device Drivers</a></li><li><input type=checkbox id=chapter-6971d35b0bbe2a0bdb005a02546cd580 class=toggle>
<label class="icon cursor" for=chapter-6971d35b0bbe2a0bdb005a02546cd580><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/>Chapter 9. Writing FreeBSD Device Drivers</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/#driverbasics-intro>9.1. Introduction</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/#driverbasics-kld>9.2. Dynamic Kernel Linker Facility - KLD</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/#driverbasics-char>9.3. Character Devices</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/#driverbasics-block>9.4. Block Devices (Are Gone)</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/driverbasics/#driverbasics-net>9.5. Network Drivers</a></li></ul></li><li><input type=checkbox id=chapter-9cc7968be065b256e57086439d93e9a4 class=toggle>
<label class="icon cursor" for=chapter-9cc7968be065b256e57086439d93e9a4><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/>Chapter 10. ISA Device Drivers</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-synopsis>10.1. Synopsis</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-basics>10.2. Basic Information</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-device-t>10.3. <code>device_t</code> Pointer</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-config>10.4. Configuration File and the Order of Identifying and Probing During Auto-Configuration</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-resources>10.5. Resources</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-busmem>10.6. Bus Memory Mapping</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-dma>10.7. DMA</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-probe>10.8. xxx_isa_probe</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-attach>10.9. xxx_isa_attach</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-detach>10.10. xxx_isa_detach</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-shutdown>10.11. xxx_isa_shutdown</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/isa/#isa-driver-intr>10.12. xxx_intr</a></li></ul></li><li><input type=checkbox id=chapter-0b427d421e89aa3107f62d5b70f6a0f2 class=toggle>
<label class="icon cursor" for=chapter-0b427d421e89aa3107f62d5b70f6a0f2><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/pci/>Chapter 11. PCI Devices</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/pci/#pci-probe>11.1. Probe and Attach</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/pci/#pci-bus>11.2. Bus Resources</a></li></ul></li><li><input type=checkbox id=chapter-0b7eb8d45a0ea6bc9c2882e903b93959 class=toggle>
<label class="icon cursor" for=chapter-0b7eb8d45a0ea6bc9c2882e903b93959><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/>Chapter 12. Common Access Method SCSI Controllers</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-synopsis>12.1. Synopsis</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-general>12.2. General Architecture</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#_globals_and_boilerplate>12.3. Globals and Boilerplate</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#_device_configuration_xxx_attach>12.4. Device configuration: xxx_attach</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#_processing_cam_messages_xxx_action>12.5. Processing CAM messages: xxx_action</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-polling>12.6. Polling xxx_poll</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-async>12.7. Asynchronous Events</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-interrupts>12.8. Interrupts</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-errors>12.9. Errors Summary</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/scsi/#scsi-timeout>12.10. Timeout Handling</a></li></ul></li><li><input type=checkbox id=chapter-bdaa4909dfbdcec8d7be976fd87cb00e class=toggle>
<label class="icon cursor" for=chapter-bdaa4909dfbdcec8d7be976fd87cb00e><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/>Chapter 13. USB Devices</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/#usb-intro>13.1. Introduction</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/#usb-hc>13.2. Host Controllers</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/#usb-dev>13.3. USB Device Information</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/#usb-devprobe>13.4. Device Probe and Attach</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/usb/#usb-protocol>13.5. USB Drivers Protocol Information</a></li></ul></li><li><input type=checkbox id=chapter-5fc5c179f5014d968a5c8feec7e10e59 class=toggle checked>
<label class="icon cursor" for=chapter-5fc5c179f5014d968a5c8feec7e10e59><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/newbus/>Chapter 14. Newbus</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/newbus/#newbus-devdrivers>14.1. Device Drivers</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/newbus/#newbus-overview>14.2. Overview of Newbus</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/newbus/#newbus-api>14.3. Newbus API</a></li></ul></li><li><input type=checkbox id=chapter-7d3796cced00105c77e7f87e84edd73b class=toggle>
<label class="icon cursor" for=chapter-7d3796cced00105c77e7f87e84edd73b><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/sound/>Chapter 15. Sound Subsystem</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sound/#oss-intro>15.1. Introduction</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sound/#oss-files>15.2. Files</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sound/#pcm-probe-and-attach>15.3. Probing, Attaching, etc.</a></li><li><a href=https://docs.freebsd.org/en/books/arch-handbook/sound/#oss-interfaces>15.4. Interfaces</a></li></ul></li><li><input type=checkbox id=chapter-41c74c3e72fcf5116f6d999c36ef185b class=toggle>
<label class="icon cursor" for=chapter-41c74c3e72fcf5116f6d999c36ef185b><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/pccard/>Chapter 16. PC Card</a><ul><li><a href=https://docs.freebsd.org/en/books/arch-handbook/pccard/#pccard-adddev>16.1. Adding a Device</a></li></ul></li><li><input type=checkbox id=chapter-2a7cf37011599a8e3d62d1e3008c3c5d class=toggle>
<label for=chapter-2a7cf37011599a8e3d62d1e3008c3c5d><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/partiii/>Part III. Appendices</a></li><li><input type=checkbox id=chapter-d4c82056f0235da9fde0d29203d44f9a class=toggle>
<label for=chapter-d4c82056f0235da9fde0d29203d44f9a><a role=button></a></label><a href=https://docs.freebsd.org/en/books/arch-handbook/bibliography/>Bibliography</a></li><li></li></ul></nav></div></aside><div class=book><div class=book-menu-mobile><label for=menu-control><span class=menu-control-button><i class="fa fa-list" aria-hidden=true title="Book menu"></i>
Book menu</span></label></div><h1 class=title>Chapter 14. Newbus</h1><div class=toc-mobile><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#newbus-devdrivers>14.1. Device Drivers</a></li><li><a href=#newbus-overview>14.2. Overview of Newbus</a></li><li><a href=#newbus-api>14.3. Newbus API</a></li></ul></nav></div><div class=book-content><div id=preamble><div class=sectionbody><div class=paragraph><p><em>Special thanks to Matthew N. Dodd, Warner Losh, Bill Paul, Doug Rabson, Mike Smith, Peter Wemm and Scott Long</em>.</p></div><div class=paragraph><p>This chapter explains the Newbus device framework in detail.</p></div></div></div><div class=sect1><h2 id=newbus-devdrivers>14.1. Device Drivers<a class=anchor href=#newbus-devdrivers></a></h2><div class=sectionbody><div class=sect2><h3 id=_purpose_of_a_device_driver>14.1.1. Purpose of a Device Driver<a class=anchor href=#_purpose_of_a_device_driver></a></h3><div class=paragraph><p>A device driver is a software component which provides the interface between the kernel’s generic view of a peripheral (e.g., disk, network adapter) and the actual implementation of the peripheral. The <em>device driver interface (DDI)</em> is the defined interface between the kernel and the device driver component.</p></div></div><div class=sect2><h3 id=_types_of_device_drivers>14.1.2. Types of Device Drivers<a class=anchor href=#_types_of_device_drivers></a></h3><div class=paragraph><p>There used to be days in UNIX®, and thus FreeBSD, in which there were four types of devices defined:</p></div><div class=ulist><ul><li><p>block device drivers</p></li><li><p>character device drivers</p></li><li><p>network device drivers</p></li><li><p>pseudo-device drivers</p></li></ul></div><div class=paragraph><p><em>Block devices</em> performed in a way that used fixed size blocks [of data]. This type of driver depended on the so-called <em>buffer cache</em>, which had cached accessed blocks of data in a dedicated part of memory. Often this buffer cache was based on write-behind, which meant that when data was modified in memory it got synced to disk whenever the system did its periodical disk flushing, thus optimizing writes.</p></div></div><div class=sect2><h3 id=_character_devices>14.1.3. Character Devices<a class=anchor href=#_character_devices></a></h3><div class=paragraph><p>However, in the versions of FreeBSD 4.0 and onward the distinction between block and character devices became non-existent.</p></div></div></div></div><div class=sect1><h2 id=newbus-overview>14.2. Overview of Newbus<a class=anchor href=#newbus-overview></a></h2><div class=sectionbody><div class=paragraph><p><em>Newbus</em> is the implementation of a new bus architecture based on abstraction layers which saw its introduction in FreeBSD 3.0 when the Alpha port was imported into the source tree. It was not until 4.0 before it became the default system to use for device drivers. Its goals are to provide a more object-oriented means of interconnecting the various busses and devices which a host system provides to the <em>Operating System</em>.</p></div><div class=paragraph><p>Its main features include amongst others:</p></div><div class=ulist><ul><li><p>dynamic attaching</p></li><li><p>easy modularization of drivers</p></li><li><p>pseudo-busses</p></li></ul></div><div class=paragraph><p>One of the most prominent changes is the migration from the flat and ad-hoc system to a device tree layout.</p></div><div class=paragraph><p>At the top level resides the <em>"root"</em> device which is the parent to hang all other devices on. For each architecture, there is typically a single child of "root" which has such things as <em>host-to-PCI bridges</em>, etc. attached to it. For x86, this "root" device is the <em>"nexus"</em> device. For Alpha, various different models of Alpha have different top-level devices corresponding to the different hardware chipsets, including <em>lca</em>, <em>apecs</em>, <em>cia</em> and <em>tsunami</em>.</p></div><div class=paragraph><p>A device in the Newbus context represents a single hardware entity in the system. For instance each PCI device is represented by a Newbus device. Any device in the system can have children; a device which has children is often called a <em>"bus"</em>. Examples of common busses in the system are ISA and PCI, which manage lists of devices attached to ISA and PCI busses respectively.</p></div><div class=paragraph><p>Often, a connection between different kinds of bus is represented by a <em>"bridge"</em> device, which normally has one child for the attached bus. An example of this is a <em>PCI-to-PCI bridge</em> which is represented by a device <em><span class=filename>pcibN</span></em> on the parent PCI bus and has a child <em><span class=filename>pciN</span></em> for the attached bus. This layout simplifies the implementation of the PCI bus tree, allowing common code to be used for both top-level and bridged busses.</p></div><div class=paragraph><p>Each device in the Newbus architecture asks its parent to map its resources. The parent then asks its own parent until the nexus is reached. So, basically the nexus is the only part of the Newbus system which knows about all resources.</p></div><div class="admonitionblock tip"><table><tbody><tr><td class=icon><i class="fa icon-tip" title=Tip></i></td><td class=content><div class=paragraph><p>An ISA device might want to map its IO port at <code>0x230</code>, so it asks its parent, in this case the ISA bus. The ISA bus hands it over to the PCI-to-ISA bridge which in its turn asks the PCI bus, which reaches the host-to-PCI bridge and finally the nexus. The beauty of this transition upwards is that there is room to translate the requests. For example, the <code>0x230</code> IO port request might become memory-mapped at <code>0xb0000230</code> on a MIPS box by the PCI bridge.</p></div></td></tr></tbody></table></div><div class=paragraph><p>Resource allocation can be controlled at any place in the device tree. For instance on many Alpha platforms, ISA interrupts are managed separately from PCI interrupts and resource allocations for ISA interrupts are managed by the Alpha’s ISA bus device. On IA-32, ISA and PCI interrupts are both managed by the top-level nexus device. For both ports, memory and port address space is managed by a single entity - nexus for IA-32 and the relevant chipset driver on Alpha (e.g., CIA or tsunami).</p></div><div class=paragraph><p>In order to normalize access to memory and port mapped resources, Newbus integrates the <code>bus_space</code> APIs from NetBSD. These provide a single API to replace inb/outb and direct memory reads/writes. The advantage of this is that a single driver can easily use either memory-mapped registers or port-mapped registers (some hardware supports both).</p></div><div class=paragraph><p>This support is integrated into the resource allocation mechanism. When a resource is allocated, a driver can retrieve the associated <code>bus_space_tag_t</code> and <code>bus_space_handle_t</code> from the resource.</p></div><div class=paragraph><p>Newbus also allows for definitions of interface methods in files dedicated to this purpose. These are the <span class=filename>.m</span> files that are found under the <span class=filename>src/sys</span> hierarchy.</p></div><div class=paragraph><p>The core of the Newbus system is an extensible "object-based programming" model. Each device in the system has a table of methods which it supports. The system and other devices uses those methods to control the device and request services. The different methods supported by a device are defined by a number of "interfaces". An "interface" is simply a group of related methods which can be implemented by a device.</p></div><div class=paragraph><p>In the Newbus system, the methods for a device are provided by the various device drivers in the system. When a device is attached to a driver during <em>auto-configuration</em>, it uses the method table declared by the driver. A device can later <em>detach</em> from its driver and <em>re-attach</em> to a new driver with a new method table. This allows dynamic replacement of drivers which can be useful for driver development.</p></div><div class=paragraph><p>The interfaces are described by an interface definition language similar to the language used to define vnode operations for file systems. The interface would be stored in a methods file (which would normally be named <span class=filename>foo_if.m</span>).</p></div><div class=exampleblock><div class=title>Example 1. Newbus Methods</div><div class=content><div class="literalblock programlisting"><div class=content><pre>      # Foo subsystem/driver (a comment...)

	  INTERFACE foo

	METHOD int doit {
		device_t dev;
	};

	# DEFAULT is the method that will be used, if a method was not
	# provided via: DEVMETHOD()

	METHOD void doit_to_child {
		device_t dev;
		driver_t child;
	} DEFAULT doit_generic_to_child;</pre></div></div></div></div><div class=paragraph><p>When this interface is compiled, it generates a header file "<span class=filename>foo_if.h</span>" which contains function declarations:</p></div><div class="literalblock programlisting"><div class=content><pre>      int FOO_DOIT(device_t dev);
      int FOO_DOIT_TO_CHILD(device_t dev, device_t child);</pre></div></div><div class=paragraph><p>A source file, "<span class=filename>foo_if.c</span>" is also created to accompany the automatically generated header file; it contains implementations of those functions which look up the location of the relevant functions in the object’s method table and call that function.</p></div><div class=paragraph><p>The system defines two main interfaces. The first fundamental interface is called <em>"device"</em> and includes methods which are relevant to all devices. Methods in the <em>"device"</em> interface include <em>"probe"</em>, <em>"attach"</em> and <em>"detach"</em> to control detection of hardware and <em>"shutdown"</em>, <em>"suspend"</em> and <em>"resume"</em> for critical event notification.</p></div><div class=paragraph><p>The second, more complex interface is <em>"bus"</em>. This interface contains methods suitable for devices which have children, including methods to access bus specific per-device information <sup class=footnote>[<a id=_footnoteref_1 class=footnote href=#_footnotedef_1 title="View footnote.">1</a>]</sup>, event notification (<code><em>child_detached</em></code>, <code><em>driver_added</em></code>) and resource management (<code><em>alloc_resource</em></code>, <code><em>activate_resource</em></code>, <code><em>deactivate_resource</em></code>, <code><em>release_resource</em></code>).</p></div><div class=paragraph><p>Many methods in the "bus" interface are performing services for some child of the bus device. These methods would normally use the first two arguments to specify the bus providing the service and the child device which is requesting the service. To simplify driver code, many of these methods have accessor functions which lookup the parent and call a method on the parent. For instance the method <code>BUS_TEARDOWN_INTR(device_t dev, device_t child, …​)</code> can be called using the function <code>bus_teardown_intr(device_t child, …​)</code>.</p></div><div class=paragraph><p>Some bus types in the system define additional interfaces to provide access to bus-specific functionality. For instance, the PCI bus driver defines the "pci" interface which has two methods <code><em>read_config</em></code> and <code><em>write_config</em></code> for accessing the configuration registers of a PCI device.</p></div></div></div><div class=sect1><h2 id=newbus-api>14.3. Newbus API<a class=anchor href=#newbus-api></a></h2><div class=sectionbody><div class=paragraph><p>As the Newbus API is huge, this section makes some effort at documenting it. More information to come in the next revision of this document.</p></div><div class=sect2><h3 id=_important_locations_in_the_source_hierarchy>14.3.1. Important Locations in the Source Hierarchy<a class=anchor href=#_important_locations_in_the_source_hierarchy></a></h3><div class=paragraph><p><span class=filename>src/sys/[arch]/[arch]</span> - Kernel code for a specific machine architecture resides in this directory. For example, the <code>i386</code> architecture, or the <code>SPARC64</code> architecture.</p></div><div class=paragraph><p><span class=filename>src/sys/dev/[bus]</span> - device support for a specific <code>[bus]</code> resides in this directory.</p></div><div class=paragraph><p><span class=filename>src/sys/dev/pci</span> - PCI bus support code resides in this directory.</p></div><div class=paragraph><p><span class=filename>src/sys/[isa|pci]</span> - PCI/ISA device drivers reside in this directory. The PCI/ISA bus support code used to exist in this directory in FreeBSD version <code>4.0</code>.</p></div></div><div class=sect2><h3 id=_important_structures_and_type_definitions>14.3.2. Important Structures and Type Definitions<a class=anchor href=#_important_structures_and_type_definitions></a></h3><div class=paragraph><p><code>devclass_t</code> - This is a type definition of a pointer to a <code>struct devclass</code>.</p></div><div class=paragraph><p><code>device_method_t</code> - This is the same as <code>kobj_method_t</code> (see <span class=filename>src/sys/kobj.h</span>).</p></div><div class=paragraph><p><code>device_t</code> - This is a type definition of a pointer to a <code>struct device</code>. <code>device_t</code> represents a device in the system. It is a kernel object. See <span class=filename>src/sys/sys/bus_private.h</span> for implementation details.</p></div><div class=paragraph><p><code>driver_t</code> - This is a type definition which references <code>struct driver</code>. The <code>driver</code> struct is a class of the <code>device</code> kernel object; it also holds data private to the driver.</p></div><div class=paragraph><p><strong><em>driver_t</em> Implementation</strong></p></div><div class="literalblock programlisting"><div class=content><pre>	  struct driver {
		KOBJ_CLASS_FIELDS;
		void	*priv;			/* driver private data */
	  };</pre></div></div><div class=paragraph><p>A <code>device_state_t</code> type, which is an enumeration, <code>device_state</code>. It contains the possible states of a Newbus device before and after the autoconfiguration process.</p></div><div class=paragraph><p><strong>Device States _device_state_t</strong></p></div><div class="literalblock programlisting"><div class=content><pre>	  /*
	   * src/sys/sys/bus.h
	   */
	  typedef enum device_state {
		DS_NOTPRESENT,	/* not probed or probe failed */
		DS_ALIVE,		/* probe succeeded */
		DS_ATTACHED,	/* attach method called */
		DS_BUSY			/* device is open */
	  } device_state_t;</pre></div></div></div></div></div><div id=footnotes><hr><div class=footnote id=_footnotedef_1><a href=#_footnoteref_1>1</a>. <a href="https://man.freebsd.org/cgi/man.cgi?query=bus_generic_read_ivar&amp;sektion=9&amp;format=html">bus_generic_read_ivar(9)</a> and <a href="https://man.freebsd.org/cgi/man.cgi?query=bus_generic_write_ivar&amp;sektion=9&amp;format=html">bus_generic_write_ivar(9)</a></div></div></div><hr><div class=last-modified><p><strong>Last modified on</strong>: March 9, 2024 by <a href="https://cgit.freebsd.org/doc/commit/?id=6199af92e7" target=_blank>Danilo G. Baio</a></p></div><div class=buttons><div class=prev><i class="fa fa-angle-left" aria-hidden=true title=Prev></i><div class=container><a href=https://docs.freebsd.org/en/books/arch-handbook/usb class=direction>Prev</a></div></div><div class=home><i class="fa fa-home" aria-hidden=true title=Home></i><div class=container><a href=../ class=direction>Home</a></div></div><div class=next><div class=container><a href=https://docs.freebsd.org/en/books/arch-handbook/sound class=direction>Next</a></div><i class="fa fa-angle-right" aria-hidden=true title=Next></i></div></div><label class="hidden book-menu-overlay" for=menu-control></label></div><aside class=toc><div class=toc-content><h3>Table of Contents</h3><nav id=TableOfContents><ul><li><a href=#newbus-devdrivers>14.1. Device Drivers</a></li><li><a href=#newbus-overview>14.2. Overview of Newbus</a></li><li><a href=#newbus-api>14.3. Newbus API</a></li></ul></nav><hr><div class=resources><h3>Resources</h3><ul class=contents><li><i class="fa fa-file-pdf-o" aria-hidden=true title="Download PDF"></i><a href=https://download.freebsd.org/doc/en/books/arch-handbook/arch-handbook_en.pdf>Download PDF</a></li><li><i class="fa fa-pencil-square-o" aria-hidden=true title="Edit this page"></i><a href=https://github.com/freebsd/freebsd-doc/blob/main/documentation/content/en/_index target=_blank>Edit this page</a></li></ul></div></div></aside><a class=to-top href=#top><i class="fa fa-arrow-circle-up" aria-hidden=true></i></a></main><footer><div class=footer-container><section class=logo-column><img src=https://docs.freebsd.org/images/FreeBSD-colors.svg width=160 height=50 alt="FreeBSD logo"><div class=options-container><div class=language-container><a id=languages href=https://docs.freebsd.org/en/languages><img src=https://docs.freebsd.org/images/language.png class=language-image alt="Choose language">
<span>English</span></a></div><div class=theme-container><select id=theme-chooser><option value=theme-system>System</option><option value=theme-light>Light</option><option value=theme-dark>Dark</option><option value=theme-high-contrast>High contrast</option></select></div></div></section><section class=about-column><h3 class=column-title>About</h3><ul class=column-elements-container><li><a href=https://www.freebsd.org/about/ target=_blank class=column-element>FreeBSD</a></li><li><a href=https://freebsdfoundation.org/ target=_blank class=column-element>FreeBSD Foundation</a></li><li><a href=https://www.freebsd.org/where/ target=_blank class=column-element>Get FreeBSD</a></li><li><a href=https://www.freebsd.org/internal/code-of-conduct target=_blank class=column-element>Code of Conduct</a></li><li><a href=https://www.freebsd.org/security/ target=_blank class=column-element>Security Advisories</a></li></ul></section><section class=documentation-column><h3 class=column-title>Documentation</h3><ul class=column-elements-container><li><a href=/en class=column-element>Documentation portal</a></li><li><a href=https://man.FreeBSD.org target=_blank class=column-element>Manual pages</a></li><li><a href=https://papers.FreeBSD.org target=_blank class=column-element>Presentations and papers</a></li><li><a href=https://docs-archive.freebsd.org/doc/ target=_blank class=column-element>Previous versions</a></li><li><a href=https://docs-archive.freebsd.org/44doc/ target=_blank class=column-element>4.4BSD Documents</a></li><li><a href=https://wiki.freebsd.org/ target=_blank class=column-element>Wiki</a></li></ul></section><section class=community-column><h3 class=column-title>Community</h3><ul class=column-elements-container><li><a href=https://docs.freebsd.org/en/articles/contributing class=column-element>Get involved</a></li><li><a href=https://forums.freebsd.org/ target=_blank class=column-element>Community forum</a></li><li><a href=https://lists.freebsd.org/ target=_blank class=column-element>Mailing lists</a></li><li><a href=https://wiki.freebsd.org/IRC/Channels target=_blank class=column-element>IRC Channels</a></li><li><a href=https://bugs.freebsd.org/bugzilla/ target=_blank class=column-element>Bug Tracker</a></li></ul></section><section class=legal-column><h3 class=column-title>Legal</h3><ul class=column-elements-container><li><a href=https://freebsdfoundation.org/donate/ target=_blank class=column-element>Donations</a></li><li><a href=https://www.freebsd.org/copyright/freebsd-license/ target=_blank class=column-element>Licensing</a></li><li><a href=https://www.freebsd.org/privacy/ target=_blank class=column-element>Privacy Policy</a></li><li><a href=https://www.freebsd.org/copyright/ target=_blank class=column-element>Legal notices</a></li></ul></section><section class=copyright-column><p>&copy; 1994-2024 The FreeBSD Project. All rights reserved</p><span>Made with <span class=heart>♥</span> by the FreeBSD Community</span></section></div></footer></body></html>